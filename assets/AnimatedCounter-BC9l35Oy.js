import{j as e}from"./ui-vendor-DpWgbapL.js";import{r as t}from"./react-vendor-ylmX0jv_.js";import{H as V}from"./scanner-D4NToCeH.js";import{c as M,aa as H,w as q,x as U,A as F,E as Q,F as $,H as K,ab as X,B as E,I as _,b as D,S as G,X as J,ac as W,ad as P,z as S,ae as Y}from"./index-BNd3Wt9H.js";import{u as Z}from"./Calculator-B2SBkQDB.js";import{S as ee}from"./switch-CKIrtPYi.js";import{L as te}from"./label-WVvLSl95.js";import{A as R,m as z}from"./animation-D5s1b1Vs.js";import{T as se}from"./trash-2-8H7Y2FIj.js";import{I as ne}from"./input-FXlXofRV.js";import{L as re}from"./loader-circle-CU7KriGk.js";import{B as ae}from"./barcode-DnI2vdnX.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=M("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);function je({open:n,onOpenChange:l,onScan:u,onBatchScan:c}){const[x,d]=t.useState(!1),[f,m]=t.useState(null),[r,o]=t.useState(null),[h,v]=t.useState(!1),g=t.useRef(null),j="barcode-reader",{trigger:b}=Z(),[w,k]=t.useState(!1),[p,N]=t.useState([]);t.useEffect(()=>(n&&!g.current&&!h&&s(),()=>{i()}),[n,h]),t.useEffect(()=>{n&&(N([]),k(!1))},[n]);const C=async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(y=>y.stop()),!0}catch(a){return console.error("Error requesting camera permission:",a),a instanceof DOMException&&(a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?(v(!0),o("Permisos de cámara denegados. Por favor, habilita los permisos en la configuración de tu navegador.")):o("Error al acceder a la cámara. Intenta nuevamente.")),!1}},s=async()=>{try{if(o(null),!await C())return;const y=new V(j);g.current=y;const A={fps:15,qrbox:{width:280,height:280},aspectRatio:1,experimentalFeatures:{useBarCodeDetectorIfSupported:!0}};await y.start({facingMode:"environment"},A,L=>{T(L)},()=>{}),d(!0)}catch(a){console.error("Error starting scanner:",a),o("Error al iniciar la cámara."),H.error("Error al iniciar la cámara")}},i=async()=>{if(g.current)try{g.current.isScanning&&await g.current.stop(),g.current.clear()}catch(a){console.error("Error stopping scanner:",a)}finally{g.current=null,d(!1)}},T=a=>{w&&p.length>0&&p[p.length-1],b("success"),w?(N(y=>[a,...y]),m(a),setTimeout(()=>m(null),1e3)):(m(a),setTimeout(()=>{u(a),I()},800))},I=async()=>{await i(),m(null),o(null),v(!1),l(!1)},O=()=>{c&&c(p),I()},B=a=>{N(y=>y.filter((A,L)=>L!==a))};return e.jsx(q,{open:n,onOpenChange:I,children:e.jsxs(U,{className:"sm:max-w-[500px] max-h-[90vh] flex flex-col p-0 gap-0 overflow-hidden",children:[e.jsxs(F,{className:"p-4 pb-2",children:[e.jsxs(Q,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5 text-primary"}),"Escanear Código"]}),e.jsx($,{children:r?"Error de cámara":"Apunta al código de barras"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pt-0 space-y-4",children:[!r&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-black min-h-[250px] shrink-0",children:[e.jsx("div",{id:j,className:"w-full"}),e.jsx(R,{children:f&&e.jsx(z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-success/80 flex items-center justify-center z-10",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(K,{className:"w-12 h-12 mx-auto mb-2"}),e.jsx("p",{className:"font-mono font-bold",children:f})]})})})]}),e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(te,{htmlFor:"batch-mode",className:"cursor-pointer",children:"Modo Ráfaga"})]}),e.jsx(ee,{id:"batch-mode",checked:w,onCheckedChange:k})]}),w&&p.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Items Escaneados (",p.length,")"]}),e.jsx(E,{variant:"ghost",size:"sm",className:"h-6 text-xs text-destructive",onClick:()=>N([]),children:"Limpiar"})]}),e.jsx("div",{className:"max-h-[150px] overflow-y-auto space-y-1 border rounded-md p-2 bg-background",children:p.map((a,y)=>e.jsxs("div",{className:"flex items-center justify-between text-sm p-1 hover:bg-muted rounded",children:[e.jsx("span",{className:"font-mono",children:a}),e.jsx(E,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-destructive",onClick:()=>B(y),children:e.jsx(se,{className:"w-3 h-3"})})]},y))})]}),r&&e.jsxs("div",{className:"p-4 bg-destructive/10 text-destructive rounded-lg text-sm",children:[r,e.jsx(E,{onClick:()=>s(),variant:"outline",size:"sm",className:"mt-2 w-full",children:"Reintentar"})]})]}),e.jsxs(_,{className:"p-4 pt-2 border-t bg-muted/20 flex-row gap-2 sm:justify-end",children:[e.jsx(E,{variant:"outline",onClick:I,className:"flex-1 sm:flex-none",children:"Cancelar"}),w&&e.jsxs(E,{onClick:O,disabled:p.length===0,className:"flex-1 sm:flex-none",children:["Procesar (",p.length,")"]})]})]})})}function ie(n,l){const[u,c]=t.useState(n);return t.useEffect(()=>{const x=setTimeout(()=>c(n),l);return()=>{clearTimeout(x)}},[n,l]),u}function be({onSelect:n,autoFocus:l=!0,className:u}){const[c,x]=t.useState(""),[d,f]=t.useState([]),[m,r]=t.useState(!1),[o,h]=t.useState(!1),[v,g]=t.useState(0),j=ie(c,300),b=t.useRef(null),w=t.useRef(null);t.useEffect(()=>{l&&b.current&&b.current.focus()},[l]),t.useEffect(()=>{const s=i=>{w.current&&!w.current.contains(i.target)&&h(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),t.useEffect(()=>{(async()=>{if(j.length<2){f([]),h(!1);return}r(!0);try{const i=await W(j);f(i),h(i.length>0),g(0)}catch(i){console.error(i)}finally{r(!1)}})()},[j]);const k=s=>{s.key==="ArrowDown"?(s.preventDefault(),g(i=>(i+1)%d.length)):s.key==="ArrowUp"?(s.preventDefault(),g(i=>(i-1+d.length)%d.length)):s.key==="Enter"?(s.preventDefault(),o&&d.length>0?p(d[v]):c.trim()&&p({ean:c.trim(),name:""})):s.key==="Escape"&&h(!1)},p=s=>{n(s),x(""),h(!1)},N=()=>{var s;x(""),f([]),h(!1),(s=b.current)==null||s.focus()},C=t.useRef(null);return t.useEffect(()=>{if(o&&C.current){const s=C.current.children[v];s&&s.scrollIntoView({block:"nearest",behavior:"smooth"})}},[v,o]),e.jsxs("div",{className:D("relative w-full",u),ref:w,children:[e.jsxs("div",{className:"relative group",children:[e.jsx(G,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground group-focus-within:text-primary transition-colors"}),e.jsx(ne,{ref:b,id:"smart-search-input",value:c,onChange:s=>x(s.target.value),onKeyDown:k,placeholder:"Escanear EAN o buscar producto...",className:"pl-10 h-12 text-lg font-medium bg-card border-border/60 shadow-sm focus-visible:ring-primary/20 transition-all font-mono placeholder:font-sans",autoComplete:"off"}),e.jsxs("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2",children:[m&&e.jsx(re,{className:"w-4 h-4 animate-spin text-muted-foreground"}),c&&!m&&e.jsx(E,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:N,children:e.jsx(J,{className:"w-4 h-4"})})]})]}),e.jsx(R,{children:o&&d.length>0&&e.jsx(z.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute top-full left-0 right-0 z-[100] mt-1 bg-popover text-popover-foreground rounded-lg border shadow-xl overflow-hidden max-h-[300px] overflow-y-auto ring-1 ring-border/50",children:e.jsx("div",{className:"p-1.5 space-y-0.5",ref:C,children:d.map((s,i)=>e.jsxs("button",{onClick:()=>p(s),className:D("w-full text-left px-3 py-2.5 text-sm rounded-md flex items-center justify-between group transition-all duration-200 border border-transparent",i===v?"bg-primary/15 text-primary-foreground/90 border-primary/20 shadow-sm":"hover:bg-muted text-foreground"),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:D("font-medium truncate",i===v?"text-primary":""),children:s.name}),e.jsxs("div",{className:D("text-xs flex items-center gap-2",i===v?"text-primary/70":"text-muted-foreground"),children:[e.jsx(ae,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono opacity-80",children:s.ean})]})]}),i===v&&e.jsx("span",{className:"text-xs font-semibold bg-background/50 px-1.5 py-0.5 rounded text-primary shadow-sm border border-primary/10",children:"Enter"})]},s.ean))})})})]})}function Ne(){const[n,l]=t.useState(navigator.onLine),[u,c]=t.useState(!1),[x,d]=t.useState(0);t.useEffect(()=>{const r=()=>{l(!0),S.success("Conexión restaurada","Los datos se sincronizarán automáticamente"),m()},o=()=>{l(!1),S.warning("Sin conexión","Los datos se guardarán localmente")};return window.addEventListener("online",r),window.addEventListener("offline",o),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",o)}},[]);const f=t.useCallback(async()=>{try{const r=await P();d(r.length)}catch(r){console.error("Error counting unsynced items:",r)}},[]);t.useEffect(()=>{f();const r=setInterval(f,3e4);return()=>clearInterval(r)},[f]);const m=t.useCallback(async()=>{if(!n){S.error("Sin conexión","No hay conexión a internet");return}if(!u)try{c(!0);const r=await P();if(r.length===0){S.info("Sin datos pendientes","No hay datos pendientes de sincronización");return}console.log("Syncing items:",r),await new Promise(h=>setTimeout(h,1e3));const o=r.map(h=>h.id);await Y(o),await f(),S.success("Sincronización completada",`${r.length} productos sincronizados`)}catch(r){console.error("Error syncing data:",r),S.error("Error al sincronizar","Se reintentará automáticamente")}finally{c(!1)}},[n,u,f]);return t.useEffect(()=>{if(n&&x>0&&!u){const r=setTimeout(()=>{m()},2e3);return()=>clearTimeout(r)}},[n,x,u,m]),{isOnline:n,isSyncing:u,unsyncedCount:x,syncNow:m}}function Se({value:n,digits:l=4,className:u=""}){const[c,x]=t.useState(n),d=t.useRef(n);t.useEffect(()=>{n!==d.current&&(x(n),d.current=n)},[n]);const m=String(c).padStart(l,"0").split("");return e.jsx("div",{className:`inline-flex items-center ${u}`,children:m.map((r,o)=>e.jsx(ce,{digit:r,isZero:c===0||o<l-String(c).length},o))})}function ce({digit:n,isZero:l}){return e.jsx("div",{className:"relative inline-block overflow-hidden h-[1.2em] w-[0.6em]",style:{lineHeight:"1.2em"},children:e.jsx(R,{mode:"popLayout",children:e.jsx(z.span,{initial:{y:"100%",opacity:0},animate:{y:"0%",opacity:l?.2:1},exit:{y:"-100%",opacity:0},transition:{type:"spring",stiffness:300,damping:30,mass:.8},className:`absolute inset-0 flex items-center justify-center font-bold tabular-nums ${l?"opacity-20":""}`,children:n},n)})})}export{Se as A,je as B,be as S,Ne as u};
