import{j as e}from"./ui-vendor-DWmIoBIJ.js";import{r as t}from"./react-vendor-ylmX0jv_.js";import{H as M}from"./scanner-D4NToCeH.js";import{c as V,r as j,t as H,v as q,w as U,x as F,_ as Q,i as $,B as E,E as K,F as _,b as D,S as X,X as G,a0 as J,a1 as A,a2 as W}from"./index-DbwJGGea.js";import{u as Y}from"./Calculator-YAl5bDIn.js";import{S as Z}from"./switch-BVDdlim9.js";import{L as ee}from"./label-DGYK63qN.js";import{A as L,m as z}from"./animation-Ch0GoCcm.js";import{L as te}from"./jspdf.es.min-CqE5k0zD.js";import{I as se}from"./input-BacYCGan.js";import{L as ne}from"./loader-circle-wQrOqgPS.js";import{B as re}from"./barcode-C6sBs6zs.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=V("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);function we({open:s,onOpenChange:c,onScan:u,onBatchScan:o}){const[x,d]=t.useState(!1),[f,m]=t.useState(null),[n,l]=t.useState(null),[h,w]=t.useState(!1),g=t.useRef(null),b="barcode-reader",{trigger:N}=Y(),[v,C]=t.useState(!1),[p,S]=t.useState([]);t.useEffect(()=>(s&&!g.current&&!h&&i(),()=>{P()}),[s,h]),t.useEffect(()=>{s&&(S([]),C(!1))},[s]);const r=async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(y=>y.stop()),!0}catch(a){return console.error("Error requesting camera permission:",a),a instanceof DOMException&&(a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?(w(!0),l("Permisos de cámara denegados. Por favor, habilita los permisos en la configuración de tu navegador.")):l("Error al acceder a la cámara. Intenta nuevamente.")),!1}},i=async()=>{try{if(l(null),!await r())return;const y=new M(b);g.current=y;const R={fps:15,qrbox:{width:280,height:280},aspectRatio:1,experimentalFeatures:{useBarCodeDetectorIfSupported:!0}};await y.start({facingMode:"environment"},R,I=>{O(I)},()=>{}),d(!0)}catch(a){console.error("Error starting scanner:",a),l("Error al iniciar la cámara."),j.error("Error al iniciar la cámara")}},P=async()=>{if(g.current)try{g.current.isScanning&&await g.current.stop(),g.current.clear()}catch(a){console.error("Error stopping scanner:",a)}finally{g.current=null,d(!1)}},O=a=>{v&&p.length>0&&p[p.length-1],N("success"),v?(S(y=>[a,...y]),m(a),setTimeout(()=>m(null),1e3)):(m(a),setTimeout(()=>{u(a),k()},800))},k=async()=>{await P(),m(null),l(null),w(!1),c(!1)},T=()=>{o&&o(p),k()},B=a=>{S(y=>y.filter((R,I)=>I!==a))};return e.jsx(H,{open:s,onOpenChange:k,children:e.jsxs(q,{className:"sm:max-w-[500px] max-h-[90vh] flex flex-col p-0 gap-0 overflow-hidden",children:[e.jsxs(U,{className:"p-4 pb-2",children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-primary"}),"Escanear Código"]}),e.jsx(Q,{children:n?"Error de cámara":"Apunta al código de barras"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pt-0 space-y-4",children:[!n&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-black min-h-[250px] shrink-0",children:[e.jsx("div",{id:b,className:"w-full"}),e.jsx(L,{children:f&&e.jsx(z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-success/80 flex items-center justify-center z-10",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx($,{className:"w-12 h-12 mx-auto mb-2"}),e.jsx("p",{className:"font-mono font-bold",children:f})]})})})]}),e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ee,{htmlFor:"batch-mode",className:"cursor-pointer",children:"Modo Ráfaga"})]}),e.jsx(Z,{id:"batch-mode",checked:v,onCheckedChange:C})]}),v&&p.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Items Escaneados (",p.length,")"]}),e.jsx(E,{variant:"ghost",size:"sm",className:"h-6 text-xs text-destructive",onClick:()=>S([]),children:"Limpiar"})]}),e.jsx("div",{className:"max-h-[150px] overflow-y-auto space-y-1 border rounded-md p-2 bg-background",children:p.map((a,y)=>e.jsxs("div",{className:"flex items-center justify-between text-sm p-1 hover:bg-muted rounded",children:[e.jsx("span",{className:"font-mono",children:a}),e.jsx(E,{variant:"ghost",size:"icon",className:"h-6 w-6 text-muted-foreground hover:text-destructive",onClick:()=>B(y),children:e.jsx(K,{className:"w-3 h-3"})})]},y))})]}),n&&e.jsxs("div",{className:"p-4 bg-destructive/10 text-destructive rounded-lg text-sm",children:[n,e.jsx(E,{onClick:()=>i(),variant:"outline",size:"sm",className:"mt-2 w-full",children:"Reintentar"})]})]}),e.jsxs(_,{className:"p-4 pt-2 border-t bg-muted/20 flex-row gap-2 sm:justify-end",children:[e.jsx(E,{variant:"outline",onClick:k,className:"flex-1 sm:flex-none",children:"Cancelar"}),v&&e.jsxs(E,{onClick:T,disabled:p.length===0,className:"flex-1 sm:flex-none",children:["Procesar (",p.length,")"]})]})]})})}function ie(s,c){const[u,o]=t.useState(s);return t.useEffect(()=>{const x=setTimeout(()=>o(s),c);return()=>{clearTimeout(x)}},[s,c]),u}function je({onSelect:s,autoFocus:c=!0,className:u}){const[o,x]=t.useState(""),[d,f]=t.useState([]),[m,n]=t.useState(!1),[l,h]=t.useState(!1),[w,g]=t.useState(0),b=ie(o,300),N=t.useRef(null),v=t.useRef(null);t.useEffect(()=>{c&&N.current&&N.current.focus()},[c]),t.useEffect(()=>{const r=i=>{v.current&&!v.current.contains(i.target)&&h(!1)};return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[]),t.useEffect(()=>{(async()=>{if(b.length<2){f([]),h(!1);return}n(!0);try{const i=await J(b);f(i),h(i.length>0),g(0)}catch(i){console.error(i)}finally{n(!1)}})()},[b]);const C=r=>{r.key==="ArrowDown"?(r.preventDefault(),g(i=>(i+1)%d.length)):r.key==="ArrowUp"?(r.preventDefault(),g(i=>(i-1+d.length)%d.length)):r.key==="Enter"?(r.preventDefault(),l&&d.length>0?p(d[w]):o.trim()&&p({ean:o.trim(),name:""})):r.key==="Escape"&&h(!1)},p=r=>{s(r),x(""),h(!1)},S=()=>{var r;x(""),f([]),h(!1),(r=N.current)==null||r.focus()};return e.jsxs("div",{className:D("relative w-full",u),ref:v,children:[e.jsxs("div",{className:"relative group",children:[e.jsx(X,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground group-focus-within:text-primary transition-colors"}),e.jsx(se,{ref:N,id:"smart-search-input",value:o,onChange:r=>x(r.target.value),onKeyDown:C,placeholder:"Escanear EAN o buscar producto...",className:"pl-10 h-12 text-lg font-medium bg-card border-border/60 shadow-sm focus-visible:ring-primary/20 transition-all font-mono placeholder:font-sans",autoComplete:"off"}),e.jsxs("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2",children:[m&&e.jsx(ne,{className:"w-4 h-4 animate-spin text-muted-foreground"}),o&&!m&&e.jsx(E,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:S,children:e.jsx(G,{className:"w-4 h-4"})})]})]}),e.jsx(L,{children:l&&d.length>0&&e.jsx(z.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute top-full left-0 right-0 z-[100] mt-1 bg-popover text-popover-foreground rounded-lg border shadow-xl overflow-hidden max-h-[300px] overflow-y-auto ring-1 ring-border/50",children:e.jsx("div",{className:"p-1.5 space-y-0.5",children:d.map((r,i)=>e.jsxs("button",{onClick:()=>p(r),className:D("w-full text-left px-3 py-2.5 text-sm rounded-md flex items-center justify-between group transition-all duration-200 border border-transparent",i===w?"bg-primary/15 text-primary-foreground/90 border-primary/20 shadow-sm":"hover:bg-muted text-foreground"),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:D("font-medium truncate",i===w?"text-primary":""),children:r.name}),e.jsxs("div",{className:D("text-xs flex items-center gap-2",i===w?"text-primary/70":"text-muted-foreground"),children:[e.jsx(re,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono opacity-80",children:r.ean})]})]}),i===w&&e.jsx("span",{className:"text-xs font-semibold bg-background/50 px-1.5 py-0.5 rounded text-primary shadow-sm border border-primary/10",children:"Enter"})]},r.ean))})})})]})}function be(){const[s,c]=t.useState(navigator.onLine),[u,o]=t.useState(!1),[x,d]=t.useState(0);t.useEffect(()=>{const n=()=>{c(!0),j.success("Conexión restaurada",{description:"Los datos se sincronizarán automáticamente"}),m()},l=()=>{c(!1),j.warning("Sin conexión",{description:"Los datos se guardarán localmente"})};return window.addEventListener("online",n),window.addEventListener("offline",l),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",l)}},[]);const f=t.useCallback(async()=>{try{const n=await A();d(n.length)}catch(n){console.error("Error counting unsynced items:",n)}},[]);t.useEffect(()=>{f();const n=setInterval(f,3e4);return()=>clearInterval(n)},[f]);const m=t.useCallback(async()=>{if(!s){j.error("No hay conexión a internet");return}if(!u)try{o(!0);const n=await A();if(n.length===0){j.info("No hay datos pendientes de sincronización");return}console.log("Syncing items:",n),await new Promise(h=>setTimeout(h,1e3));const l=n.map(h=>h.id);await W(l),await f(),j.success("Sincronización completada",{description:`${n.length} productos sincronizados`})}catch(n){console.error("Error syncing data:",n),j.error("Error al sincronizar datos",{description:"Se reintentará automáticamente"})}finally{o(!1)}},[s,u,f]);return t.useEffect(()=>{if(s&&x>0&&!u){const n=setTimeout(()=>{m()},2e3);return()=>clearTimeout(n)}},[s,x,u,m]),{isOnline:s,isSyncing:u,unsyncedCount:x,syncNow:m}}function Ne({value:s,digits:c=4,className:u=""}){const[o,x]=t.useState(s),d=t.useRef(s);t.useEffect(()=>{s!==d.current&&(x(s),d.current=s)},[s]);const m=String(o).padStart(c,"0").split("");return e.jsx("div",{className:`inline-flex items-center ${u}`,children:m.map((n,l)=>e.jsx(oe,{digit:n,isZero:o===0||l<c-String(o).length},l))})}function oe({digit:s,isZero:c}){return e.jsx("div",{className:"relative inline-block overflow-hidden h-[1.2em] w-[0.6em]",style:{lineHeight:"1.2em"},children:e.jsx(L,{mode:"popLayout",children:e.jsx(z.span,{initial:{y:"100%",opacity:0},animate:{y:"0%",opacity:c?.2:1},exit:{y:"-100%",opacity:0},transition:{type:"spring",stiffness:300,damping:30,mass:.8},className:`absolute inset-0 flex items-center justify-center font-bold tabular-nums ${c?"text-white/20":"text-white"}`,children:s},s)})})}export{Ne as A,we as B,je as S,be as u};
