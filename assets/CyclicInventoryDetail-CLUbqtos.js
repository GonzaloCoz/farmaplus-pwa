import{j as e}from"./ui-vendor-BshHF3Zg.js";import{r as n,h as ge,u as je}from"./react-vendor-DdjUaGoS.js";import{P as J,Q as ve,r as q,C as S,p as w,B as d,D as ee,h as se,i as te,j as ae,t as ne,R as ye,u as f,N as be,U as Ne,S as we,o as Ce}from"./index-ByIwQOx7.js";import{I as T}from"./input-BB9T6pAr.js";import{T as Se,a as Ie,b as G,c as K}from"./tabs-Cp2WHH1b.js";import{r as De,u as Q,w as Ee}from"./excel-uoQkVabA.js";import{E as ke}from"./jspdf.es.min-BKAAPVxu.js";import{B as Fe}from"./badge-D5F2dDZQ.js";import{S as Ae,P as W}from"./SwipeableItem-RZLZAwuB.js";import{A as Pe,m as Qe}from"./animation-jqafwDaF.js";import{C as U}from"./circle-check-BotvtibV.js";import{D as Le}from"./dollar-sign-Crosz9is.js";import{C as L}from"./CounterAnimation-CLqfpDjG.js";import{S as Te}from"./switch-CimzETCz.js";import{L as Y}from"./label-vb4M4ftU.js";import{A as ze}from"./arrow-left-Cb1re84Y.js";import{F as _e,S as Oe}from"./save-Nv-4CZby.js";import{S as $e}from"./search-DYWPmiNU.js";import"./utils-CUsTgaRG.js";const Z=n.memo(function({items:x,onUpdateQuantity:u,onCheck:y,onRevert:r,readOnly:j=!1}){const[o,I]=n.useState(null),[b,D]=n.useState(""),v=t=>{I(t.id),D(t.countedQuantity.toString())},F=()=>{if(o){const t=parseInt(b,10);!isNaN(t)&&t>=0&&(u(o,t),I(null))}},A=()=>{I(null),D("")};return x.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(J,{className:"w-12 h-12 mx-auto mb-3 opacity-20"}),e.jsx("p",{children:"No hay productos en esta lista"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:e.jsx(Pe,{mode:"popLayout",children:x.map(t=>{const m=t.countedQuantity-t.systemQuantity,E=m!==0,C=t.status==="controlled",N=m===0;return e.jsx(Qe.div,{layout:!0,initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,x:-100},transition:{duration:.2},children:e.jsx(Ae,{disabled:j,...C?{leftAction:{label:"Editar",icon:e.jsx(W,{className:"w-5 h-5"}),color:"text-blue-500",bgColor:"rgba(59, 130, 246, 0.2)",onAction:()=>v(t)},rightAction:r?{label:"Revertir",icon:e.jsx(q,{className:"w-5 h-5"}),color:"text-red-500",bgColor:"rgba(239, 68, 68, 0.2)",onAction:()=>r(t.id)}:void 0}:{leftAction:{label:"Confirmar",icon:e.jsx(U,{className:"w-5 h-5"}),color:"text-green-600",bgColor:"rgba(22, 163, 74, 0.2)",onAction:()=>y(t.id)},rightAction:{label:"Diferencia",icon:e.jsx(ve,{className:"w-5 h-5"}),color:"text-orange-500",bgColor:"rgba(249, 115, 22, 0.2)",onAction:()=>v(t)}},children:e.jsx(S,{className:w("p-4 hover:shadow-md transition-shadow border-0 rounded-none sm:rounded-xl sm:border"),onClick:()=>v(t),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:w("p-2 rounded-lg flex-shrink-0 transition-colors",C?"bg-success/10":"bg-primary/10"),children:C?e.jsx(U,{className:"w-5 h-5 text-success"}):e.jsx(J,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground truncate",title:t.name,children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-mono bg-muted px-1.5 py-0.5 rounded",children:t.ean}),t.cost>0&&e.jsxs("span",{className:"flex items-center text-muted-foreground",children:[e.jsx(Le,{className:"w-3 h-3 mr-0.5"}),t.cost.toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Sistema"}),e.jsx("span",{className:"text-sm font-medium",children:t.systemQuantity})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Físico"}),e.jsx("span",{className:w("text-sm font-bold",E?"text-warning":"text-success"),children:t.countedQuantity})]}),E&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Diferencia"}),e.jsx(Fe,{variant:m>0?"default":"destructive",className:"h-5 px-1.5 text-[10px]",children:m>0?`+${m}`:m})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-primary",onClick:p=>{p.stopPropagation(),v(t)},children:e.jsx(W,{className:"w-4 h-4"})}),t.status==="pending"&&e.jsx(d,{size:"icon",variant:N?"default":"secondary",className:w("h-10 w-10 rounded-full shadow-sm flex-shrink-0 transition-all ml-1",N?"bg-success hover:bg-success/90 text-white":"hover:bg-warning/20 text-warning"),onClick:p=>{p.stopPropagation(),y(t.id)},children:e.jsx(U,{className:"w-5 h-5"})}),t.status==="controlled"&&r&&e.jsx(d,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive hover:bg-destructive/10",onClick:p=>{p.stopPropagation(),r(t.id)},title:"Volver a pendientes",children:e.jsx(q,{className:"w-4 h-4"})})]})]})})})},t.id)})})}),e.jsx(ee,{open:o!==null,onOpenChange:t=>!t&&A(),children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:"Editar Cantidad"})}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Cantidad Física"}),e.jsx(T,{type:"number",min:"0",value:b,onChange:t=>D(t.target.value),onKeyDown:t=>{t.key==="Enter"&&F()},placeholder:"Ingresa la cantidad",autoFocus:!0})]})}),e.jsxs(ne,{children:[e.jsx(d,{variant:"outline",onClick:A,children:"Cancelar"}),e.jsx(d,{onClick:F,children:"Guardar"})]})]})})]})}),Ue=ye("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),re=n.forwardRef(({className:h,variant:x,...u},y)=>e.jsx("div",{ref:y,role:"alert",className:w(Ue({variant:x}),h),...u}));re.displayName="Alert";const oe=n.forwardRef(({className:h,...x},u)=>e.jsx("h5",{ref:u,className:w("mb-1 font-medium leading-none tracking-tight",h),...x}));oe.displayName="AlertTitle";const le=n.forwardRef(({className:h,...x},u)=>e.jsx("div",{ref:u,className:w("text-sm [&_p]:leading-relaxed",h),...x}));le.displayName="AlertDescription";function os(){const{id:h}=ge(),x=je(),[u,y]=n.useState(!1),[r,j]=n.useState([]),[o,I]=n.useState(""),[b,D]=n.useState(""),[v,F]=n.useState(!1),[A,t]=n.useState(!1),[m,E]=n.useState("");n.useEffect(()=>{h&&I(decodeURIComponent(h))},[h]),n.useEffect(()=>{if(o){const s=localStorage.getItem(`cyclic_inventory_${o}`);if(s)try{j(JSON.parse(s))}catch(a){console.error("Failed to load saved inventory",a)}}},[o]),n.useEffect(()=>{o&&r.length>0&&localStorage.setItem(`cyclic_inventory_${o}`,JSON.stringify(r))},[r,o]);const C=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().trim(),N=n.useMemo(()=>r.filter(s=>{if(b){const a=b.toLowerCase();if(!s.name.toLowerCase().includes(a)&&!s.ean.includes(a))return!1}return v?s.countedQuantity!==s.systemQuantity:!0}),[r,b,v]),p=n.useMemo(()=>N.filter(s=>s.status==="pending"),[N]),z=n.useMemo(()=>N.filter(s=>s.status==="controlled"),[N]),ie=async s=>{var i;const a=(i=s.target.files)==null?void 0:i[0];if(!a)return;y(!0);const l=new FileReader;l.onload=g=>{var k;try{const _=(k=g.target)==null?void 0:k.result,M=De(_,{type:"binary"}),me=M.SheetNames[0],he=M.Sheets[me],V=Q.sheet_to_json(he,{header:1}),P=[];let X=!1,H="";for(let O=1;O<V.length;O++){const c=V[O];if(!c||c.length===0)continue;const $=c[14];if(c[3]){if($&&o){const fe=C($.toString()),pe=C(o);if(fe!==pe){X=!0,H=$.toString();break}}P.push({id:crypto.randomUUID(),ean:c[2]?c[2].toString():"S/C",name:c[3]?c[3].toString():"Desconocido",systemQuantity:c[4]?parseInt(c[4]):0,countedQuantity:c[4]?parseInt(c[4]):0,cost:c[12]?parseFloat(c[12]):0,status:"pending"})}}X?(f.error(`Error: El archivo contiene productos de otro laboratorio (${H}).`),j([])):P.length===0?f.error("No se encontraron productos válidos en el archivo."):(j(P),f.success(`Se cargaron ${P.length} productos correctamente.`))}catch(_){console.error("Error reading file:",_),f.error("Error al procesar el archivo Excel.")}finally{y(!1),s.target.value=""}},l.readAsBinaryString(a)},R=n.useCallback((s,a)=>{j(l=>l.map(i=>i.id===s?(a-i.systemQuantity!==0&&navigator.vibrate?navigator.vibrate([50,50,50]):navigator.vibrate&&navigator.vibrate(50),{...i,countedQuantity:a,status:"controlled"}):i))},[]),B=n.useCallback(s=>{navigator.vibrate&&navigator.vibrate(50),j(a=>a.map(l=>l.id===s?{...l,status:"controlled",countedQuantity:l.systemQuantity}:l)),f.success("Producto controlado")},[]),ce=n.useCallback(s=>{j(a=>a.map(l=>l.id===s?{...l,status:"pending"}:l)),f.info("Producto devuelto a pendientes")},[]),de=()=>{if(!m.trim()){f.error("Debes ingresar el ID de ajuste de PLEX");return}const s={status:"controlado",lastUpdated:Date.now(),plexId:m};localStorage.setItem(`cyclic_inventory_status_${o}`,JSON.stringify(s)),f.success(`Inventario guardado con ID PLEX: ${m}`),t(!1),E(""),x("/cyclic-inventory")},xe=()=>{const s=new ke;s.setFontSize(16),s.text(`Inventario Cíclico: ${o}`,10,10),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,18);let a=30;const l=10,i=s.internal.pageSize.height;s.setFont("helvetica","bold"),s.text("Producto",10,a),s.text("Sistema",100,a),s.text("Físico",130,a),s.text("Dif",160,a),s.text("Estado",180,a),a+=l,s.setFont("helvetica","normal"),r.forEach(g=>{a>i-20&&(s.addPage(),a=20);const k=g.countedQuantity-g.systemQuantity;s.text(g.name.substring(0,40),10,a),s.text(g.systemQuantity.toString(),100,a),s.text(g.countedQuantity.toString(),130,a),s.setTextColor(k===0?0:255,0,0),s.text(k.toString(),160,a),s.setTextColor(0),s.text(g.status==="controlled"?"OK":"Pend",180,a),a+=l}),s.save(`Inventario_${o}_${new Date().toISOString().split("T")[0]}.pdf`),f.success("Reporte PDF generado")},ue=()=>{const s=r.map(i=>({EAN:i.ean,Producto:i.name,Laboratorio:o,"Cantidad Sistema":i.systemQuantity,"Cantidad Física":i.countedQuantity,Diferencia:i.countedQuantity-i.systemQuantity,Costo:i.cost,Estado:i.status==="controlled"?"CONTROLADO":"PENDIENTE"})),a=Q.json_to_sheet(s),l=Q.book_new();Q.book_append_sheet(l,a,"Inventario"),Ee(l,`Inventario_${o}.xlsx`),f.success("Excel generado")};return e.jsxs("div",{className:"p-4 md:p-6 space-y-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>x("/cyclic-inventory"),children:e.jsx(ze,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:o}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Control de Inventario Cíclico"})]})]}),e.jsx("div",{className:"flex gap-2",children:r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:ue,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Excel"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:xe,children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"PDF"]}),e.jsxs(d,{variant:"default",size:"sm",onClick:()=>t(!0),children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"}),"Finalizar"]})]})})]}),r.length===0?e.jsxs(S,{className:"p-12 border-dashed border-2 flex flex-col items-center justify-center text-center space-y-4 bg-muted/20",children:[e.jsx("div",{className:"p-4 bg-primary/10 rounded-full",children:e.jsx(Ne,{className:"w-8 h-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Cargar Archivo de Inventario"}),e.jsxs("p",{className:"text-muted-foreground max-w-md mx-auto mt-2",children:["Sube el archivo Excel (.xlsx) descargado del sistema para comenzar el control de ",o,"."]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(d,{disabled:u,children:u?"Procesando...":"Seleccionar Archivo"}),e.jsx(T,{type:"file",accept:".xlsx, .xls",className:"absolute inset-0 opacity-0 cursor-pointer",onChange:ie,disabled:u})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-4",children:"Columnas requeridas: C (EAN), D (Producto), E (Cantidad), O (Laboratorio)"})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs(S,{className:"p-4 flex flex-col items-center justify-center bg-primary/5 border-primary/20",children:[e.jsx("span",{className:"text-muted-foreground text-xs uppercase font-bold",children:"Total Items"}),e.jsx("span",{className:"text-2xl font-bold",children:e.jsx(L,{value:r.length})})]}),e.jsxs(S,{className:"p-4 flex flex-col items-center justify-center bg-warning/5 border-warning/20",children:[e.jsx("span",{className:"text-muted-foreground text-xs uppercase font-bold",children:"Pendientes"}),e.jsx("span",{className:"text-2xl font-bold text-warning",children:e.jsx(L,{value:r.filter(s=>s.status==="pending").length})})]}),e.jsxs(S,{className:"p-4 flex flex-col items-center justify-center bg-success/5 border-success/20",children:[e.jsx("span",{className:"text-muted-foreground text-xs uppercase font-bold",children:"Controlados"}),e.jsx("span",{className:"text-2xl font-bold text-success",children:e.jsx(L,{value:r.filter(s=>s.status==="controlled").length})})]}),e.jsxs(S,{className:"p-4 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"text-muted-foreground text-xs uppercase font-bold",children:"Avance"}),e.jsxs("span",{className:"text-2xl font-bold",children:[e.jsx(L,{value:Math.round(r.filter(s=>s.status==="controlled").length/r.length*100)}),"%"]})]})]}),e.jsxs("div",{className:"lg:col-span-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($e,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(T,{placeholder:"Buscar por nombre o EAN...",value:b,onChange:s=>D(s.target.value),className:"pl-9"})]}),e.jsxs("div",{className:"flex items-center space-x-2 bg-card p-2 rounded-lg border",children:[e.jsx(Te,{id:"diff-mode",checked:v,onCheckedChange:F}),e.jsx(Y,{htmlFor:"diff-mode",className:"cursor-pointer",children:"Solo Diferencias"})]})]}),e.jsxs(Se,{defaultValue:"pending",className:"w-full",children:[e.jsxs(Ie,{className:"grid w-full grid-cols-2 mb-4",children:[e.jsxs(G,{value:"pending",className:"relative",children:["Pendientes",p.length>0&&e.jsx("span",{className:"ml-2 bg-warning text-warning-foreground text-[10px] px-1.5 py-0.5 rounded-full",children:p.length})]}),e.jsxs(G,{value:"controlled",children:["Controlados",z.length>0&&e.jsx("span",{className:"ml-2 bg-success text-success-foreground text-[10px] px-1.5 py-0.5 rounded-full",children:z.length})]})]}),e.jsxs(K,{value:"pending",className:"space-y-4",children:[e.jsxs(re,{className:"bg-muted/50 border-none mb-4",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(oe,{children:"Instrucciones"}),e.jsx(le,{children:"Desliza a la derecha para confirmar (verde) o a la izquierda para reportar diferencia (naranja)."})]}),e.jsx(Z,{items:p,onUpdateQuantity:R,onCheck:B})]}),e.jsx(K,{value:"controlled",className:"space-y-4",children:e.jsx(Z,{items:z,onUpdateQuantity:R,onCheck:B,onRevert:ce,readOnly:!1})})]})]})]}),e.jsx(ee,{open:A,onOpenChange:t,children:e.jsxs(se,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Finalizar Inventario"}),e.jsx(Ce,{children:"Ingresa el ID del ajuste generado en PLEX para guardar el estado de este inventario."})]}),e.jsxs("div",{className:"py-4",children:[e.jsx(Y,{htmlFor:"plexId",className:"mb-2 block",children:"ID Ajuste PLEX"}),e.jsx(T,{id:"plexId",value:m,onChange:s=>E(s.target.value),placeholder:"Ej: 123456"})]}),e.jsxs(ne,{children:[e.jsx(d,{variant:"outline",onClick:()=>t(!1),children:"Cancelar"}),e.jsx(d,{onClick:de,children:"Guardar y Finalizar"})]})]})})]})}export{os as default};
