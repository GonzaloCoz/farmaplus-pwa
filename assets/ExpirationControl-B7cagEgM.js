import{j as e}from"./ui-vendor-DWmIoBIJ.js";import{r as m,u as re}from"./react-vendor-ylmX0jv_.js";import{_ as ie,u as oe,v as l,B as y,g as B,P as ce,y as $,n as le,Q as de,q as me,r as xe,s as ue,t as he,Z as pe,z as fe,V as ge}from"./index-CPz0rxuc.js";import{I as F}from"./input-C_a6pyjI.js";import{B as Ne}from"./badge--0MDKttn.js";import{A as je,C as ye,B as be}from"./BarcodeScanner-7BJKaUOT.js";import{P as we}from"./ProductSearchInput-H1bfCLDz.js";import{C as q}from"./CounterAnimation-BByUy0p8.js";import{F as ve}from"./FabMenu-zXbaKCq-.js";import{E as Se}from"./jspdf.es.min-o8YbjmK3.js";import{A as Ee,m as O}from"./animation-Ch0GoCcm.js";import{C as Ce}from"./clock-CSVIsxUf.js";import{P as L}from"./plus-DPOsrdt7.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";import"./scanner-D4NToCeH.js";import"./switch-C9vn1c2r.js";import"./label-CyvB7xXk.js";let V;async function E(){return V=ie("farmaplus-expiration",2,{upgrade(t,n,i,r){if(n<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const u=t.createObjectStore("items",{keyPath:"id"});u.createIndex("by-session","sessionId"),u.createIndex("by-ean","ean")}if(n<2){const c=r.objectStore("sessions");c.indexNames.contains("by-branch")||c.createIndex("by-branch","branchName")}}}),V}async function Ie(t,n){const i=await E(),r={id:crypto.randomUUID(),sector:t,branchName:n,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await i.put("sessions",r),r}async function M(t){return(await(await E()).getAllFromIndex("sessions","by-status","active")).find(c=>c.branchName===t)||null}async function Pe(t,n){const i=await E(),r=await i.get("sessions",t);r&&await i.put("sessions",{...r,...n})}async function Be(t){await Pe(t,{status:"completed",endTime:Date.now()})}async function ke(t,n){const i=await E(),r=await M(n);if(!r)throw new Error("No active expiration session");if((await i.getAllFromIndex("items","by-session",r.id)).find(b=>b.ean===t.ean))throw new Error("Item already exists in session. Use update.");const x={id:crypto.randomUUID(),sessionId:r.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((b,w)=>b+w.quantity,0),timestamp:Date.now(),synced:0};return await i.put("items",x),await Q(r.id),x}async function De(t,n){const i=await E(),r=await i.get("items",t);if(r){const c={...r,...n};n.batches&&(c.totalQuantity=n.batches.reduce((u,x)=>u+x.quantity,0)),await i.put("items",c),await Q(r.sessionId)}}async function Ae(t){const n=await E(),i=await n.get("items",t);i&&(await n.delete("items",t),await Q(i.sessionId))}async function G(t){return(await E()).getAllFromIndex("items","by-session",t)}async function Q(t){const n=await G(t),i=await E(),r=n.length,c=n.reduce((x,b)=>x+b.totalQuantity,0),u=await i.get("sessions",t);u&&await i.put("sessions",{...u,totalProducts:r,totalUnits:c})}function Fe(){const{user:t}=oe(),[n,i]=m.useState(null),[r,c]=m.useState([]),[u,x]=m.useState(0),[b,w]=m.useState(0),[N,I]=m.useState(!0);m.useEffect(()=>{t!=null&&t.branchName?z(t.branchName):(i(null),c([]))},[t==null?void 0:t.branchName]);const z=async d=>{try{I(!0);const o=await M(d);i(o),o?await v(o.id):(c([]),x(0),w(0))}catch(o){console.error("Error loading expiration session:",o),l.error("Error al cargar la sesión")}finally{I(!1)}},v=async d=>{const o=await G(d);o.sort((h,p)=>p.timestamp-h.timestamp),c(o),x(o.length),w(o.reduce((h,p)=>h+p.totalQuantity,0))};return{session:n,items:r,totalProducts:u,totalUnits:b,isLoading:N,startSession:async d=>{try{if(!(t!=null&&t.branchName)){l.error("No hay sucursal seleccionada");return}if(n){l.error("Ya existe una sesión activa");return}const o=await Ie(d,t.branchName);i(o),c([])}catch(o){console.error("Error starting session:",o),l.error("Error al iniciar sesión")}},addItem:async(d,o,h)=>{try{const p=r.find(f=>f.ean===d);if(p)await De(p.id,{batches:h,timestamp:Date.now()}),l.success("Producto actualizado");else{if(!(t!=null&&t.branchName))throw new Error("No branch selected");await ke({ean:d,productName:o,batches:h,totalQuantity:h.reduce((f,S)=>f+S.quantity,0)},t.branchName),l.success("Producto agregado")}n&&await v(n.id)}catch(p){console.error("Error adding/updating item:",p),l.error("Error al guardar producto")}},deleteItem:async d=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await Ae(d),l.success("Producto eliminado"),n&&await v(n.id)}catch(o){console.error("Error deleting item:",o),l.error("Error al eliminar")}},finishSession:async()=>{if(n&&confirm("¿Finalizar control de vencimientos?"))try{await Be(n.id),i(null),c([]),l.success("Control finalizado correctamente")}catch(d){console.error("Error finishing session:",d),l.error("Error al finalizar")}}}}function We(){const t=re(),[n,i]=m.useState("config"),[r,c]=m.useState(""),[u,x]=m.useState(!1),[b,w]=m.useState(""),[N,I]=m.useState(null),[z,v]=m.useState(!1),[j,C]=m.useState([]),[k,D]=m.useState(""),[d,o]=m.useState(""),[h,p]=m.useState(""),{session:f,items:S,totalProducts:R,totalUnits:_,startSession:H,addItem:Y,deleteItem:Z,finishSession:J}=Fe(),K=async()=>{if(!r.trim()){l.error("Ingresa el nombre del sector");return}await H(r.trim()),i("counting")},W=async s=>{await U(s),x(!1)},X=async s=>{await U(s.ean,s.name)},U=async(s,a)=>{w(s);let g=a;if(!g){const A=await ge(s);g=A?A.name:`Producto ${s}`}I({name:g,ean:s});const P=S.find(A=>A.ean===s);P?(C([...P.batches]),l.info("Producto ya contado. Editando lotes existentes.")):C([]),v(!0)},ee=()=>{if(!k.trim())return l.error("Falta número de lote");if(!d.trim())return l.error("Falta fecha de vencimiento");if(!h||Number(h)<=0)return l.error("Cantidad inválida");const s={batchNumber:k.toUpperCase(),expirationDate:d,quantity:Number(h)};C([...j,s]),D(""),p(""),o("")},se=s=>{const a=[...j];a.splice(s,1),C(a)},te=async()=>{if(N){if(j.length===0){l.warning("Debes agregar al menos un lote");return}await Y(N.ean,N.name,j),v(!1),I(null),w(""),C([]),D(""),o(""),p("")}},ae=async()=>{await J(),t("/stock")},T=s=>{if(!s)return"";if(s.match(/^\d{4}-\d{2}$/)){const[a,g]=s.split("-");return`${g}/${a.slice(2)}`}return s},ne=()=>{if(S.length===0)return l.error("No hay datos");const s=new Se;let a=20;s.setFontSize(16),s.text(`Control de Vencimientos: ${f==null?void 0:f.sector}`,10,a),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,a+6),a+=15,S.forEach(g=>{a>270&&(s.addPage(),a=20),s.setFont("helvetica","bold"),s.text(`${g.productName} (EAN: ${g.ean})`,10,a),s.text(`Total: ${g.totalQuantity}`,180,a,{align:"right"}),a+=6,s.setFont("helvetica","normal"),s.setFontSize(9),s.text("Lote",15,a),s.text("Vencimiento",80,a),s.text("Cantidad",150,a),a+=5,g.batches.forEach(P=>{s.text(P.batchNumber,15,a),s.text(T(P.expirationDate),80,a),s.text(P.quantity.toString(),150,a),a+=5}),a+=5}),s.save(`Vencimientos_${f==null?void 0:f.sector}.pdf`),l.success("PDF Generado")};return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>t("/stock"),children:e.jsx(je,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Control de Vencimientos"}),f&&e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Sector: ",f.sector]})]})]}),e.jsx(Ee,{mode:"wait",children:n==="config"?e.jsx(O.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(B,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Configurar Sesión"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nombre del Sector"}),e.jsx(F,{value:r,onChange:s=>c(s.target.value),placeholder:"Ej: Estantería A1",autoFocus:!0})]}),e.jsx(y,{onClick:K,className:"w-full",size:"lg",children:"Comenzar Control"})]})]})}):e.jsxs(O.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(B,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-3xl font-bold text-primary",children:e.jsx(q,{value:R})})]})}),e.jsx(B,{className:"p-4 bg-secondary/5 border-secondary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Unidades Totales"}),e.jsx("div",{className:"text-3xl font-bold text-foreground",children:e.jsx(q,{value:_})})]})})]}),e.jsx(B,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(y,{size:"lg",className:"w-full",onClick:()=>x(!0),children:[e.jsx(ye,{className:"mr-2 h-5 w-5"}),"Escanear Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O buscar manualmente"})})]}),e.jsx(we,{onSelect:X,placeholder:"Buscar por nombre o EAN..."})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:["Registros (",S.length,")"]}),S.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground bg-muted/20 rounded-lg border-dashed border-2",children:[e.jsx(ce,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"No hay productos registrados aún"})]}):S.map(s=>e.jsxs(B,{className:"p-4 group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-base",children:s.productName}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["EAN: ",s.ean]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.batches.map((a,g)=>e.jsxs(Ne,{variant:"secondary",className:"text-xs font-normal",children:[e.jsx(Ce,{className:"w-3 h-3 mr-1 opacity-50"}),T(a.expirationDate),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),"Lote: ",a.batchNumber,e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsxs("strong",{children:["x",a.quantity]})]},g))})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalQuantity}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total"})]})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/80 backdrop-blur rounded-lg p-1",children:[e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-blue-500",onClick:()=>U(s.ean,s.productName),children:e.jsx(L,{className:"w-4 h-4"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-destructive",onClick:()=>Z(s.id),children:e.jsx($,{className:"w-4 h-4"})})]})]},s.id))]}),e.jsx(ve,{actions:[{label:"Finalizar",icon:e.jsx(le,{className:"w-5 h-5"}),onClick:ae,variant:"default",color:"bg-primary text-primary-foreground"},{label:"Exportar PDF",icon:e.jsx(de,{className:"w-5 h-5"}),onClick:ne,variant:"secondary"}]})]})}),e.jsx(me,{open:z,onOpenChange:s=>{s||(v(!1),w(""),I(null),C([]))},children:e.jsxs(xe,{className:"sm:max-w-md",children:[e.jsxs(ue,{children:[e.jsx(he,{children:"Gestión de Vencimientos"}),e.jsxs(pe,{children:[N==null?void 0:N.name," ",e.jsx("br",{}),e.jsxs("span",{className:"text-xs",children:["EAN: ",N==null?void 0:N.ean]})]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg space-y-3 border",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Nro. Lote"}),e.jsx(F,{value:k,onChange:s=>D(s.target.value.toUpperCase()),placeholder:"Ej: A123"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Vencimiento"}),e.jsx(F,{type:"text",value:d,onChange:s=>{let a=s.target.value.replace(/\D/g,"");a.length>=2&&(a=a.slice(0,2)+"/"+a.slice(2,4)),a.length>5&&(a=a.slice(0,5)),o(a)},placeholder:"MM/AA",maxLength:5})]})]}),e.jsxs("div",{className:"flex gap-3 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Cantidad"}),e.jsx(F,{type:"number",value:h,onChange:s=>p(s.target.value),placeholder:"0"})]}),e.jsxs(y,{onClick:ee,size:"default",variant:"secondary",children:[e.jsx(L,{className:"w-4 h-4 lg:mr-2"}),e.jsx("span",{className:"hidden lg:inline",children:"Agregar"})]})]})]}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto space-y-2",children:j.length===0?e.jsx("p",{className:"text-sm text-center text-muted-foreground py-4",children:"No hay lotes cargados para este producto."}):j.map((s,a)=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-card border rounded shadow-sm",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-mono font-bold bg-muted px-1 rounded",children:s.batchNumber}),e.jsx("span",{className:"mx-2 text-muted-foreground",children:"•"}),e.jsx("span",{children:T(s.expirationDate)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"font-bold",children:["x",s.quantity]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive hover:bg-destructive/10",onClick:()=>se(a),children:e.jsx($,{className:"w-3 h-3"})})]})]},a))})]}),e.jsxs(fe,{className:"flex-col sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm text-muted-foreground self-center",children:["Total Unidades: ",j.reduce((s,a)=>s+a.quantity,0)]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(y,{variant:"outline",className:"flex-1 sm:flex-none",onClick:()=>v(!1),children:"Cancelar"}),e.jsx(y,{className:"flex-1 sm:flex-none",onClick:te,disabled:j.length===0,children:"Guardar Todo"})]})]})]})}),e.jsx(be,{open:u,onOpenChange:x,onScan:W})]})}export{We as default};
