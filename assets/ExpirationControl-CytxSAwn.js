import{j as e}from"./ui-vendor-DWmIoBIJ.js";import{r as m,u as ge}from"./react-vendor-ylmX0jv_.js";import{_ as je,u as Ne,v as l,B as N,g as k,P as be,y as R,n as ye,Q as ve,q as G,r as H,s as J,t as _,Z as Y,z as Z,V as we}from"./index-BvZJ3bZe.js";import{I as B}from"./input-CX61wCs9.js";import{L as q}from"./label-BkkoOBrK.js";import{B as Se}from"./badge-DQacyKUF.js";import{C as Ce,B as Ee}from"./BarcodeScanner-DBdG9hAB.js";import{P as Ie}from"./ProductSearchInput-DSa_ujzP.js";import{C as K}from"./CounterAnimation-BByUy0p8.js";import{F as Fe}from"./FabMenu-BOvHu195.js";import{A as Pe,E as De}from"./jspdf.es.min-J2Fjo0r8.js";import{A as ke,m as W}from"./animation-Ch0GoCcm.js";import{C as Be}from"./clock-C7wOtK1a.js";import{P as X}from"./plus-BfWwHXmu.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";import"./scanner-D4NToCeH.js";import"./switch-T81gwERe.js";let ee;async function C(){return ee=je("farmaplus-expiration",2,{upgrade(t,n,i,r){if(n<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const h=t.createObjectStore("items",{keyPath:"id"});h.createIndex("by-session","sessionId"),h.createIndex("by-ean","ean")}if(n<2){const d=r.objectStore("sessions");d.indexNames.contains("by-branch")||d.createIndex("by-branch","branchName")}}}),ee}async function Ae(t,n){const i=await C(),r={id:crypto.randomUUID(),sector:t,branchName:n,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await i.put("sessions",r),r}async function se(t){return(await(await C()).getAllFromIndex("sessions","by-status","active")).find(d=>d.branchName===t)||null}async function ze(t,n){const i=await C(),r=await i.get("sessions",t);r&&await i.put("sessions",{...r,...n})}async function Ue(t){await ze(t,{status:"completed",endTime:Date.now()})}async function Oe(t,n){const i=await C(),r=await se(n);if(!r)throw new Error("No active expiration session");if((await i.getAllFromIndex("items","by-session",r.id)).find(v=>v.ean===t.ean))throw new Error("Item already exists in session. Use update.");const u={id:crypto.randomUUID(),sessionId:r.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((v,w)=>v+w.quantity,0),timestamp:Date.now(),synced:0};return await i.put("items",u),await M(r.id),u}async function Te(t,n){const i=await C(),r=await i.get("items",t);if(r){const d={...r,...n};n.batches&&(d.totalQuantity=n.batches.reduce((h,u)=>h+u.quantity,0)),await i.put("items",d),await M(r.sessionId)}}async function Le(t){const n=await C(),i=await n.get("items",t);i&&(await n.delete("items",t),await M(i.sessionId))}async function te(t){return(await C()).getAllFromIndex("items","by-session",t)}async function M(t){const n=await te(t),i=await C(),r=n.length,d=n.reduce((u,v)=>u+v.totalQuantity,0),h=await i.get("sessions",t);h&&await i.put("sessions",{...h,totalProducts:r,totalUnits:d})}function Qe(){const{user:t}=Ne(),[n,i]=m.useState(null),[r,d]=m.useState([]),[h,u]=m.useState(0),[v,w]=m.useState(0),[g,F]=m.useState(!0);m.useEffect(()=>{t!=null&&t.branchName?O(t.branchName):(i(null),d([]))},[t==null?void 0:t.branchName]);const O=async x=>{try{F(!0);const c=await se(x);i(c),c?await S(c.id):(d([]),u(0),w(0))}catch(c){console.error("Error loading expiration session:",c),l.error("Error al cargar la sesión")}finally{F(!1)}},S=async x=>{const c=await te(x);c.sort((p,f)=>f.timestamp-p.timestamp),d(c),u(c.length),w(c.reduce((p,f)=>p+f.totalQuantity,0))};return{session:n,items:r,totalProducts:h,totalUnits:v,isLoading:g,startSession:async x=>{try{if(!(t!=null&&t.branchName)){l.error("No hay sucursal seleccionada");return}if(n){l.error("Ya existe una sesión activa");return}const c=await Ae(x,t.branchName);i(c),d([])}catch(c){console.error("Error starting session:",c),l.error("Error al iniciar sesión")}},addItem:async(x,c,p)=>{try{const f=r.find(P=>P.ean===x);if(f)await Te(f.id,{batches:p,timestamp:Date.now()}),l.success("Producto actualizado");else{if(!(t!=null&&t.branchName))throw new Error("No branch selected");await Oe({ean:x,productName:c,batches:p,totalQuantity:p.reduce((P,D)=>P+D.quantity,0)},t.branchName),l.success("Producto agregado")}n&&await S(n.id)}catch(f){console.error("Error adding/updating item:",f),l.error("Error al guardar producto")}},deleteItem:async x=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await Le(x),l.success("Producto eliminado"),n&&await S(n.id)}catch(c){console.error("Error deleting item:",c),l.error("Error al eliminar")}},finishSession:async()=>{if(n&&confirm("¿Finalizar control de vencimientos?"))try{await Ue(n.id),i(null),d([]),l.success("Control finalizado correctamente")}catch(x){console.error("Error finishing session:",x),l.error("Error al finalizar")}}}}function ns(){const t=ge(),[n,i]=m.useState("config"),[r,d]=m.useState(""),[h,u]=m.useState(!1),[v,w]=m.useState(""),[g,F]=m.useState(null),[O,S]=m.useState(!1),[b,E]=m.useState([]),[A,z]=m.useState(""),[x,c]=m.useState(""),[p,f]=m.useState(""),[P,D]=m.useState(!1),[T,ae]=m.useState(""),{session:j,items:I,totalProducts:V,totalUnits:L,startSession:ne,addItem:re,deleteItem:ie,finishSession:oe}=Qe(),ce=async()=>{if(!r.trim()){l.error("Ingresa el nombre del sector");return}await ne(r.trim()),i("counting")},le=async s=>{await Q(s),u(!1)},de=async s=>{await Q(s.ean,s.name)},Q=async(s,a)=>{w(s);let o=a;if(!o){const U=await we(s);o=U?U.name:`Producto ${s}`}F({name:o,ean:s});const y=I.find(U=>U.ean===s);y?(E([...y.batches]),l.info("Producto ya contado. Editando lotes existentes.")):E([]),S(!0)},me=()=>{if(!A.trim())return l.error("Falta número de lote");if(!x.trim())return l.error("Falta fecha de vencimiento");if(!p||Number(p)<=0)return l.error("Cantidad inválida");const s={batchNumber:A.toUpperCase(),expirationDate:x,quantity:Number(p)};E([...b,s]),z(""),f(""),c("")},xe=s=>{const a=[...b];a.splice(s,1),E(a)},ue=async()=>{if(g){if(b.length===0){l.warning("Debes agregar al menos un lote");return}await re(g.ean,g.name,b),S(!1),F(null),w(""),E([]),z(""),c(""),f("")}},he=()=>{D(!0)},pe=async()=>{if(!T.trim()){l.error("Por favor ingresa el nombre del responsable");return}const s={id:crypto.randomUUID(),sector:(j==null?void 0:j.sector)||r,date:new Date().toISOString(),responsible:T,items:I,stats:{totalProducts:V,totalUnits:L}},a=JSON.parse(localStorage.getItem("expiration-reports")||"[]");localStorage.setItem("expiration-reports",JSON.stringify([s,...a])),await oe(),l.success("Control guardado exitosamente"),t("/reports")},$=s=>{if(!s)return"";if(s.match(/^\d{4}-\d{2}$/)){const[a,o]=s.split("-");return`${o}/${a.slice(2)}`}return s},fe=()=>{if(I.length===0)return l.error("No hay datos");const s=new De;let a=20;s.setFontSize(16),s.text(`Control de Vencimientos: ${j==null?void 0:j.sector}`,10,a),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,a+6),a+=15,I.forEach(o=>{a>270&&(s.addPage(),a=20),s.setFont("helvetica","bold"),s.text(`${o.productName} (EAN: ${o.ean})`,10,a),s.text(`Total: ${o.totalQuantity}`,180,a,{align:"right"}),a+=6,s.setFont("helvetica","normal"),s.setFontSize(9),s.text("Lote",15,a),s.text("Vencimiento",80,a),s.text("Cantidad",150,a),a+=5,o.batches.forEach(y=>{s.text(y.batchNumber,15,a),s.text($(y.expirationDate),80,a),s.text(y.quantity.toString(),150,a),a+=5}),a+=5}),s.save(`Vencimientos_${j==null?void 0:j.sector}.pdf`),l.success("PDF Generado")};return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>t("/stock"),children:e.jsx(Pe,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Control de Vencimientos"}),j&&e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Sector: ",j.sector]})]})]}),e.jsx(ke,{mode:"wait",children:n==="config"?e.jsx(W.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(k,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Configurar Sesión"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nombre del Sector"}),e.jsx(B,{value:r,onChange:s=>d(s.target.value),placeholder:"Ej: Estantería A1",autoFocus:!0})]}),e.jsx(N,{onClick:ce,className:"w-full",size:"lg",children:"Comenzar Control"})]})]})}):e.jsxs(W.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(k,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-3xl font-bold text-primary",children:e.jsx(K,{value:V})})]})}),e.jsx(k,{className:"p-4 bg-secondary/5 border-secondary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Unidades Totales"}),e.jsx("div",{className:"text-3xl font-bold text-foreground",children:e.jsx(K,{value:L})})]})})]}),e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(N,{size:"lg",className:"w-full",onClick:()=>u(!0),children:[e.jsx(Ce,{className:"mr-2 h-5 w-5"}),"Escanear Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O buscar manualmente"})})]}),e.jsx(Ie,{onSelect:de,placeholder:"Buscar por nombre o EAN..."})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:["Registros (",I.length,")"]}),I.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground bg-muted/20 rounded-lg border-dashed border-2",children:[e.jsx(be,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"No hay productos registrados aún"})]}):I.map(s=>e.jsxs(k,{className:"p-4 group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-base",children:s.productName}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["EAN: ",s.ean]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.batches.map((a,o)=>e.jsxs(Se,{variant:"secondary",className:"text-xs font-normal",children:[e.jsx(Be,{className:"w-3 h-3 mr-1 opacity-50"}),$(a.expirationDate),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),"Lote: ",a.batchNumber,e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsxs("strong",{children:["x",a.quantity]})]},o))})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalQuantity}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total"})]})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/80 backdrop-blur rounded-lg p-1",children:[e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-blue-500",onClick:()=>Q(s.ean,s.productName),children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-destructive",onClick:()=>ie(s.id),children:e.jsx(R,{className:"w-4 h-4"})})]})]},s.id))]}),e.jsx(Fe,{actions:[{label:"Finalizar",icon:e.jsx(ye,{className:"w-5 h-5"}),onClick:he,variant:"default",color:"bg-primary text-primary-foreground"},{label:"Exportar PDF",icon:e.jsx(ve,{className:"w-5 h-5"}),onClick:fe,variant:"secondary"}]})]})}),e.jsx(G,{open:O,onOpenChange:s=>{s||(S(!1),w(""),F(null),E([]))},children:e.jsxs(H,{className:"sm:max-w-md",children:[e.jsxs(J,{children:[e.jsx(_,{children:"Gestión de Vencimientos"}),e.jsxs(Y,{children:[g==null?void 0:g.name," ",e.jsx("br",{}),e.jsxs("span",{className:"text-xs",children:["EAN: ",g==null?void 0:g.ean]})]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg space-y-3 border",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Nro. Lote"}),e.jsx(B,{value:A,onChange:s=>z(s.target.value.toUpperCase()),placeholder:"Ej: A123"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Vencimiento"}),e.jsx(B,{type:"text",value:x,onChange:s=>{const a=s.target.value;if(a.length<x.length){c(a);return}let o=a.replace(/\D/g,"");if(o.length>=2){const y=parseInt(o.slice(0,2));(y===0||y>12)&&(l.error("Mes inválido (01-12)"),o=o.slice(0,1))}o.length>=2&&(o=o.slice(0,2)+"/"+o.slice(2,4)),o.length>5&&(o=o.slice(0,5)),c(o)},placeholder:"MM/AA",maxLength:5})]})]}),e.jsxs("div",{className:"flex gap-3 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Cantidad"}),e.jsx(B,{type:"number",value:p,onChange:s=>f(s.target.value),placeholder:"0"})]}),e.jsxs(N,{onClick:me,size:"default",variant:"secondary",children:[e.jsx(X,{className:"w-4 h-4 lg:mr-2"}),e.jsx("span",{className:"hidden lg:inline",children:"Agregar"})]})]})]}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto space-y-2",children:b.length===0?e.jsx("p",{className:"text-sm text-center text-muted-foreground py-4",children:"No hay lotes cargados para este producto."}):b.map((s,a)=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-card border rounded shadow-sm",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-mono font-bold bg-muted px-1 rounded",children:s.batchNumber}),e.jsx("span",{className:"mx-2 text-muted-foreground",children:"•"}),e.jsx("span",{children:$(s.expirationDate)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"font-bold",children:["x",s.quantity]}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive hover:bg-destructive/10",onClick:()=>xe(a),children:e.jsx(R,{className:"w-3 h-3"})})]})]},a))})]}),e.jsxs(Z,{className:"flex-col sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm text-muted-foreground self-center",children:["Total Unidades: ",b.reduce((s,a)=>s+a.quantity,0)]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(N,{variant:"outline",className:"flex-1 sm:flex-none",onClick:()=>S(!1),children:"Cancelar"}),e.jsx(N,{className:"flex-1 sm:flex-none",onClick:ue,disabled:b.length===0,children:"Guardar Todo"})]})]})]})}),e.jsx(G,{open:P,onOpenChange:D,children:e.jsxs(H,{children:[e.jsxs(J,{children:[e.jsx(_,{children:"Finalizar Control de Vencimientos"}),e.jsx(Y,{children:"Por favor confirma los datos para guardar el reporte."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"text-xs text-muted-foreground",children:"Fecha"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-xs text-muted-foreground",children:"Hora"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleTimeString()})]})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"responsible",className:"mb-2 block",children:"Responsable del Control *"}),e.jsx(B,{id:"responsible",value:T,onChange:s=>ae(s.target.value),placeholder:"Nombre y Apellido",autoFocus:!0})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total Unidades Contadas"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:L})]})]}),e.jsxs(Z,{children:[e.jsx(N,{variant:"outline",onClick:()=>D(!1),children:"Cancelar"}),e.jsx(N,{onClick:pe,children:"Guardar y Finalizar"})]})]})}),e.jsx(Ee,{open:h,onOpenChange:u,onScan:le})]})}export{ns as default};
