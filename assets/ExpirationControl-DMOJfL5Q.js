import{j as e}from"./ui-vendor-lsEhpTbO.js";import{r as c,u as oe}from"./react-vendor-ylmX0jv_.js";import{u as ie,y as i,q as V,r as Q,P as M,v as G,$ as H,B as N,X as le,a0 as U,E as J,x as Y,g as z,l as ce,Y as de,t as me,Z as xe}from"./index-fkPGpu1p.js";import{I as F}from"./input-JyldaYdw.js";import{L as O}from"./label-DSPKJeUh.js";import{B as _}from"./badge-KCcCHyJ6.js";import{C as ue,P as he,B as pe}from"./ProductSearchInput-hZlc9Zcw.js";import{a as ge,b as fe,c as Ne,u as je,d as be,e as ve,f as ye}from"./expirationDB-BD8c2wEN.js";import{C as q}from"./CounterAnimation-GIE2m9HH.js";import{F as we}from"./FabMenu-CaaAN1GB.js";import{E as Se}from"./jspdf.es.min-CXUKU6cu.js";import{C as Ce}from"./calendar-CdEK9myB.js";import{P as X}from"./plus-CDdLTvPB.js";import{A as Z,m as L}from"./animation-DZFErbwn.js";import{A as Ee}from"./arrow-left-CGrt_vP4.js";import{C as ke}from"./clock-BxI0vUIu.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";import"./scanner-D4NToCeH.js";import"./useHaptic-9bqCYA5r.js";import"./switch-B3DXLxZa.js";function Ie(){const{user:n}=ie(),[x,w]=c.useState(null),[y,b]=c.useState([]),[D,h]=c.useState(0),[E,v]=c.useState(0),[u,j]=c.useState(!0);c.useEffect(()=>{n!=null&&n.branchName?S(n.branchName):(w(null),b([]))},[n==null?void 0:n.branchName]);const S=async d=>{try{j(!0);const o=await ge(d);w(o),o?await g(o.id):(b([]),h(0),v(0))}catch(o){console.error("Error loading expiration session:",o),i.error("Error al cargar la sesión")}finally{j(!1)}},g=async d=>{const o=await fe(d);o.sort((l,m)=>m.timestamp-l.timestamp),b(o),h(o.length),v(o.reduce((l,m)=>l+m.totalQuantity,0))};return{session:x,items:y,totalProducts:D,totalUnits:E,isLoading:u,startSession:async d=>{try{if(!(n!=null&&n.branchName)){i.error("No hay sucursal seleccionada");return}if(x){i.error("Ya existe una sesión activa");return}const o=await Ne(d,n.branchName);w(o),b([])}catch(o){console.error("Error starting session:",o),i.error("Error al iniciar sesión")}},addItem:async(d,o,l)=>{try{const m=y.find(t=>t.ean===d);if(m)await je(m.id,{batches:l,timestamp:Date.now()}),i.success("Producto actualizado");else{if(!(n!=null&&n.branchName))throw new Error("No branch selected");await be({ean:d,productName:o,batches:l,totalQuantity:l.reduce((t,a)=>t+a.quantity,0)},n.branchName),i.success("Producto agregado")}x&&await g(x.id)}catch(m){console.error("Error adding/updating item:",m),i.error("Error al guardar producto")}},deleteItem:async d=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await ve(d),i.success("Producto eliminado"),x&&await g(x.id)}catch(o){console.error("Error deleting item:",o),i.error("Error al eliminar")}},finishSession:async()=>{if(x&&confirm("¿Finalizar control de vencimientos?"))try{await ye(x.id),w(null),b([]),i.success("Control finalizado correctamente")}catch(d){console.error("Error finishing session:",d),i.error("Error al finalizar")}}}}function Fe({open:n,onOpenChange:x,productName:w,ean:y,initialBatches:b,onSave:D}){const[h,E]=c.useState([]),[v,u]=c.useState(""),[j,S]=c.useState(""),[g,A]=c.useState(""),[p,k]=c.useState(1);c.useEffect(()=>{n&&(E([...b]),C())},[n,b]);const C=()=>{u(""),S(""),A(""),k(1)},d=t=>{if(t.length<j.length){S(t);return}let a=t.replace(/\D/g,"");if(a.length>=2){const P=parseInt(a.slice(0,2));(P===0||P>12)&&(a=a.slice(0,1))}a.length>=2&&(a=a.slice(0,2)+"/"+a.slice(2,4)),a.length>5&&(a=a.slice(0,5)),S(a)},o=()=>{if(!v.trim())return i.error("Falta el Lote");if(j.length<5)return i.error("Fecha incompleta (MM/AA)");if(!g||Number(g)<=0)return i.error("Cantidad inválida");const t={batchNumber:v.toUpperCase(),expirationDate:j,quantity:Number(g),reminderMonths:typeof p=="string"?parseInt(p):p};E(a=>[...a,t]),i.success("Lote agregado",{position:"top-center"}),C()},l=t=>{E(a=>a.filter((P,$)=>$!==t))},m=()=>{if(h.length===0)return i.warning("Debes agregar al menos un lote");D(h),x(!1)};return e.jsx(V,{open:n,onOpenChange:x,children:e.jsxs(Q,{className:"sm:max-w-[500px] p-0 overflow-hidden gap-0 bg-background/95 backdrop-blur-xl border-border/50 shadow-2xl",children:[e.jsxs("div",{className:"bg-primary px-6 py-5 text-primary-foreground relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-10",children:e.jsx(M,{className:"w-24 h-24 rotate-12"})}),e.jsx(G,{className:"text-xl font-bold leading-tight pr-8 relative z-10",children:w}),e.jsxs(H,{className:"text-primary-foreground/80 mt-1 font-mono text-xs relative z-10",children:["EAN: ",y]}),e.jsx(N,{variant:"ghost",size:"icon",className:"absolute top-2 right-2 text-primary-foreground/50 hover:text-primary-foreground hover:bg-primary-foreground/10",onClick:()=>x(!1),children:e.jsx(le,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-12 sm:col-span-5",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Nro. Lote"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{className:"absolute left-3 top-2.5 w-4 h-4 text-muted-foreground"}),e.jsx(F,{value:v,onChange:t=>u(t.target.value.toUpperCase()),className:"pl-9 font-mono bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"A123",autoFocus:!0})]})]}),e.jsxs("div",{className:"col-span-7 sm:col-span-4",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Vence"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-3 top-2.5 w-4 h-4 text-muted-foreground"}),e.jsx(F,{value:j,onChange:t=>d(t.target.value),className:"pl-9 text-center bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"MM/AA",maxLength:5})]})]}),e.jsxs("div",{className:"col-span-5 sm:col-span-3",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Cant."}),e.jsx(F,{type:"number",value:g,onChange:t=>A(t.target.value),className:"text-center font-bold text-lg bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 block flex items-center gap-1.5",children:[e.jsx(U,{className:"w-3 h-3 text-orange-500"})," Recordatorio (Meses antes)"]}),e.jsxs("div",{className:"flex gap-2 w-full",children:[[1,3,6,9].map(t=>e.jsxs("button",{onClick:()=>k(t),className:`
                                    flex-1 py-1.5 text-xs font-medium rounded-full transition-all border
                                    ${p===t?"bg-orange-500 text-white border-orange-500 shadow-sm scale-105":"bg-background text-muted-foreground border-border hover:bg-muted hover:border-muted-foreground/30"}
                                `,children:[t," Mes",t>1&&"es"]},t)),e.jsx("div",{className:"w-16",children:e.jsx(F,{value:typeof p=="number"&&[1,3,6,9].includes(p)?"":p,onChange:t=>{const a=parseInt(t.target.value);k(isNaN(a)?"":a)},placeholder:"#",className:"h-[30px] text-center px-1 text-xs rounded-full border-border bg-background focus-visible:ring-1 focus-visible:ring-orange-500"})})]})]}),e.jsxs(N,{onClick:o,className:"w-full text-sm h-11 shadow-lg shadow-primary/20",size:"lg",children:[e.jsx(X,{className:"w-5 h-5 mr-2"})," Agregar Lote"]})]}),e.jsx("div",{className:"bg-muted/30 rounded-xl p-1 min-h-[120px] max-h-[220px] overflow-y-auto border border-border/50",children:e.jsx(Z,{initial:!1,mode:"popLayout",children:h.length===0?e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"h-full flex flex-col items-center justify-center text-muted-foreground py-8",children:[e.jsx(M,{className:"w-8 h-8 opacity-20 mb-2"}),e.jsx("p",{className:"text-xs",children:"No hay lotes agregados"})]}):h.map((t,a)=>e.jsxs(L.div,{layout:!0,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,x:-20},className:"bg-card p-3 rounded-lg shadow-sm border mb-2 flex items-center justify-between group",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs ring-1 ring-primary/20",children:a+1}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-mono font-bold text-sm tracking-tight",children:t.batchNumber}),e.jsxs(_,{variant:"outline",className:"text-[10px] h-5 px-1.5 font-normal text-muted-foreground border-border",children:["Vence: ",t.expirationDate]})]}),t.reminderMonths&&e.jsxs("div",{className:"flex items-center text-[10px] text-orange-600/80 mt-0.5 font-medium",children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),"Avisar ",t.reminderMonths," meses antes"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-lg font-bold tabular-nums",children:["x",t.quantity]}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10",onClick:()=>l(a),children:e.jsx(J,{className:"w-4 h-4"})})]})]},`${t.batchNumber}-${a}`))})})]}),e.jsxs(Y,{className:"p-4 bg-muted/30 border-t flex-row gap-3",children:[e.jsxs("div",{className:"flex-1 flex items-center text-sm font-medium text-muted-foreground",children:["Total: ",e.jsxs("span",{className:"ml-1 text-foreground font-bold",children:[h.reduce((t,a)=>t+a.quantity,0)," u."]})]}),e.jsx(N,{variant:"ghost",onClick:()=>x(!1),children:"Cancelar"}),e.jsx(N,{onClick:m,disabled:h.length===0,className:"px-8",children:"Guardar"})]})]})})}function Ze(){const n=oe(),[x,w]=c.useState("config"),[y,b]=c.useState(""),[D,h]=c.useState(!1),[E,v]=c.useState(""),[u,j]=c.useState(null),[S,g]=c.useState(!1),[A,p]=c.useState([]),[k,C]=c.useState(!1),[d,o]=c.useState(""),{session:l,items:m,totalProducts:t,totalUnits:a,startSession:P,addItem:$,deleteItem:K,finishSession:W}=Ie(),ee=async()=>{if(!y.trim()){i.error("Ingresa el nombre del sector");return}await P(y.trim()),w("counting")},se=async s=>{await T(s),h(!1)},te=async s=>{await T(s.ean,s.name)},T=async(s,r)=>{v(s);let f=r;if(!f){const B=await xe(s);f=B?B.name:`Producto ${s}`}j({name:f,ean:s});const I=m.find(B=>B.ean===s);I?(p([...I.batches]),i.info("Producto ya contado. Editando lotes existentes.")):p([]),g(!0)},ae=()=>{C(!0)},re=async()=>{if(!d.trim()){i.error("Por favor ingresa el nombre del responsable");return}const s={id:crypto.randomUUID(),sector:(l==null?void 0:l.sector)||y,date:new Date().toISOString(),responsible:d,items:m,stats:{totalProducts:t,totalUnits:a}},r=JSON.parse(localStorage.getItem("expiration-reports")||"[]");localStorage.setItem("expiration-reports",JSON.stringify([s,...r])),await W(),i.success("Control guardado exitosamente"),n("/reports")},R=s=>{if(!s)return"";if(s.match(/^\d{4}-\d{2}$/)){const[r,f]=s.split("-");return`${f}/${r.slice(2)}`}return s},ne=()=>{if(m.length===0)return i.error("No hay datos");const s=new Se;let r=20;s.setFontSize(16),s.text(`Control de Vencimientos: ${l==null?void 0:l.sector}`,10,r),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,r+6),r+=15,m.forEach(f=>{r>270&&(s.addPage(),r=20),s.setFont("helvetica","bold"),s.text(`${f.productName} (EAN: ${f.ean})`,10,r),s.text(`Total: ${f.totalQuantity}`,180,r,{align:"right"}),r+=6,s.setFont("helvetica","normal"),s.setFontSize(9),s.text("Lote",15,r),s.text("Vencimiento",80,r),s.text("Cantidad",150,r),r+=5,f.batches.forEach(I=>{s.text(I.batchNumber,15,r),s.text(R(I.expirationDate),80,r),s.text(I.quantity.toString(),150,r),r+=5}),r+=5}),s.save(`Vencimientos_${l==null?void 0:l.sector}.pdf`),i.success("PDF Generado")};return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>n("/stock"),children:e.jsx(Ee,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Control de Vencimientos"}),l&&e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Sector: ",l.sector]})]})]}),e.jsx(Z,{mode:"wait",children:x==="config"?e.jsx(L.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(z,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Configurar Sesión"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nombre del Sector"}),e.jsx(F,{value:y,onChange:s=>b(s.target.value),placeholder:"Ej: Estantería A1",autoFocus:!0})]}),e.jsx(N,{onClick:ee,className:"w-full",size:"lg",children:"Comenzar Control"})]})]})}):e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(z,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-3xl font-bold text-primary",children:e.jsx(q,{value:t})})]})}),e.jsx(z,{className:"p-4 bg-secondary/5 border-secondary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Unidades Totales"}),e.jsx("div",{className:"text-3xl font-bold text-foreground",children:e.jsx(q,{value:a})})]})})]}),e.jsx(z,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(N,{size:"lg",className:"w-full",onClick:()=>h(!0),children:[e.jsx(ue,{className:"mr-2 h-5 w-5"}),"Escanear Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O buscar manualmente"})})]}),e.jsx(he,{onSelect:te,placeholder:"Buscar por nombre o EAN..."})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:["Registros (",m.length,")"]}),m.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground bg-muted/20 rounded-lg border-dashed border-2",children:[e.jsx(M,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"No hay productos registrados aún"})]}):m.map(s=>e.jsxs(z,{className:"p-4 group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-base",children:s.productName}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["EAN: ",s.ean]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.batches.map((r,f)=>e.jsxs(_,{variant:"secondary",className:"text-xs font-normal",children:[e.jsx(ke,{className:"w-3 h-3 mr-1 opacity-50"}),R(r.expirationDate),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),"Lote: ",r.batchNumber,r.reminderMonths&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsx(U,{className:"w-3 h-3 mr-0.5 text-orange-500"}),r.reminderMonths,"m"]}),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsxs("strong",{children:["x",r.quantity]})]},f))})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalQuantity}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total"})]})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/80 backdrop-blur rounded-lg p-1",children:[e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-blue-500",onClick:()=>T(s.ean,s.productName),children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-destructive",onClick:()=>K(s.id),children:e.jsx(J,{className:"w-4 h-4"})})]})]},s.id))]}),e.jsx(we,{actions:[{label:"Finalizar",icon:e.jsx(ce,{className:"w-5 h-5"}),onClick:ae,variant:"default",color:"bg-primary text-primary-foreground"},{label:"Exportar PDF",icon:e.jsx(de,{className:"w-5 h-5"}),onClick:ne,variant:"secondary"}]})]})}),e.jsx(Fe,{open:S,onOpenChange:s=>{g(s),s||(v(""),j(null),p([]))},productName:(u==null?void 0:u.name)||"",ean:(u==null?void 0:u.ean)||"",initialBatches:A,onSave:async s=>{u&&(await $(u.ean,u.name,s),g(!1),j(null),v(""),p([]))}}),e.jsx(V,{open:k,onOpenChange:C,children:e.jsxs(Q,{children:[e.jsxs(me,{children:[e.jsx(G,{children:"Finalizar Control de Vencimientos"}),e.jsx(H,{children:"Por favor confirma los datos para guardar el reporte."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(O,{className:"text-xs text-muted-foreground",children:"Fecha"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(O,{className:"text-xs text-muted-foreground",children:"Hora"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleTimeString()})]})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:"responsible",className:"mb-2 block",children:"Responsable del Control *"}),e.jsx(F,{id:"responsible",value:d,onChange:s=>o(s.target.value),placeholder:"Nombre y Apellido",autoFocus:!0})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total Unidades Contadas"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:a})]})]}),e.jsxs(Y,{children:[e.jsx(N,{variant:"outline",onClick:()=>C(!1),children:"Cancelar"}),e.jsx(N,{onClick:re,children:"Guardar y Finalizar"})]})]})}),e.jsx(pe,{open:D,onOpenChange:h,onScan:se})]})}export{Ze as default};
