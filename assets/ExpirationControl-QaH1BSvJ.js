import{j as e}from"./ui-vendor-lsEhpTbO.js";import{r as u,u as me}from"./react-vendor-ylmX0jv_.js";import{a0 as xe,u as ue,y as m,q as H,r as J,P as U,v as Y,$ as _,B as S,X as he,a1 as q,E as X,x as Z,g as z,n as pe,Y as ge,t as fe,Z as be}from"./index-DeXVv4-p.js";import{I as P}from"./input-DEW2GVSr.js";import{L as O}from"./label-Db-Lax0o.js";import{B as K}from"./badge-H7T5tQW-.js";import{C as Ne,B as je}from"./BarcodeScanner-BCqZ7w8-.js";import{P as ye}from"./ProductSearchInput-DAWbF_rd.js";import{C as V}from"./CounterAnimation-GIE2m9HH.js";import{F as ve}from"./FabMenu-gIbrsmDY.js";import{A as we,E as Se}from"./jspdf.es.min-DXalnqfA.js";import{C as Ce}from"./calendar-D1PhuQvx.js";import{P as W}from"./plus-DbtSt65B.js";import{A as ee,m as L}from"./animation-DZFErbwn.js";import{C as Ee}from"./clock-Uu6dalKq.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";import"./scanner-D4NToCeH.js";import"./switch-bCqQu93-.js";let G;async function E(){return G=xe("farmaplus-expiration",2,{upgrade(t,r,c,o){if(r<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const f=t.createObjectStore("items",{keyPath:"id"});f.createIndex("by-session","sessionId"),f.createIndex("by-ean","ean")}if(r<2){const l=o.objectStore("sessions");l.indexNames.contains("by-branch")||l.createIndex("by-branch","branchName")}}}),G}async function Ie(t,r){const c=await E(),o={id:crypto.randomUUID(),sector:t,branchName:r,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await c.put("sessions",o),o}async function se(t){return(await(await E()).getAllFromIndex("sessions","by-status","active")).find(l=>l.branchName===t)||null}async function ke(t,r){const c=await E(),o=await c.get("sessions",t);o&&await c.put("sessions",{...o,...r})}async function Fe(t){await ke(t,{status:"completed",endTime:Date.now()})}async function De(t,r){const c=await E(),o=await se(r);if(!o)throw new Error("No active expiration session");if((await c.getAllFromIndex("items","by-session",o.id)).find(j=>j.ean===t.ean))throw new Error("Item already exists in session. Use update.");const h={id:crypto.randomUUID(),sessionId:o.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((j,y)=>j+y.quantity,0),timestamp:Date.now(),synced:0};return await c.put("items",h),await R(o.id),h}async function Pe(t,r){const c=await E(),o=await c.get("items",t);if(o){const l={...o,...r};r.batches&&(l.totalQuantity=r.batches.reduce((f,h)=>f+h.quantity,0)),await c.put("items",l),await R(o.sessionId)}}async function Ae(t){const r=await E(),c=await r.get("items",t);c&&(await r.delete("items",t),await R(c.sessionId))}async function te(t){return(await E()).getAllFromIndex("items","by-session",t)}async function R(t){const r=await te(t),c=await E(),o=r.length,l=r.reduce((h,j)=>h+j.totalQuantity,0),f=await c.get("sessions",t);f&&await c.put("sessions",{...f,totalProducts:o,totalUnits:l})}function Be(){const{user:t}=ue(),[r,c]=u.useState(null),[o,l]=u.useState([]),[f,h]=u.useState(0),[j,y]=u.useState(0),[b,C]=u.useState(!0);u.useEffect(()=>{t!=null&&t.branchName?I(t.branchName):(c(null),l([]))},[t==null?void 0:t.branchName]);const I=async p=>{try{C(!0);const d=await se(p);c(d),d?await v(d.id):(l([]),h(0),y(0))}catch(d){console.error("Error loading expiration session:",d),m.error("Error al cargar la sesión")}finally{C(!1)}},v=async p=>{const d=await te(p);d.sort((x,g)=>g.timestamp-x.timestamp),l(d),h(d.length),y(d.reduce((x,g)=>x+g.totalQuantity,0))};return{session:r,items:o,totalProducts:f,totalUnits:j,isLoading:b,startSession:async p=>{try{if(!(t!=null&&t.branchName)){m.error("No hay sucursal seleccionada");return}if(r){m.error("Ya existe una sesión activa");return}const d=await Ie(p,t.branchName);c(d),l([])}catch(d){console.error("Error starting session:",d),m.error("Error al iniciar sesión")}},addItem:async(p,d,x)=>{try{const g=o.find(a=>a.ean===p);if(g)await Pe(g.id,{batches:x,timestamp:Date.now()}),m.success("Producto actualizado");else{if(!(t!=null&&t.branchName))throw new Error("No branch selected");await De({ean:p,productName:d,batches:x,totalQuantity:x.reduce((a,n)=>a+n.quantity,0)},t.branchName),m.success("Producto agregado")}r&&await v(r.id)}catch(g){console.error("Error adding/updating item:",g),m.error("Error al guardar producto")}},deleteItem:async p=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await Ae(p),m.success("Producto eliminado"),r&&await v(r.id)}catch(d){console.error("Error deleting item:",d),m.error("Error al eliminar")}},finishSession:async()=>{if(r&&confirm("¿Finalizar control de vencimientos?"))try{await Fe(r.id),c(null),l([]),m.success("Control finalizado correctamente")}catch(p){console.error("Error finishing session:",p),m.error("Error al finalizar")}}}}function ze({open:t,onOpenChange:r,productName:c,ean:o,initialBatches:l,onSave:f}){const[h,j]=u.useState([]),[y,b]=u.useState(""),[C,I]=u.useState(""),[v,A]=u.useState(""),[N,F]=u.useState(1);u.useEffect(()=>{t&&(j([...l]),k())},[t,l]);const k=()=>{b(""),I(""),A(""),F(1)},p=a=>{if(a.length<C.length){I(a);return}let n=a.replace(/\D/g,"");if(n.length>=2){const B=parseInt(n.slice(0,2));(B===0||B>12)&&(n=n.slice(0,1))}n.length>=2&&(n=n.slice(0,2)+"/"+n.slice(2,4)),n.length>5&&(n=n.slice(0,5)),I(n)},d=()=>{if(!y.trim())return m.error("Falta el Lote");if(C.length<5)return m.error("Fecha incompleta (MM/AA)");if(!v||Number(v)<=0)return m.error("Cantidad inválida");const a={batchNumber:y.toUpperCase(),expirationDate:C,quantity:Number(v),reminderMonths:typeof N=="string"?parseInt(N):N};j(n=>[...n,a]),m.success("Lote agregado",{position:"top-center"}),k()},x=a=>{j(n=>n.filter((B,T)=>T!==a))},g=()=>{if(h.length===0)return m.warning("Debes agregar al menos un lote");f(h),r(!1)};return e.jsx(H,{open:t,onOpenChange:r,children:e.jsxs(J,{className:"sm:max-w-[500px] p-0 overflow-hidden gap-0 bg-background/95 backdrop-blur-xl border-border/50 shadow-2xl",children:[e.jsxs("div",{className:"bg-primary px-6 py-5 text-primary-foreground relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-10",children:e.jsx(U,{className:"w-24 h-24 rotate-12"})}),e.jsx(Y,{className:"text-xl font-bold leading-tight pr-8 relative z-10",children:c}),e.jsxs(_,{className:"text-primary-foreground/80 mt-1 font-mono text-xs relative z-10",children:["EAN: ",o]}),e.jsx(S,{variant:"ghost",size:"icon",className:"absolute top-2 right-2 text-primary-foreground/50 hover:text-primary-foreground hover:bg-primary-foreground/10",onClick:()=>r(!1),children:e.jsx(he,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-12 sm:col-span-5",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Nro. Lote"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-2.5 w-4 h-4 text-muted-foreground"}),e.jsx(P,{value:y,onChange:a=>b(a.target.value.toUpperCase()),className:"pl-9 font-mono bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"A123",autoFocus:!0})]})]}),e.jsxs("div",{className:"col-span-7 sm:col-span-4",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Vence"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-3 top-2.5 w-4 h-4 text-muted-foreground"}),e.jsx(P,{value:C,onChange:a=>p(a.target.value),className:"pl-9 text-center bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"MM/AA",maxLength:5})]})]}),e.jsxs("div",{className:"col-span-5 sm:col-span-3",children:[e.jsx("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1.5 block ml-1",children:"Cant."}),e.jsx(P,{type:"number",value:v,onChange:a=>A(a.target.value),className:"text-center font-bold text-lg bg-muted/30 border-muted-foreground/20 focus-visible:ring-primary/20",placeholder:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 block flex items-center gap-1.5",children:[e.jsx(q,{className:"w-3 h-3 text-orange-500"})," Recordatorio (Meses antes)"]}),e.jsxs("div",{className:"flex gap-2 w-full",children:[[1,3,6,9].map(a=>e.jsxs("button",{onClick:()=>F(a),className:`
                                    flex-1 py-1.5 text-xs font-medium rounded-full transition-all border
                                    ${N===a?"bg-orange-500 text-white border-orange-500 shadow-sm scale-105":"bg-background text-muted-foreground border-border hover:bg-muted hover:border-muted-foreground/30"}
                                `,children:[a," Mes",a>1&&"es"]},a)),e.jsx("div",{className:"w-16",children:e.jsx(P,{value:typeof N=="number"&&[1,3,6,9].includes(N)?"":N,onChange:a=>{const n=parseInt(a.target.value);F(isNaN(n)?"":n)},placeholder:"#",className:"h-[30px] text-center px-1 text-xs rounded-full border-border bg-background focus-visible:ring-1 focus-visible:ring-orange-500"})})]})]}),e.jsxs(S,{onClick:d,className:"w-full text-sm h-11 shadow-lg shadow-primary/20",size:"lg",children:[e.jsx(W,{className:"w-5 h-5 mr-2"})," Agregar Lote"]})]}),e.jsx("div",{className:"bg-muted/30 rounded-xl p-1 min-h-[120px] max-h-[220px] overflow-y-auto border border-border/50",children:e.jsx(ee,{initial:!1,mode:"popLayout",children:h.length===0?e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"h-full flex flex-col items-center justify-center text-muted-foreground py-8",children:[e.jsx(U,{className:"w-8 h-8 opacity-20 mb-2"}),e.jsx("p",{className:"text-xs",children:"No hay lotes agregados"})]}):h.map((a,n)=>e.jsxs(L.div,{layout:!0,initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,x:-20},className:"bg-card p-3 rounded-lg shadow-sm border mb-2 flex items-center justify-between group",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs ring-1 ring-primary/20",children:n+1}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-mono font-bold text-sm tracking-tight",children:a.batchNumber}),e.jsxs(K,{variant:"outline",className:"text-[10px] h-5 px-1.5 font-normal text-muted-foreground border-border",children:["Vence: ",a.expirationDate]})]}),a.reminderMonths&&e.jsxs("div",{className:"flex items-center text-[10px] text-orange-600/80 mt-0.5 font-medium",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Avisar ",a.reminderMonths," meses antes"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-lg font-bold tabular-nums",children:["x",a.quantity]}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-7 w-7 text-muted-foreground hover:text-destructive hover:bg-destructive/10",onClick:()=>x(n),children:e.jsx(X,{className:"w-4 h-4"})})]})]},`${a.batchNumber}-${n}`))})})]}),e.jsxs(Z,{className:"p-4 bg-muted/30 border-t flex-row gap-3",children:[e.jsxs("div",{className:"flex-1 flex items-center text-sm font-medium text-muted-foreground",children:["Total: ",e.jsxs("span",{className:"ml-1 text-foreground font-bold",children:[h.reduce((a,n)=>a+n.quantity,0)," u."]})]}),e.jsx(S,{variant:"ghost",onClick:()=>r(!1),children:"Cancelar"}),e.jsx(S,{onClick:g,disabled:h.length===0,className:"px-8",children:"Guardar"})]})]})})}function es(){const t=me(),[r,c]=u.useState("config"),[o,l]=u.useState(""),[f,h]=u.useState(!1),[j,y]=u.useState(""),[b,C]=u.useState(null),[I,v]=u.useState(!1),[A,N]=u.useState([]),[F,k]=u.useState(!1),[p,d]=u.useState(""),{session:x,items:g,totalProducts:a,totalUnits:n,startSession:B,addItem:T,deleteItem:ae,finishSession:re}=Be(),ne=async()=>{if(!o.trim()){m.error("Ingresa el nombre del sector");return}await B(o.trim()),c("counting")},oe=async s=>{await $(s),h(!1)},ie=async s=>{await $(s.ean,s.name)},$=async(s,i)=>{y(s);let w=i;if(!w){const M=await be(s);w=M?M.name:`Producto ${s}`}C({name:w,ean:s});const D=g.find(M=>M.ean===s);D?(N([...D.batches]),m.info("Producto ya contado. Editando lotes existentes.")):N([]),v(!0)},ce=()=>{k(!0)},le=async()=>{if(!p.trim()){m.error("Por favor ingresa el nombre del responsable");return}const s={id:crypto.randomUUID(),sector:(x==null?void 0:x.sector)||o,date:new Date().toISOString(),responsible:p,items:g,stats:{totalProducts:a,totalUnits:n}},i=JSON.parse(localStorage.getItem("expiration-reports")||"[]");localStorage.setItem("expiration-reports",JSON.stringify([s,...i])),await re(),m.success("Control guardado exitosamente"),t("/reports")},Q=s=>{if(!s)return"";if(s.match(/^\d{4}-\d{2}$/)){const[i,w]=s.split("-");return`${w}/${i.slice(2)}`}return s},de=()=>{if(g.length===0)return m.error("No hay datos");const s=new Se;let i=20;s.setFontSize(16),s.text(`Control de Vencimientos: ${x==null?void 0:x.sector}`,10,i),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,i+6),i+=15,g.forEach(w=>{i>270&&(s.addPage(),i=20),s.setFont("helvetica","bold"),s.text(`${w.productName} (EAN: ${w.ean})`,10,i),s.text(`Total: ${w.totalQuantity}`,180,i,{align:"right"}),i+=6,s.setFont("helvetica","normal"),s.setFontSize(9),s.text("Lote",15,i),s.text("Vencimiento",80,i),s.text("Cantidad",150,i),i+=5,w.batches.forEach(D=>{s.text(D.batchNumber,15,i),s.text(Q(D.expirationDate),80,i),s.text(D.quantity.toString(),150,i),i+=5}),i+=5}),s.save(`Vencimientos_${x==null?void 0:x.sector}.pdf`),m.success("PDF Generado")};return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>t("/stock"),children:e.jsx(we,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Control de Vencimientos"}),x&&e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Sector: ",x.sector]})]})]}),e.jsx(ee,{mode:"wait",children:r==="config"?e.jsx(L.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(z,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Configurar Sesión"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nombre del Sector"}),e.jsx(P,{value:o,onChange:s=>l(s.target.value),placeholder:"Ej: Estantería A1",autoFocus:!0})]}),e.jsx(S,{onClick:ne,className:"w-full",size:"lg",children:"Comenzar Control"})]})]})}):e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(z,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-3xl font-bold text-primary",children:e.jsx(V,{value:a})})]})}),e.jsx(z,{className:"p-4 bg-secondary/5 border-secondary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Unidades Totales"}),e.jsx("div",{className:"text-3xl font-bold text-foreground",children:e.jsx(V,{value:n})})]})})]}),e.jsx(z,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(S,{size:"lg",className:"w-full",onClick:()=>h(!0),children:[e.jsx(Ne,{className:"mr-2 h-5 w-5"}),"Escanear Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O buscar manualmente"})})]}),e.jsx(ye,{onSelect:ie,placeholder:"Buscar por nombre o EAN..."})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:["Registros (",g.length,")"]}),g.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground bg-muted/20 rounded-lg border-dashed border-2",children:[e.jsx(U,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"No hay productos registrados aún"})]}):g.map(s=>e.jsxs(z,{className:"p-4 group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-base",children:s.productName}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["EAN: ",s.ean]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.batches.map((i,w)=>e.jsxs(K,{variant:"secondary",className:"text-xs font-normal",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1 opacity-50"}),Q(i.expirationDate),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),"Lote: ",i.batchNumber,i.reminderMonths&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsx(q,{className:"w-3 h-3 mr-0.5 text-orange-500"}),i.reminderMonths,"m"]}),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsxs("strong",{children:["x",i.quantity]})]},w))})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalQuantity}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total"})]})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/80 backdrop-blur rounded-lg p-1",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-blue-500",onClick:()=>$(s.ean,s.productName),children:e.jsx(W,{className:"w-4 h-4"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-destructive",onClick:()=>ae(s.id),children:e.jsx(X,{className:"w-4 h-4"})})]})]},s.id))]}),e.jsx(ve,{actions:[{label:"Finalizar",icon:e.jsx(pe,{className:"w-5 h-5"}),onClick:ce,variant:"default",color:"bg-primary text-primary-foreground"},{label:"Exportar PDF",icon:e.jsx(ge,{className:"w-5 h-5"}),onClick:de,variant:"secondary"}]})]})}),e.jsx(ze,{open:I,onOpenChange:s=>{v(s),s||(y(""),C(null),N([]))},productName:(b==null?void 0:b.name)||"",ean:(b==null?void 0:b.ean)||"",initialBatches:A,onSave:async s=>{b&&(await T(b.ean,b.name,s),v(!1),C(null),y(""),N([]))}}),e.jsx(H,{open:F,onOpenChange:k,children:e.jsxs(J,{children:[e.jsxs(fe,{children:[e.jsx(Y,{children:"Finalizar Control de Vencimientos"}),e.jsx(_,{children:"Por favor confirma los datos para guardar el reporte."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(O,{className:"text-xs text-muted-foreground",children:"Fecha"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(O,{className:"text-xs text-muted-foreground",children:"Hora"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleTimeString()})]})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:"responsible",className:"mb-2 block",children:"Responsable del Control *"}),e.jsx(P,{id:"responsible",value:p,onChange:s=>d(s.target.value),placeholder:"Nombre y Apellido",autoFocus:!0})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total Unidades Contadas"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:n})]})]}),e.jsxs(Z,{children:[e.jsx(S,{variant:"outline",onClick:()=>k(!1),children:"Cancelar"}),e.jsx(S,{onClick:le,children:"Guardar y Finalizar"})]})]})}),e.jsx(je,{open:f,onOpenChange:h,onScan:oe})]})}export{es as default};
