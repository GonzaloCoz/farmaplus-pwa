import{j as e}from"./ui-vendor-lsEhpTbO.js";import{r as m,u as be}from"./react-vendor-ylmX0jv_.js";import{a0 as ye,u as ve,y as l,B as g,g as A,P as we,a1 as G,E as H,n as Se,Y as Ce,q as J,r as Y,t as Z,v as _,$ as K,a2 as Ee,x as W,Z as Ie}from"./index-Bf7eI8nq.js";import{I as D}from"./input-BeyIuFGC.js";import{L as q}from"./label-o4Ejck9J.js";import{B as Fe}from"./badge-kJnZ7vkS.js";import{C as Pe,B as Be}from"./BarcodeScanner-BnDWSf-q.js";import{P as De}from"./ProductSearchInput-CKDbvnpR.js";import{C as X}from"./CounterAnimation-GIE2m9HH.js";import{F as ke}from"./FabMenu-DyeaBJk0.js";import{A as Ae,E as ze}from"./jspdf.es.min-BdgrgvYu.js";import{A as Ue,m as ee}from"./animation-DZFErbwn.js";import{C as Me}from"./clock-CAC-0zD3.js";import{P as se}from"./plus-CzqlYmBd.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";import"./scanner-D4NToCeH.js";import"./switch-CHF5f21z.js";let te;async function E(){return te=ye("farmaplus-expiration",2,{upgrade(t,n,i,r){if(n<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const h=t.createObjectStore("items",{keyPath:"id"});h.createIndex("by-session","sessionId"),h.createIndex("by-ean","ean")}if(n<2){const d=r.objectStore("sessions");d.indexNames.contains("by-branch")||d.createIndex("by-branch","branchName")}}}),te}async function Oe(t,n){const i=await E(),r={id:crypto.randomUUID(),sector:t,branchName:n,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await i.put("sessions",r),r}async function ae(t){return(await(await E()).getAllFromIndex("sessions","by-status","active")).find(d=>d.branchName===t)||null}async function Te(t,n){const i=await E(),r=await i.get("sessions",t);r&&await i.put("sessions",{...r,...n})}async function Le(t){await Te(t,{status:"completed",endTime:Date.now()})}async function $e(t,n){const i=await E(),r=await ae(n);if(!r)throw new Error("No active expiration session");if((await i.getAllFromIndex("items","by-session",r.id)).find(w=>w.ean===t.ean))throw new Error("Item already exists in session. Use update.");const u={id:crypto.randomUUID(),sessionId:r.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((w,S)=>w+S.quantity,0),timestamp:Date.now(),synced:0};return await i.put("items",u),await Q(r.id),u}async function Re(t,n){const i=await E(),r=await i.get("items",t);if(r){const d={...r,...n};n.batches&&(d.totalQuantity=n.batches.reduce((h,u)=>h+u.quantity,0)),await i.put("items",d),await Q(r.sessionId)}}async function qe(t){const n=await E(),i=await n.get("items",t);i&&(await n.delete("items",t),await Q(i.sessionId))}async function ne(t){return(await E()).getAllFromIndex("items","by-session",t)}async function Q(t){const n=await ne(t),i=await E(),r=n.length,d=n.reduce((u,w)=>u+w.totalQuantity,0),h=await i.get("sessions",t);h&&await i.put("sessions",{...h,totalProducts:r,totalUnits:d})}function Qe(){const{user:t}=ve(),[n,i]=m.useState(null),[r,d]=m.useState([]),[h,u]=m.useState(0),[w,S]=m.useState(0),[j,P]=m.useState(!0);m.useEffect(()=>{t!=null&&t.branchName?M(t.branchName):(i(null),d([]))},[t==null?void 0:t.branchName]);const M=async x=>{try{P(!0);const c=await ae(x);i(c),c?await C(c.id):(d([]),u(0),S(0))}catch(c){console.error("Error loading expiration session:",c),l.error("Error al cargar la sesión")}finally{P(!1)}},C=async x=>{const c=await ne(x);c.sort((p,f)=>f.timestamp-p.timestamp),d(c),u(c.length),S(c.reduce((p,f)=>p+f.totalQuantity,0))};return{session:n,items:r,totalProducts:h,totalUnits:w,isLoading:j,startSession:async x=>{try{if(!(t!=null&&t.branchName)){l.error("No hay sucursal seleccionada");return}if(n){l.error("Ya existe una sesión activa");return}const c=await Oe(x,t.branchName);i(c),d([])}catch(c){console.error("Error starting session:",c),l.error("Error al iniciar sesión")}},addItem:async(x,c,p)=>{try{const f=r.find(y=>y.ean===x);if(f)await Re(f.id,{batches:p,timestamp:Date.now()}),l.success("Producto actualizado");else{if(!(t!=null&&t.branchName))throw new Error("No branch selected");await $e({ean:x,productName:c,batches:p,totalQuantity:p.reduce((y,B)=>y+B.quantity,0)},t.branchName),l.success("Producto agregado")}n&&await C(n.id)}catch(f){console.error("Error adding/updating item:",f),l.error("Error al guardar producto")}},deleteItem:async x=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await qe(x),l.success("Producto eliminado"),n&&await C(n.id)}catch(c){console.error("Error deleting item:",c),l.error("Error al eliminar")}},finishSession:async()=>{if(n&&confirm("¿Finalizar control de vencimientos?"))try{await Le(n.id),i(null),d([]),l.success("Control finalizado correctamente")}catch(x){console.error("Error finishing session:",x),l.error("Error al finalizar")}}}}function cs(){const t=be(),[n,i]=m.useState("config"),[r,d]=m.useState(""),[h,u]=m.useState(!1),[w,S]=m.useState(""),[j,P]=m.useState(null),[M,C]=m.useState(!1),[b,I]=m.useState([]),[z,k]=m.useState(""),[x,c]=m.useState(""),[p,f]=m.useState(""),[y,B]=m.useState(1),[re,O]=m.useState(!1),[T,ie]=m.useState(""),{session:N,items:F,totalProducts:V,totalUnits:L,startSession:oe,addItem:ce,deleteItem:le,finishSession:de}=Qe(),me=async()=>{if(!r.trim()){l.error("Ingresa el nombre del sector");return}await oe(r.trim()),i("counting")},xe=async s=>{await $(s),u(!1)},ue=async s=>{await $(s.ean,s.name)},$=async(s,a)=>{S(s);let o=a;if(!o){const U=await Ie(s);o=U?U.name:`Producto ${s}`}P({name:o,ean:s});const v=F.find(U=>U.ean===s);v?(I([...v.batches]),l.info("Producto ya contado. Editando lotes existentes.")):I([]),C(!0)},he=()=>{if(!z.trim())return l.error("Falta número de lote");if(!x.trim())return l.error("Falta fecha de vencimiento");if(!p||Number(p)<=0)return l.error("Cantidad inválida");const s={batchNumber:z.toUpperCase(),expirationDate:x,quantity:Number(p),reminderMonths:typeof y=="string"?parseInt(y):y};I([...b,s]),k(""),f(""),c(""),B(1)},pe=s=>{const a=[...b];a.splice(s,1),I(a)},fe=async()=>{if(j){if(b.length===0){l.warning("Debes agregar al menos un lote");return}await ce(j.ean,j.name,b),C(!1),P(null),S(""),I([]),k(""),k(""),c(""),f(""),B(1)}},ge=()=>{O(!0)},je=async()=>{if(!T.trim()){l.error("Por favor ingresa el nombre del responsable");return}const s={id:crypto.randomUUID(),sector:(N==null?void 0:N.sector)||r,date:new Date().toISOString(),responsible:T,items:F,stats:{totalProducts:V,totalUnits:L}},a=JSON.parse(localStorage.getItem("expiration-reports")||"[]");localStorage.setItem("expiration-reports",JSON.stringify([s,...a])),await de(),l.success("Control guardado exitosamente"),t("/reports")},R=s=>{if(!s)return"";if(s.match(/^\d{4}-\d{2}$/)){const[a,o]=s.split("-");return`${o}/${a.slice(2)}`}return s},Ne=()=>{if(F.length===0)return l.error("No hay datos");const s=new ze;let a=20;s.setFontSize(16),s.text(`Control de Vencimientos: ${N==null?void 0:N.sector}`,10,a),s.setFontSize(10),s.text(`Fecha: ${new Date().toLocaleDateString()}`,10,a+6),a+=15,F.forEach(o=>{a>270&&(s.addPage(),a=20),s.setFont("helvetica","bold"),s.text(`${o.productName} (EAN: ${o.ean})`,10,a),s.text(`Total: ${o.totalQuantity}`,180,a,{align:"right"}),a+=6,s.setFont("helvetica","normal"),s.setFontSize(9),s.text("Lote",15,a),s.text("Vencimiento",80,a),s.text("Cantidad",150,a),a+=5,o.batches.forEach(v=>{s.text(v.batchNumber,15,a),s.text(R(v.expirationDate),80,a),s.text(v.quantity.toString(),150,a),a+=5}),a+=5}),s.save(`Vencimientos_${N==null?void 0:N.sector}.pdf`),l.success("PDF Generado")};return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto pb-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>t("/stock"),children:e.jsx(Ae,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Control de Vencimientos"}),N&&e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Sector: ",N.sector]})]})]}),e.jsx(Ue,{mode:"wait",children:n==="config"?e.jsx(ee.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Configurar Sesión"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nombre del Sector"}),e.jsx(D,{value:r,onChange:s=>d(s.target.value),placeholder:"Ej: Estantería A1",autoFocus:!0})]}),e.jsx(g,{onClick:me,className:"w-full",size:"lg",children:"Comenzar Control"})]})]})}):e.jsxs(ee.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(A,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Productos"}),e.jsx("div",{className:"text-3xl font-bold text-primary",children:e.jsx(X,{value:V})})]})}),e.jsx(A,{className:"p-4 bg-secondary/5 border-secondary/20",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Unidades Totales"}),e.jsx("div",{className:"text-3xl font-bold text-foreground",children:e.jsx(X,{value:L})})]})})]}),e.jsx(A,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{size:"lg",className:"w-full",onClick:()=>u(!0),children:[e.jsx(Pe,{className:"mr-2 h-5 w-5"}),"Escanear Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O buscar manualmente"})})]}),e.jsx(De,{onSelect:ue,placeholder:"Buscar por nombre o EAN..."})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:["Registros (",F.length,")"]}),F.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground bg-muted/20 rounded-lg border-dashed border-2",children:[e.jsx(we,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"No hay productos registrados aún"})]}):F.map(s=>e.jsxs(A,{className:"p-4 group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-base",children:s.productName}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["EAN: ",s.ean]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.batches.map((a,o)=>e.jsxs(Fe,{variant:"secondary",className:"text-xs font-normal",children:[e.jsx(Me,{className:"w-3 h-3 mr-1 opacity-50"}),R(a.expirationDate),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),"Lote: ",a.batchNumber,a.reminderMonths&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsx(G,{className:"w-3 h-3 mr-0.5 text-orange-500"}),a.reminderMonths,"m"]}),e.jsx("span",{className:"mx-1 text-muted-foreground",children:"|"}),e.jsxs("strong",{children:["x",a.quantity]})]},o))})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalQuantity}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total"})]})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-background/80 backdrop-blur rounded-lg p-1",children:[e.jsx(g,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-blue-500",onClick:()=>$(s.ean,s.productName),children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx(g,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:text-destructive",onClick:()=>le(s.id),children:e.jsx(H,{className:"w-4 h-4"})})]})]},s.id))]}),e.jsx(ke,{actions:[{label:"Finalizar",icon:e.jsx(Se,{className:"w-5 h-5"}),onClick:ge,variant:"default",color:"bg-primary text-primary-foreground"},{label:"Exportar PDF",icon:e.jsx(Ce,{className:"w-5 h-5"}),onClick:Ne,variant:"secondary"}]})]})}),e.jsx(J,{open:M,onOpenChange:s=>{s||(C(!1),S(""),P(null),I([]))},children:e.jsxs(Y,{className:"sm:max-w-md",children:[e.jsxs(Z,{children:[e.jsx(_,{children:"Gestión de Vencimientos"}),e.jsxs(K,{children:[j==null?void 0:j.name," ",e.jsx("br",{}),e.jsxs("span",{className:"text-xs",children:["EAN: ",j==null?void 0:j.ean]})]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg space-y-3 border",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Nro. Lote"}),e.jsx(D,{value:z,onChange:s=>k(s.target.value.toUpperCase()),placeholder:"Ej: A123"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Vencimiento"}),e.jsx(D,{type:"text",value:x,onChange:s=>{const a=s.target.value;if(a.length<x.length){c(a);return}let o=a.replace(/\D/g,"");if(o.length>=2){const v=parseInt(o.slice(0,2));(v===0||v>12)&&(l.error("Mes inválido (01-12)"),o=o.slice(0,1))}o.length>=2&&(o=o.slice(0,2)+"/"+o.slice(2,4)),o.length>5&&(o=o.slice(0,5)),c(o)},placeholder:"MM/AA",maxLength:5})]})]}),e.jsx("div",{className:"flex gap-3 items-end",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs font-medium mb-1 block",children:"Cantidad"}),e.jsx(D,{type:"number",value:p,onChange:s=>f(s.target.value),placeholder:"0"})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-medium mb-2 block flex items-center gap-2",children:[e.jsx(Ee,{className:"w-3 h-3"})," Recordatorio (Meses antes)"]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[[1,3,6,9].map(s=>e.jsxs(g,{variant:y===s?"default":"outline",size:"sm",className:"h-8",onClick:()=>B(s),children:[s," Mes",s>1?"es":""]},s)),e.jsx("div",{className:"flex items-center gap-1 w-20",children:e.jsx(D,{className:"h-8 text-center px-1",placeholder:"#",type:"number",value:y,onChange:s=>{const a=parseInt(s.target.value);B(isNaN(a)?"":a)}})})]})]}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsxs(g,{onClick:he,size:"default",variant:"secondary",className:"w-full sm:w-auto",children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Agregar Lote"]})})]}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto space-y-2",children:b.length===0?e.jsx("p",{className:"text-sm text-center text-muted-foreground py-4",children:"No hay lotes cargados para este producto."}):b.map((s,a)=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-card border rounded shadow-sm",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-mono font-bold bg-muted px-1 rounded",children:s.batchNumber}),e.jsx("span",{className:"mx-2 text-muted-foreground",children:"•"}),e.jsx("span",{children:R(s.expirationDate)}),s.reminderMonths!==void 0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2 text-muted-foreground",children:"•"}),e.jsxs("span",{className:"inline-flex items-center text-xs text-orange-600 bg-orange-50 px-1 rounded border border-orange-100",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),s.reminderMonths,"m"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"font-bold",children:["x",s.quantity]}),e.jsx(g,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive hover:bg-destructive/10",onClick:()=>pe(a),children:e.jsx(H,{className:"w-3 h-3"})})]})]},a))})]}),e.jsxs(W,{className:"flex-col sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm text-muted-foreground self-center",children:["Total Unidades: ",b.reduce((s,a)=>s+a.quantity,0)]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(g,{variant:"outline",className:"flex-1 sm:flex-none",onClick:()=>C(!1),children:"Cancelar"}),e.jsx(g,{className:"flex-1 sm:flex-none",onClick:fe,disabled:b.length===0,children:"Guardar Todo"})]})]})]})}),e.jsx(J,{open:re,onOpenChange:O,children:e.jsxs(Y,{children:[e.jsxs(Z,{children:[e.jsx(_,{children:"Finalizar Control de Vencimientos"}),e.jsx(K,{children:"Por favor confirma los datos para guardar el reporte."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"text-xs text-muted-foreground",children:"Fecha"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-xs text-muted-foreground",children:"Hora"}),e.jsx("div",{className:"font-medium",children:new Date().toLocaleTimeString()})]})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"responsible",className:"mb-2 block",children:"Responsable del Control *"}),e.jsx(D,{id:"responsible",value:T,onChange:s=>ie(s.target.value),placeholder:"Nombre y Apellido",autoFocus:!0})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Total Unidades Contadas"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:L})]})]}),e.jsxs(W,{children:[e.jsx(g,{variant:"outline",onClick:()=>O(!1),children:"Cancelar"}),e.jsx(g,{onClick:je,children:"Guardar y Finalizar"})]})]})}),e.jsx(Be,{open:h,onOpenChange:u,onScan:xe})]})}export{cs as default};
