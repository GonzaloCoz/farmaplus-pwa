import{j as e,h as ue,i as xe,k as fe,l as ge,A as pe,m as he,n as Ke,o as Je}from"./ui-vendor-BThK-wRW.js";import{r as s,u as Xe}from"./react-vendor-CodVchXk.js";import{c as J,u as m,D as ye,h as je,i as Ne,j as ve,o as _e,g as Ze,B as P,X as es,s as ss,p as w,P as U,q as be,r as we,C as R,t as as,v as ts,w as ne,x as rs,y as oe,z as ns,A as os,E as is,F as ie,G as cs,H as ce,I as ls,W as ds,J as ms,K as le,L as us}from"./index-NZoOjXQK.js";import{I as H}from"./input-DRl-gkqf.js";import{H as xs}from"./scanner-DMepX-1M.js";import{A as B,m as E,u as fs,a as G}from"./animation-BITtOU9j.js";import{C as K,W as gs}from"./wifi-HGTGcaVU.js";import{S as ps}from"./search-Cj2-UjxK.js";import{C as de}from"./CounterAnimation-Zajara5_.js";import{E as hs}from"./jspdf.es.min-BTnzBWvn.js";import{A as ys,J as me}from"./JsBarcode-ChPle0Vp.js";import{P as js}from"./plus-Cdd2bb0N.js";import"./utils-CUsTgaRG.js";import"./excel-uoQkVabA.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=J("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=J("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=J("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);function Ee(){return{trigger:s.useCallback((c="light")=>{if(!("vibrate"in navigator))return;const u={light:10,medium:20,heavy:30,selection:[5,10],success:[10,50,10],warning:[20,100,20],error:[30,100,30,100,30]}[c];try{Array.isArray(u),navigator.vibrate(u)}catch(f){console.warn("Haptic feedback failed:",f)}},[])}}function vs({open:i,onOpenChange:c,onScan:r}){const[u,f]=s.useState(!1),[x,g]=s.useState(null),[l,t]=s.useState(null),[y,v]=s.useState(!1),N=s.useRef(null),C="barcode-reader",{trigger:d}=Ee();s.useEffect(()=>(i&&!N.current&&!y&&h(),()=>{o()}),[i,y]);const p=async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(A=>A.stop()),!0}catch(j){return console.error("Error requesting camera permission:",j),j instanceof DOMException&&(j.name==="NotAllowedError"||j.name==="PermissionDeniedError"?(v(!0),t("Permisos de cámara denegados. Por favor, habilita los permisos en la configuración de tu navegador.")):j.name==="NotFoundError"?t("No se encontró ninguna cámara en tu dispositivo."):j.name==="NotReadableError"?t("La cámara está siendo usada por otra aplicación."):t("Error al acceder a la cámara. Intenta nuevamente.")),!1}},h=async()=>{try{if(t(null),!await p())return;const A=new xs(C);N.current=A;const W={fps:15,qrbox:{width:280,height:280},aspectRatio:1,experimentalFeatures:{useBarCodeDetectorIfSupported:!0},formatsToSupport:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]};await A.start({facingMode:"environment"},W,T=>{n(T)},T=>{}),f(!0),m.success("Cámara iniciada")}catch(j){console.error("Error starting scanner:",j),j instanceof Error&&(j.message.includes("Permission")?(v(!0),t("Permisos de cámara denegados. Por favor, habilita los permisos en la configuración de tu navegador.")):t("Error al iniciar la cámara. Verifica que hayas dado permisos y que no esté siendo usada por otra aplicación.")),m.error("Error al iniciar la cámara")}},o=async()=>{if(N.current)try{N.current.isScanning&&await N.current.stop(),N.current.clear()}catch(j){console.error("Error stopping scanner:",j)}finally{N.current=null,f(!1)}},n=j=>{g(j),d("success"),setTimeout(()=>{r(j),b()},800)},b=async()=>{await o(),g(null),t(null),v(!1),c(!1)},k=()=>{t(null),v(!1),h()};return e.jsx(ye,{open:i,onOpenChange:b,children:e.jsxs(je,{className:"sm:max-w-[500px]",children:[e.jsxs(Ne,{children:[e.jsxs(ve,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5 text-primary"}),"Escanear Código de Barras"]}),e.jsx(_e,{children:l?"Hubo un problema al acceder a la cámara":"Apunta la cámara al código de barras del producto"})]}),e.jsxs("div",{className:"space-y-4",children:[!l&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-black min-h-[300px]",children:[e.jsx("div",{id:C,className:"w-full"}),e.jsx(B,{children:x&&e.jsx(E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-success/90 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(E.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",duration:.5},children:e.jsx(K,{className:"w-16 h-16 mx-auto mb-4"})}),e.jsx("p",{className:"text-xl font-semibold",children:"¡Código detectado!"}),e.jsx("p",{className:"text-sm mt-2 font-mono",children:x})]})})})]}),l&&e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ze,{className:"w-6 h-6 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-destructive mb-2",children:"Error de Cámara"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:l}),y&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 mb-4",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2 font-semibold",children:"Cómo habilitar permisos:"}),e.jsxs("ul",{className:"text-xs text-muted-foreground space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"Chrome: Toca el ícono de candado en la barra de dirección"}),e.jsxs("li",{children:["Safari: Ve a Configuración ",">"," Safari ",">"," Cámara"]}),e.jsx("li",{children:"Firefox: Toca el ícono de información en la barra de dirección"})]})]}),e.jsx(P,{onClick:k,variant:"outline",size:"sm",className:"w-full",children:"Reintentar"})]})]})}),!l&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Mantén el código de barras dentro del cuadro de escaneo"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-2",children:"Funciona con códigos EAN, UPC, QR y más"})]}),e.jsxs(P,{onClick:b,variant:"outline",className:"w-full",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),"Cancelar"]})]})]})})}function bs({onSelect:i,placeholder:c="Buscar producto por nombre o EAN...",className:r}){const[u,f]=s.useState(""),[x,g]=s.useState([]),[l,t]=s.useState(!1),[y,v]=s.useState(0),N=s.useRef(null),C=s.useRef(null);s.useEffect(()=>{const o=setTimeout(async()=>{if(u.trim().length>=2)try{const n=await ss(u,8);g(n),t(n.length>0),v(0)}catch(n){console.error("Error searching products:",n),g([])}else g([]),t(!1)},300);return()=>clearTimeout(o)},[u]),s.useEffect(()=>{const o=n=>{var b;C.current&&!C.current.contains(n.target)&&!((b=N.current)!=null&&b.contains(n.target))&&t(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const d=o=>{if(!(!l||x.length===0))switch(o.key){case"ArrowDown":o.preventDefault(),v(n=>(n+1)%x.length);break;case"ArrowUp":o.preventDefault(),v(n=>(n-1+x.length)%x.length);break;case"Enter":o.preventDefault(),x[y]&&p(x[y]);break;case"Escape":t(!1);break}},p=o=>{var n;i(o),f(""),g([]),t(!1),(n=N.current)==null||n.blur()},h=(o,n)=>n.trim()?o.split(new RegExp(`(${n})`,"gi")).map((k,j)=>k.toLowerCase()===n.toLowerCase()?e.jsx("mark",{className:"bg-primary/20 text-primary font-semibold",children:k},j):k):o;return e.jsxs("div",{className:w("relative",r),children:[e.jsxs("div",{className:"relative",children:[e.jsx(ps,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"}),e.jsx(H,{ref:N,type:"text",value:u,onChange:o=>f(o.target.value),onKeyDown:d,onFocus:()=>{x.length>0&&t(!0)},placeholder:c,className:"pl-10 pr-4"})]}),e.jsx(B,{children:l&&x.length>0&&e.jsxs(E.div,{ref:C,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2},className:"absolute z-50 w-full mt-2 bg-card border border-border rounded-lg shadow-lg elevation-3 max-h-[400px] overflow-y-auto",children:[e.jsx("div",{className:"p-2 space-y-1",children:x.map((o,n)=>e.jsx(E.button,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:n*.05},onClick:()=>p(o),onMouseEnter:()=>v(n),className:w("w-full text-left p-3 rounded-lg transition-colors","hover:bg-primary hover:text-primary-foreground","focus:outline-none focus:ring-2 focus:ring-ring",y===n&&"bg-primary text-primary-foreground"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:w("p-2 rounded-lg flex-shrink-0",y===n?"bg-primary-foreground/20":"bg-muted"),children:e.jsx(U,{className:w("w-5 h-5",y===n?"text-primary-foreground":"text-muted-foreground")})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:h(o.name,u)}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs("span",{className:w("text-xs font-mono",y===n?"text-primary-foreground/80":"text-muted-foreground"),children:["EAN: ",h(o.ean,u)]}),o.salePrice>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:w("text-xs",y===n?"text-primary-foreground/60":"text-muted-foreground"),children:"•"}),e.jsxs("span",{className:w("text-xs font-semibold",y===n?"text-primary-foreground/80":"text-muted-foreground"),children:["$",o.salePrice.toLocaleString()]})]})]})]})]})},o.ean))}),e.jsx("div",{className:"border-t border-border p-2 bg-muted/30",children:e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Usa ↑↓ para navegar, Enter para seleccionar"})})]})}),l&&u.trim().length>=2&&x.length===0&&e.jsx(E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"absolute z-50 w-full mt-2 bg-card border border-border rounded-lg shadow-lg p-4",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"No se encontraron productos"})})]})}const ws=Ke,Cs=Je,Pe=s.forwardRef(({className:i,...c},r)=>e.jsx(ue,{className:w("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...c,ref:r}));Pe.displayName=ue.displayName;const ke=s.forwardRef(({className:i,...c},r)=>e.jsxs(Cs,{children:[e.jsx(Pe,{}),e.jsx(xe,{ref:r,className:w("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...c})]}));ke.displayName=xe.displayName;const De=({className:i,...c})=>e.jsx("div",{className:w("flex flex-col space-y-2 text-center sm:text-left",i),...c});De.displayName="AlertDialogHeader";const ze=({className:i,...c})=>e.jsx("div",{className:w("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",i),...c});ze.displayName="AlertDialogFooter";const Ae=s.forwardRef(({className:i,...c},r)=>e.jsx(fe,{ref:r,className:w("text-lg font-semibold",i),...c}));Ae.displayName=fe.displayName;const Ie=s.forwardRef(({className:i,...c},r)=>e.jsx(ge,{ref:r,className:w("text-sm text-muted-foreground",i),...c}));Ie.displayName=ge.displayName;const Fe=s.forwardRef(({className:i,...c},r)=>e.jsx(pe,{ref:r,className:w(be(),i),...c}));Fe.displayName=pe.displayName;const Le=s.forwardRef(({className:i,...c},r)=>e.jsx(he,{ref:r,className:w(be({variant:"outline"}),"mt-2 sm:mt-0",i),...c}));Le.displayName=he.displayName;function Ss({children:i,onDelete:c,onEdit:r,className:u,threshold:f=60}){const x=fs(0),[g,l]=s.useState(!1),t=G(x,[-f,0],[1,0]),y=G(x,[0,f],[0,1]),v=G(x,[-f,0,f],["rgba(239, 68, 68, 0.2)","rgba(0,0,0,0)","rgba(59, 130, 246, 0.2)"]),{trigger:N}=Ee(),[C,d]=s.useState(!1),p=(o,n)=>{l(!1),d(!1),n.offset.x<-f&&c?c():n.offset.x>f&&r&&r()},h=(o,n)=>{const b=n.offset.x;C?b>-f&&b<f&&d(!1):(b<-f||b>f)&&(N("selection"),d(!0))};return e.jsxs("div",{className:w("relative overflow-hidden rounded-xl",u),children:[e.jsxs(E.div,{className:"absolute inset-0 flex items-center justify-between px-4 pointer-events-none",style:{backgroundColor:v},children:[e.jsxs(E.div,{style:{opacity:y},className:"flex items-center text-blue-500",children:[e.jsx(Se,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"Editar"})]}),e.jsxs(E.div,{style:{opacity:t},className:"flex items-center text-red-500",children:[e.jsx("span",{className:"font-medium mr-2",children:"Eliminar"}),e.jsx(we,{className:"w-5 h-5"})]})]}),e.jsx(E.div,{drag:"x",dragConstraints:{left:0,right:0},dragElastic:.7,onDragStart:()=>l(!0),onDrag:h,onDragEnd:p,style:{x,touchAction:"none"},className:"relative bg-card z-10",whileTap:{cursor:"grabbing"},children:i})]})}function Es({items:i,onUpdate:c,onDelete:r}){const[u,f]=s.useState(null),[x,g]=s.useState(""),[l,t]=s.useState(null),y=d=>{f(d.id),g(d.quantity.toString())},v=()=>{if(u&&x){const d=parseInt(x,10);d>0&&(c(u,d),f(null),g(""))}},N=()=>{f(null),g("")},C=()=>{l&&(r(l),t(null))};return i.length===0?e.jsxs(R,{className:"p-8 text-center",children:[e.jsx(U,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No hay productos agregados aún"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Escanea o busca productos para comenzar"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:e.jsx(B,{mode:"popLayout",children:i.map((d,p)=>e.jsx(E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,x:-100},transition:{delay:p*.05},layout:!0,children:e.jsx(Ss,{className:"mb-3",onEdit:()=>y(d),onDelete:()=>t(d.id),children:e.jsx(R,{className:"p-4 hover:shadow-md transition-shadow border-0 rounded-none sm:rounded-xl sm:border",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg flex-shrink-0",children:e.jsx(U,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground truncate",children:d.productName}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:["EAN: ",d.ean]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"•"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ns,{className:"w-3 h-3 text-muted-foreground"}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:[d.quantity," uds."]})]})]}),d.synced===0&&e.jsxs("span",{className:"inline-flex items-center gap-1 mt-2 px-2 py-0.5 bg-warning/10 text-warning text-xs rounded-full",children:[e.jsx("span",{className:"w-1.5 h-1.5 bg-warning rounded-full"}),"Pendiente de sincronizar"]})]}),e.jsxs("div",{className:"hidden sm:flex items-center gap-2 flex-shrink-0",children:[e.jsx(P,{size:"sm",variant:"ghost",onClick:()=>y(d),className:"hover:bg-primary hover:text-primary-foreground",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx(P,{size:"sm",variant:"ghost",onClick:()=>t(d.id),className:"hover:bg-destructive hover:text-destructive-foreground",children:e.jsx(we,{className:"w-4 h-4"})})]})]})})})},d.id))})}),e.jsx(ye,{open:u!==null,onOpenChange:d=>!d&&N(),children:e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx(ve,{children:"Editar Cantidad"})}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground mb-2 block",children:"Nueva cantidad"}),e.jsx(H,{type:"number",min:"1",value:x,onChange:d=>g(d.target.value),onKeyDown:d=>{d.key==="Enter"&&v()},placeholder:"Ingresa la cantidad",autoFocus:!0})]})}),e.jsxs(as,{children:[e.jsx(P,{variant:"outline",onClick:N,children:"Cancelar"}),e.jsx(P,{onClick:v,disabled:!x||parseInt(x)<=0,children:"Guardar"})]})]})}),e.jsx(ws,{open:l!==null,onOpenChange:d=>!d&&t(null),children:e.jsxs(ke,{children:[e.jsxs(De,{children:[e.jsx(Ae,{children:"¿Eliminar producto?"}),e.jsx(Ie,{children:"Esta acción no se puede deshacer. El producto será eliminado del pre-conteo."})]}),e.jsxs(ze,{children:[e.jsx(Le,{children:"Cancelar"}),e.jsx(Fe,{onClick:C,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Eliminar"})]})]})})]})}function Ps(){const[i,c]=s.useState([]),[r,u]=s.useState(null),[f,x]=s.useState(!0);s.useEffect(()=>{(async()=>{try{await cs();const h=await ne();if(h){u(h);const o=await ie(h.sector);c(o)}}catch(h){console.error("Error initializing pre-count:",h),m.error("Error al inicializar el sistema de pre-conteo")}finally{x(!1)}})()},[]);const g=i.length,l=i.reduce((p,h)=>p+h.quantity,0);s.useEffect(()=>{r&&!r.endTime&&ts(r.id,{totalProducts:g,totalUnits:l}).catch(p=>{console.error("Error updating session:",p)})},[r,g,l]);const t=s.useCallback(async p=>{try{if(x(!0),await ne()){m.error("Ya existe una sesión activa. Por favor, finalízala primero.");return}const o=await rs(p);u(o),c([]),m.success(`Sesión iniciada para el sector: ${p}`)}catch(h){console.error("Error starting session:",h),m.error("Error al iniciar la sesión")}finally{x(!1)}},[]),y=s.useCallback(async(p,h,o)=>{if(!r){m.error("No hay una sesión activa");return}if(o<=0){m.error("La cantidad debe ser mayor a 0");return}try{const n=i.find(b=>b.ean===p);if(n){const b=n.quantity+o;await oe(n.id,{quantity:b}),c(k=>k.map(j=>j.id===n.id?{...j,quantity:b,synced:0}:j)),m.success(`Cantidad actualizada: ${h} (+${o})`)}else{const b=await ns({sector:r.sector,ean:p,productName:h,quantity:o});c(k=>[...k,b]),m.success(`Producto agregado: ${h}`)}}catch(n){console.error("Error adding item:",n),m.error("Error al agregar el producto")}},[r,i]),v=s.useCallback(async(p,h)=>{if(h<=0){m.error("La cantidad debe ser mayor a 0");return}try{await oe(p,{quantity:h}),c(o=>o.map(n=>n.id===p?{...n,quantity:h,synced:0}:n)),m.success("Cantidad actualizada")}catch(o){console.error("Error updating item:",o),m.error("Error al actualizar el producto")}},[]),N=s.useCallback(async p=>{try{await os(p),c(h=>h.filter(o=>o.id!==p)),m.success("Producto eliminado")}catch(h){console.error("Error removing item:",h),m.error("Error al eliminar el producto")}},[]),C=s.useCallback(async()=>{if(!r){m.error("No hay una sesión activa");return}try{await is(r.id),u(null),c([]),m.success("Sesión finalizada correctamente")}catch(p){console.error("Error finishing session:",p),m.error("Error al finalizar la sesión")}},[r]),d=s.useCallback(async()=>{if(r)try{const p=await ie(r.sector);c(p)}catch(p){console.error("Error refreshing items:",p),m.error("Error al actualizar los productos")}},[r]);return{items:i,session:r,totalProducts:g,totalUnits:l,isLoading:f,startSession:t,addItem:y,updateItem:v,removeItem:N,finishSession:C,refreshItems:d}}function ks(){const[i,c]=s.useState(navigator.onLine),[r,u]=s.useState(!1),[f,x]=s.useState(0);s.useEffect(()=>{const t=()=>{c(!0),m.success("Conexión restaurada",{description:"Los datos se sincronizarán automáticamente"}),l()},y=()=>{c(!1),m.warning("Sin conexión",{description:"Los datos se guardarán localmente"})};return window.addEventListener("online",t),window.addEventListener("offline",y),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",y)}},[]);const g=s.useCallback(async()=>{try{const t=await ce();x(t.length)}catch(t){console.error("Error counting unsynced items:",t)}},[]);s.useEffect(()=>{g();const t=setInterval(g,3e4);return()=>clearInterval(t)},[g]);const l=s.useCallback(async()=>{if(!i){m.error("No hay conexión a internet");return}if(!r)try{u(!0);const t=await ce();if(t.length===0){m.info("No hay datos pendientes de sincronización");return}console.log("Syncing items:",t),await new Promise(v=>setTimeout(v,1e3));const y=t.map(v=>v.id);await ls(y),await g(),m.success("Sincronización completada",{description:`${t.length} productos sincronizados`})}catch(t){console.error("Error syncing data:",t),m.error("Error al sincronizar datos",{description:"Se reintentará automáticamente"})}finally{u(!1)}},[i,r,g]);return s.useEffect(()=>{if(i&&f>0&&!r){const t=setTimeout(()=>{l()},2e3);return()=>clearTimeout(t)}},[i,f,r,l]),{isOnline:i,isSyncing:r,unsyncedCount:f,syncNow:l}}function Ds({actions:i,className:c}){const[r,u]=s.useState(!0),[f,x]=s.useState(0);return s.useEffect(()=>{const g=()=>{const l=window.scrollY;l<f||l<50?u(!0):l>f&&l>50&&u(!1),x(l)};return window.addEventListener("scroll",g,{passive:!0}),()=>window.removeEventListener("scroll",g)},[f]),e.jsx(B,{children:r&&e.jsx(E.div,{initial:{y:100,opacity:0},animate:{y:0,opacity:1},exit:{y:100,opacity:0},transition:{duration:.3},className:w("fixed bottom-24 right-6 flex flex-col gap-3 z-40",c),children:i.map((g,l)=>e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{className:"bg-background/80 backdrop-blur-sm text-foreground text-xs font-medium px-2 py-1 rounded-md shadow-sm",children:g.label}),e.jsx(P,{variant:g.variant||"default",size:"icon",className:"h-12 w-12 rounded-full shadow-lg",onClick:g.onClick,children:g.icon})]},l))})})}function Vs(){const i=Xe(),[c,r]=s.useState("config"),[u,f]=s.useState(""),[x,g]=s.useState(!1),[l,t]=s.useState(""),[y,v]=s.useState("1"),[N,C]=s.useState(null),{items:d,session:p,totalProducts:h,totalUnits:o,isLoading:n,startSession:b,addItem:k,updateItem:j,removeItem:A,finishSession:W}=Ps(),{isOnline:T,isSyncing:X,unsyncedCount:_,syncNow:Te}=ks(),Z=async()=>{if(!u.trim()){m.error("Por favor, ingresa el nombre del sector");return}await b(u.trim()),r("counting")},Oe=async a=>{try{const S=await le(a);S?(C(S),t(a),m.success(`Producto encontrado: ${S.name}`)):(t(a),m.warning("Producto no encontrado en la base de datos",{description:"Puedes agregarlo manualmente"}))}catch(S){console.error("Error fetching product:",S),m.error("Error al buscar el producto")}},Re=a=>{C(a),t(a.ean)},He=async()=>{if(!l.trim()){m.error("Por favor, ingresa o escanea un código EAN");return}const a=parseInt(y,10);if(isNaN(a)||a<=0){m.error("Por favor, ingresa una cantidad válida");return}let S=N==null?void 0:N.name;if(!S)try{const I=await le(l.trim());I&&(S=I.name)}catch(I){console.error("Error fetching product by EAN:",I)}S||(S=`Producto ${l}`),await k(l,S,a),t(""),v("1"),C(null)},Be=async()=>{if(d.length===0){m.error("No hay productos para finalizar");return}await W(),i("/stock")},Me=()=>{if(d.length===0){m.error("No hay productos para exportar");return}try{const a=new hs,S=a.internal.pageSize.getWidth(),I=a.internal.pageSize.getHeight(),D=10,V=3,Y=3,O=(S-D*2-Y*(V-1))/V,M=28;let F=D,z=D+15;a.setFontSize(14),a.text(`Pre-Conteo: ${u}`,D,D+5),a.setFontSize(8),a.text(`Fecha: ${new Date().toLocaleDateString()}`,S-D-30,D+5),d.forEach((q,Ue)=>{z+M>I-D&&(a.addPage(),z=D),a.setDrawColor(200),a.setLineWidth(.1),a.roundedRect(F,z,O,M,2,2,"S");const ee=O-4,We=F+2,Ve=z+5;a.setFontSize(9),a.setFont("helvetica","bold");let $=q.productName;if(a.getTextWidth($)>ee){const L=Math.floor(ee/2);$=$.substring(0,L)+"..."}a.text($,We,Ve);const Ye=O*.65,Qe=15,se=F+2,ae=z+8,Q=document.createElement("canvas");try{const L={displayValue:!0,fontSize:14,fontOptions:"bold",margin:0,height:40,width:2,background:"#ffffff",lineColor:"#000000",textMargin:0};try{me(Q,q.ean,{...L,format:"EAN13"})}catch{me(Q,q.ean,{...L,format:"CODE128"})}const Ge=Q.toDataURL("image/png");a.addImage(Ge,"PNG",se,ae,Ye,Qe)}catch(L){console.error("Error generating barcode:",L),a.setFontSize(8),a.setTextColor(255,0,0),a.text("Error Barcode",se,ae+10),a.setTextColor(0,0,0)}const te=F+O-2,re=z+M-6;a.setFontSize(24),a.setFont("helvetica","bold"),a.text(q.quantity.toString(),te,re,{align:"right"}),a.setFontSize(6),a.setFont("helvetica","normal"),a.setTextColor(100),a.text("CANT",te,re-10,{align:"right"}),a.setTextColor(0),(Ue+1)%V===0?(F=D,z+=M+Y):F+=O+Y});const $e=`PreConteo_${u}_${new Date().toISOString().split("T")[0]}.pdf`;a.save($e),m.success("PDF generado correctamente")}catch(a){console.error("Error generating PDF:",a),m.error("Error al generar el PDF")}},qe=async()=>{await us([{ean:"7790001234567",name:"Shampoo Dove 400ml",cost:850,salePrice:1200},{ean:"7790002345678",name:"Acondicionador Pantene 300ml",cost:920,salePrice:1350},{ean:"7790003456789",name:"Jabón Dove 90g",cost:180,salePrice:280},{ean:"7790004567890",name:"Desodorante Rexona 150ml",cost:650,salePrice:950},{ean:"7790005678901",name:"Crema Dental Colgate 90g",cost:420,salePrice:620},{ean:"7790006789012",name:"Enjuague Bucal Listerine 500ml",cost:1100,salePrice:1580},{ean:"7790007890123",name:"Papel Higiénico Elite x4",cost:890,salePrice:1250},{ean:"7790008901234",name:"Toallas Femeninas Always x8",cost:520,salePrice:780},{ean:"7790009012345",name:"Pañales Pampers M x30",cost:3200,salePrice:4500},{ean:"7790010123456",name:"Algodón Estrella 100g",cost:280,salePrice:420}]),m.success("Productos de ejemplo cargados")};return n?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando..."})]})}):e.jsxs(e.Fragment,{children:[e.jsxs(E.div,{className:"space-y-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4},children:[e.jsxs("div",{className:"flex items-start sm:items-center justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>c==="config"?i("/stock"):r("config"),className:"flex-shrink-0",children:e.jsx(ys,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Pre-Conteo Sucursal"}),p&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Sector: ",e.jsx("span",{className:"font-semibold text-foreground",children:p.sector})]})]})]}),e.jsx("div",{className:"flex items-center gap-2 flex-shrink-0",children:T?e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-success/10 text-success rounded-full text-sm",children:[e.jsx(gs,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium hidden sm:inline",children:"En línea"})]}):e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-warning/10 text-warning rounded-full text-sm",children:[e.jsx(ds,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium hidden sm:inline",children:"Sin conexión"})]})})]}),e.jsx(B,{mode:"wait",children:c==="config"?e.jsx(E.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.3},className:"max-w-2xl mx-auto",children:e.jsx(R,{className:"p-6 sm:p-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-flex p-4 bg-primary/10 rounded-2xl mb-4",children:e.jsx(U,{className:"w-12 h-12 text-primary"})}),e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-foreground mb-2",children:"Configuración del Pre-Conteo"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Ingresa el nombre del sector o estantería que vas a contar"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Nombre del Sector / Estantería *"}),e.jsx(H,{type:"text",value:u,onChange:a=>f(a.target.value),onKeyDown:a=>{a.key==="Enter"&&Z()},placeholder:"Ej: Bebidas, Perfumería, Góndola 1, etc.",className:"text-base sm:text-lg",autoFocus:!0})]}),e.jsx(P,{onClick:Z,disabled:!u.trim(),className:"w-full",size:"lg",children:"Comenzar Pre-Conteo"}),e.jsx(P,{onClick:qe,variant:"outline",className:"w-full",size:"sm",children:"Cargar productos de ejemplo"})]})]})})},"config"):e.jsxs(E.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.3},className:"space-y-4 sm:space-y-6",children:[e.jsx(R,{className:"p-6 sm:p-8 bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20 elevation-2",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Llevas"}),e.jsx("div",{className:"text-5xl sm:text-6xl font-bold text-primary mb-2",children:e.jsx(de,{value:h})}),e.jsxs("p",{className:"text-xl sm:text-2xl font-semibold text-foreground",children:[h===1?"producto":"productos"," pre-contados"]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:["Total de unidades: ",e.jsx("span",{className:"font-semibold text-foreground",children:e.jsx(de,{value:o})})]})]})}),e.jsxs(R,{className:"p-4 sm:p-6 elevation-1",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-foreground mb-4",children:"Agregar Producto"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(P,{onClick:()=>g(!0),className:"w-full",size:"lg",variant:"default",children:[e.jsx(Ce,{className:"w-5 h-5 mr-2"}),"Escanear Código de Barras"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"O busca manualmente"})})]}),e.jsx(bs,{onSelect:Re,placeholder:"Buscar producto por nombre o EAN..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Código EAN"}),e.jsx(H,{type:"text",value:l,onChange:a=>t(a.target.value),placeholder:"Ingresa el código EAN"}),N&&e.jsxs("p",{className:"text-sm text-success mt-1 flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"}),N.name]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Cantidad"}),e.jsx(H,{type:"number",min:"1",value:y,onChange:a=>v(a.target.value),placeholder:"Cantidad"})]}),e.jsxs(P,{onClick:He,disabled:!l.trim()||!y,className:"w-full",size:"lg",children:[e.jsx(js,{className:"w-5 h-5 mr-2"}),"Guardar y Siguiente"]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold text-foreground",children:["Productos Agregados (",h,")"]}),_>0&&e.jsx(P,{onClick:Te,disabled:!T||X,variant:"outline",size:"sm",className:"flex-shrink-0",children:X?"Sincronizando...":`Sincronizar (${_})`})]}),e.jsx(Es,{items:d,onUpdate:j,onDelete:A})]})]},"counting")})]}),d.length>0&&c==="counting"&&e.jsx(Ds,{actions:[{icon:e.jsx(ms,{className:"w-5 h-5"}),label:"Exportar a PDF",onClick:Me},{icon:e.jsx(K,{className:"w-5 h-5"}),label:"Finalizar Pre-Conteo",onClick:Be}]}),e.jsx(vs,{open:x,onOpenChange:g,onScan:Oe},x?"open":"closed")]})}export{Vs as default};
