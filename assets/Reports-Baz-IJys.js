import{j as e}from"./ui-vendor-DWmIoBIJ.js";import{r as n,u as $e,L as ze}from"./react-vendor-ylmX0jv_.js";import{c as _e,a2 as Be,v as x,S as ae,B as N,Q as H,g as re,D as Ae,y as Oe,q as We,r as qe,s as He,t as Ue,Z as Me,a3 as Ge}from"./index-CJYpoDa2.js";import{I as V}from"./input-BFvecGr2.js";import{T as le,a as oe,b as P,c as h,d as ne,e as u}from"./table-CQqbkDmj.js";import{T as Je,a as Qe,b as ce,c as ie}from"./tabs-B7uIO1zI.js";import{L as de,E as Xe}from"./jspdf.es.min-BBOjawGR.js";import{J as xe}from"./JsBarcode-BPRqDEDi.js";import{u as T,w as Ye}from"./excel-uoQkVabA.js";import Ze from"./html2canvas.esm-CBrSDip1.js";import{f as Ke}from"./utils-CUsTgaRG.js";import{e as es,C as me,E as ss}from"./es-Cy8Ywqla.js";import{M as ts}from"./map-pin-Crz2R4P4.js";import"./animation-Ch0GoCcm.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=_e("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),he=n.forwardRef(({report:d},I)=>{if(!d)return null;const $=d.results.allShortages.sort((l,o)=>l.diffValue-o.diffValue).slice(0,15),z=d.results.allSurpluses.sort((l,o)=>o.diffValue-l.diffValue).slice(0,15),F=d.results.allShortages.reduce((l,o)=>l+o.diffValue,0),b=d.results.allSurpluses.reduce((l,o)=>l+o.diffValue,0),g=F+b;return e.jsxs("div",{ref:I,className:"bg-white p-8 w-[800px] text-black font-sans",children:[e.jsx("div",{className:"border-b-2 border-primary pb-4 mb-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary",children:"Reporte de Inventario"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Farmaplus Gestión"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("h2",{className:"text-xl font-semibold",children:d.branch}),e.jsx("p",{className:"text-gray-600",children:d.sector}),e.jsx("p",{className:"text-sm text-gray-500",children:Ke(new Date(d.date),"PPP",{locale:es})})]})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border border-red-100",children:[e.jsx("p",{className:"text-sm text-red-600 font-medium",children:"Total Faltante"}),e.jsxs("p",{className:"text-2xl font-bold text-red-700",children:["$",Math.abs(F).toLocaleString("es-AR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-100",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Total Sobrante"}),e.jsxs("p",{className:"text-2xl font-bold text-green-700",children:["$",b.toLocaleString("es-AR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:`p-4 rounded-lg border ${g<0?"bg-orange-50 border-orange-100":"bg-blue-50 border-blue-100"}`,children:[e.jsx("p",{className:`text-sm font-medium ${g<0?"text-orange-600":"text-blue-600"}`,children:"Diferencia Neta"}),e.jsxs("p",{className:`text-2xl font-bold ${g<0?"text-orange-700":"text-blue-700"}`,children:["$",g.toLocaleString("es-AR",{minimumFractionDigits:2})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-red-700 border-l-4 border-red-500 pl-2",children:"Top 15 Faltantes (por valor)"}),e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 rounded-tl-lg",children:"Producto"}),e.jsx("th",{className:"p-2 text-right",children:"Cant."}),e.jsx("th",{className:"p-2 text-right rounded-tr-lg",children:"Valor"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:$.map((l,o)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-2 truncate max-w-[250px]",children:l.name}),e.jsx("td",{className:"p-2 text-right font-medium text-red-600",children:l.diffQty}),e.jsxs("td",{className:"p-2 text-right font-medium text-red-600",children:["$",l.diffValue.toLocaleString("es-AR",{minimumFractionDigits:2})]})]},o))})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-green-700 border-l-4 border-green-500 pl-2",children:"Top 15 Sobrantes (por valor)"}),e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 rounded-tl-lg",children:"Producto"}),e.jsx("th",{className:"p-2 text-right",children:"Cant."}),e.jsx("th",{className:"p-2 text-right rounded-tr-lg",children:"Valor"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:z.map((l,o)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-2 truncate max-w-[250px]",children:l.name}),e.jsxs("td",{className:"p-2 text-right font-medium text-green-600",children:["+",l.diffQty]}),e.jsxs("td",{className:"p-2 text-right font-medium text-green-600",children:["$",l.diffValue.toLocaleString("es-AR",{minimumFractionDigits:2})]})]},o))})]})]})]}),e.jsxs("div",{className:"mt-8 pt-4 border-t text-center text-xs text-gray-400",children:["Generado por Farmaplus PWA - ",new Date().toLocaleString()]})]})});he.displayName="ReportTemplate";function js(){$e();const[d,I]=n.useState("pre-count"),[$,z]=n.useState([]),[F,b]=n.useState(!0),[g,l]=n.useState(""),[o,ue]=n.useState(null),[_,ge]=n.useState([]),[U,M]=n.useState(!1),[fe,B]=n.useState(!1),[p,G]=n.useState([]),[J,pe]=n.useState([]),[v,je]=n.useState(""),[S,Ne]=n.useState(""),[y,be]=n.useState(""),A=n.useRef(null),[ve,Q]=n.useState(null);n.useEffect(()=>{Se(),Ce()},[]);const Se=async()=>{try{b(!0);const a=(await Be()).filter(t=>t.endTime).sort((t,m)=>m.startTime-t.startTime);z(a)}catch(s){console.error("Error loading sessions:",s),x.error("Error al cargar el historial de pre-conteos")}finally{b(!1)}},ye=async s=>{ue(s),B(!0),M(!0);try{const a=await Ge(s);ge(a)}catch(a){console.error("Error loading session items:",a),x.error("Error al cargar los detalles")}finally{M(!1)}},X=$.filter(s=>s.sector.toLowerCase().includes(g.toLowerCase())),we=(s,a)=>{if(a.length===0){x.error("No hay productos para exportar");return}try{const t=new Xe,m=t.internal.pageSize.getWidth(),i=t.internal.pageSize.getHeight(),r=10,c=3,O=3,C=(m-r*2-O*(c-1))/c,L=28;let j=r,f=r+15;t.setFontSize(14),t.text(`Pre-Conteo: ${s.sector}`,r,r+5),t.setFontSize(8),t.text(`Fecha: ${new Date(s.startTime).toLocaleDateString()}`,m-r-30,r+5),a.forEach((D,Ve)=>{f+L>i-r&&(t.addPage(),f=r),t.setDrawColor(200),t.setLineWidth(.1),t.roundedRect(j,f,C,L,2,2,"S");const Y=C-4,Pe=j+2,Ie=f+5;t.setFontSize(9),t.setFont("helvetica","bold");let R=D.productName;if(t.getTextWidth(R)>Y){const k=Math.floor(Y/2);R=R.substring(0,k)+"..."}t.text(R,Pe,Ie);const Z=C*.65,K=15,W=j+2,q=f+8,E=document.createElement("canvas");try{xe(E,D.ean,{format:"EAN13",displayValue:!0,fontSize:14,fontOptions:"bold",margin:0,height:40,width:2,background:"#ffffff",lineColor:"#000000",textMargin:0});const k=E.toDataURL("image/png");t.addImage(k,"PNG",W,q,Z,K)}catch{try{xe(E,D.ean,{format:"CODE128",displayValue:!0,fontSize:14,fontOptions:"bold",margin:0,height:40,width:2,background:"#ffffff",lineColor:"#000000",textMargin:0});const te=E.toDataURL("image/png");t.addImage(te,"PNG",W,q,Z,K)}catch{t.setFontSize(8),t.text(D.ean,W,q+10)}}const ee=j+C-2,se=f+L-6;t.setFontSize(24),t.setFont("helvetica","bold"),t.text(D.quantity.toString(),ee,se,{align:"right"}),t.setFontSize(6),t.setFont("helvetica","normal"),t.setTextColor(100),t.text("CANT",ee,se-10,{align:"right"}),t.setTextColor(0),(Ve+1)%c===0?(j=r,f+=L+O):j+=C+O});const ke=`PreConteo_${s.sector}_${new Date(s.startTime).toISOString().split("T")[0]}.pdf`;t.save(ke),x.success("PDF generado correctamente")}catch(t){console.error("Error generating PDF:",t),x.error("Error al generar el PDF")}},Ce=()=>{const s=JSON.parse(localStorage.getItem("inventory-reports")||"[]");G(s),w(s,v,S,y)},w=(s,a,t,m)=>{let i=s;a&&(i=i.filter(r=>r.name.toLowerCase().includes(a.toLowerCase())||r.branch.toLowerCase().includes(a.toLowerCase())||r.sector.toLowerCase().includes(a.toLowerCase()))),t&&(i=i.filter(r=>r.branch.toLowerCase().includes(t.toLowerCase()))),m&&(i=i.filter(r=>r.sector.toLowerCase().includes(m.toLowerCase()))),pe(i.reverse())},De=s=>{je(s),w(p,s,S,y)},Te=s=>{Ne(s),w(p,v,s,y)},Fe=s=>{be(s),w(p,v,S,s)},Le=s=>{const a=p.filter(t=>t.id!==s);G(a),localStorage.setItem("inventory-reports",JSON.stringify(a)),w(a,v,S,y),x.success("Reporte eliminado")},Re=s=>{try{const a=r=>r.map(c=>({"Código de Barras":c.codebar,Producto:c.name,"Diferencia (Unidades)":c.diffQty,"Valor Diferencia ($)":c.diffValue,"Stock Sistema":c.systemStock,"Conteo Físico":c.physicalCount,"Costo Unitario ($)":c.cost,"Precio Venta ($)":c.salePrice})),t=s.results.allShortages.sort((r,c)=>r.diffValue-c.diffValue).slice(0,15),m=s.results.allSurpluses.sort((r,c)=>c.diffValue-r.diffValue).slice(0,15),i=T.book_new();T.book_append_sheet(i,T.json_to_sheet(a(t)),"Faltantes"),T.book_append_sheet(i,T.json_to_sheet(a(m)),"Sobrantes"),Ye(i,`Reporte_${s.name}_${s.date}.xlsx`),x.success("Reporte exportado correctamente")}catch{x.error("Error al exportar el reporte")}},Ee=async s=>{Q(s),setTimeout(async()=>{if(A.current)try{const a=await Ze(A.current,{scale:2,backgroundColor:"#ffffff"}),t=document.createElement("a");t.download=`Reporte_${s.name}_${s.date}.png`,t.href=a.toDataURL("image/png"),t.click(),x.success("Imagen generada correctamente")}catch(a){console.error("Error generating image:",a),x.error("Error al generar la imagen")}finally{Q(null)}},100)};return e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsx("div",{className:"flex-1 overflow-hidden p-6",children:e.jsxs(Je,{value:d,onValueChange:I,className:"h-full flex flex-col",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-2 max-w-[400px] mb-4",children:[e.jsx(ce,{value:"pre-count",children:"Pre-Conteos"}),e.jsx(ce,{value:"audits",children:"Auditorías"})]}),e.jsxs(ie,{value:"pre-count",className:"flex-1 overflow-hidden flex flex-col data-[state=inactive]:hidden",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative w-full max-w-xs sm:max-w-sm",children:[e.jsx(ae,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(V,{placeholder:"Buscar por sector...",value:g,onChange:s=>l(s.target.value),className:"pl-9 h-9 bg-muted/50 border-0"})]})}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-xl bg-card shadow-sm",children:F?e.jsxs("div",{className:"flex flex-col items-center justify-center p-12 text-center text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Cargando historial..."})]}):X.length>0?e.jsxs(le,{children:[e.jsx(oe,{className:"bg-muted/50",children:e.jsxs(P,{children:[e.jsx(h,{children:"Sector"}),e.jsx(h,{children:"Fecha"}),e.jsx(h,{className:"text-right",children:"Productos"}),e.jsx(h,{className:"text-right",children:"Unidades"}),e.jsx(h,{className:"w-[100px]"})]})}),e.jsx(ne,{children:X.map(s=>e.jsxs(P,{className:"hover:bg-muted/50",children:[e.jsx(u,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-muted-foreground"}),s.sector]})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(me,{className:"w-4 h-4"}),new Date(s.startTime).toLocaleDateString()]})}),e.jsx(u,{className:"text-right font-mono",children:s.totalProducts}),e.jsx(u,{className:"text-right font-mono",children:s.totalUnits}),e.jsx(u,{children:e.jsxs(N,{variant:"ghost",size:"sm",onClick:()=>ye(s),children:[e.jsx(ss,{className:"w-4 h-4 mr-2"}),"Ver"]})})]},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center p-12 text-center text-muted-foreground",children:[e.jsx(H,{className:"w-12 h-12 mb-4 opacity-20"}),e.jsx("p",{children:"No hay conteos finalizados aún."})]})})]}),e.jsxs(ie,{value:"audits",className:"flex-1 overflow-hidden flex flex-col data-[state=inactive]:hidden",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(V,{placeholder:"Buscar reporte...",value:v,onChange:s=>De(s.target.value),className:"pl-8"})]}),e.jsx(V,{placeholder:"Filtrar por sucursal...",value:S,onChange:s=>Te(s.target.value)}),e.jsx(V,{placeholder:"Filtrar por sector...",value:y,onChange:s=>Fe(s.target.value)})]}),e.jsx("div",{className:"flex-1 overflow-auto",children:J.length===0?e.jsxs(re,{className:"p-12 text-center",children:[e.jsx(H,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground",children:p.length===0?"Sin reportes aún":"Sin resultados"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:p.length===0?"Los reportes de 'Importar Inventario' aparecerán aquí":"Intenta con otros filtros de búsqueda"})]}):e.jsx("div",{className:"space-y-3",children:J.map(s=>e.jsx(ze,{to:`/reports/${s.id}`,className:"block hover:bg-muted/50 rounded-lg transition-colors",children:e.jsx(re,{className:"p-4 cursor-pointer",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:s.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ts,{className:"h-4 w-4"}),e.jsx("span",{children:s.branch})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx("span",{children:s.sector})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString("es-ES")})]})]})]}),e.jsxs("div",{className:"flex gap-2",onClick:a=>a.preventDefault(),children:[e.jsx(N,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"hover:bg-primary hover:text-primary-foreground",title:"Exportar como Imagen",children:e.jsx(as,{className:"h-4 w-4"})}),e.jsx(N,{size:"sm",variant:"outline",onClick:()=>Re(s),className:"hover:bg-success hover:text-success-foreground",title:"Exportar Excel",children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx(N,{size:"sm",variant:"outline",onClick:()=>Le(s.id),className:"hover:bg-destructive hover:text-destructive-foreground",title:"Eliminar",children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})})},s.id))})})]})]})}),e.jsx(We,{open:fe,onOpenChange:B,children:e.jsxs(qe,{className:"sm:max-w-4xl max-h-[90vh] flex flex-col",children:[e.jsxs(He,{children:[e.jsx(Ue,{children:"Detalle del Pre-Conteo"}),e.jsx(Me,{children:o&&e.jsxs("span",{children:["Sector: ",e.jsx("strong",{children:o.sector})," - Fecha: ",new Date(o.startTime).toLocaleString()]})})]}),e.jsx("div",{className:"flex-1 overflow-auto min-h-[300px] border rounded-md",children:U?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(le,{children:[e.jsx(oe,{className:"sticky top-0 bg-background",children:e.jsxs(P,{children:[e.jsx(h,{children:"EAN"}),e.jsx(h,{children:"Producto"}),e.jsx(h,{className:"text-right",children:"Cant."})]})}),e.jsx(ne,{children:_.map(s=>e.jsxs(P,{children:[e.jsx(u,{className:"font-mono text-xs",children:s.ean}),e.jsx(u,{className:"text-sm",children:s.productName}),e.jsx(u,{className:"text-right font-bold",children:s.quantity})]},s.id))})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t mt-auto",children:[e.jsxs(N,{variant:"outline",onClick:()=>o&&we(o,_),disabled:U||_.length===0,children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Descargar PDF"]}),e.jsx(N,{onClick:()=>B(!1),children:"Cerrar"})]})]})}),e.jsx("div",{className:"fixed left-[-9999px] top-0",children:e.jsx(he,{ref:A,report:ve})})]})}export{js as default};
