import{j as e}from"./ui-vendor-B9YtwGJ-.js";import{r as o,u as _e,L as Ae}from"./react-vendor-DdjUaGoS.js";import{c as U,Y as Be,v as x,B as p,I as q,C as le,M as Me,q as Oe,D as He,h as We,i as qe,j as Ue,N as Ge,Z as Je}from"./index-CfsGIlE1.js";import{I as P}from"./input-BNQlWmVc.js";import{T as oe,a as ne,b as I,c as h,d as ce,e as u}from"./table-DiohXEtS.js";import{T as Ye,a as Qe,b as ie,c as de}from"./tabs-BjkYCD-G.js";import{L as xe,E as Xe}from"./jspdf.es.min-Cm0kf70i.js";import{J as me}from"./JsBarcode-B9pOLHC9.js";import{u as T,w as Ze}from"./excel-uoQkVabA.js";import Ke from"./html2canvas.esm-CBrSDip1.js";import{f as es}from"./utils-CUsTgaRG.js";import{e as ss}from"./es-S38CIuc0.js";import{A as ts}from"./arrow-left-DrhDRTh-.js";import{S as he}from"./search-DovExvO1.js";import{M as as}from"./map-pin-D1gQ6aQo.js";import"./animation-CvwzMRXu.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=U("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=U("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=U("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),ge=o.forwardRef(({report:d},$)=>{if(!d)return null;const z=d.results.allShortages.sort((l,c)=>l.diffValue-c.diffValue).slice(0,15),_=d.results.allSurpluses.sort((l,c)=>c.diffValue-l.diffValue).slice(0,15),k=d.results.allShortages.reduce((l,c)=>l+c.diffValue,0),F=d.results.allSurpluses.reduce((l,c)=>l+c.diffValue,0),g=k+F;return e.jsxs("div",{ref:$,className:"bg-white p-8 w-[800px] text-black font-sans",children:[e.jsx("div",{className:"border-b-2 border-primary pb-4 mb-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary",children:"Reporte de Inventario"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Farmaplus Gestión"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("h2",{className:"text-xl font-semibold",children:d.branch}),e.jsx("p",{className:"text-gray-600",children:d.sector}),e.jsx("p",{className:"text-sm text-gray-500",children:es(new Date(d.date),"PPP",{locale:ss})})]})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border border-red-100",children:[e.jsx("p",{className:"text-sm text-red-600 font-medium",children:"Total Faltante"}),e.jsxs("p",{className:"text-2xl font-bold text-red-700",children:["$",Math.abs(k).toLocaleString("es-AR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-100",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Total Sobrante"}),e.jsxs("p",{className:"text-2xl font-bold text-green-700",children:["$",F.toLocaleString("es-AR",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:`p-4 rounded-lg border ${g<0?"bg-orange-50 border-orange-100":"bg-blue-50 border-blue-100"}`,children:[e.jsx("p",{className:`text-sm font-medium ${g<0?"text-orange-600":"text-blue-600"}`,children:"Diferencia Neta"}),e.jsxs("p",{className:`text-2xl font-bold ${g<0?"text-orange-700":"text-blue-700"}`,children:["$",g.toLocaleString("es-AR",{minimumFractionDigits:2})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-red-700 border-l-4 border-red-500 pl-2",children:"Top 15 Faltantes (por valor)"}),e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 rounded-tl-lg",children:"Producto"}),e.jsx("th",{className:"p-2 text-right",children:"Cant."}),e.jsx("th",{className:"p-2 text-right rounded-tr-lg",children:"Valor"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:z.map((l,c)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-2 truncate max-w-[250px]",children:l.name}),e.jsx("td",{className:"p-2 text-right font-medium text-red-600",children:l.diffQty}),e.jsxs("td",{className:"p-2 text-right font-medium text-red-600",children:["$",l.diffValue.toLocaleString("es-AR",{minimumFractionDigits:2})]})]},c))})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-green-700 border-l-4 border-green-500 pl-2",children:"Top 15 Sobrantes (por valor)"}),e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 rounded-tl-lg",children:"Producto"}),e.jsx("th",{className:"p-2 text-right",children:"Cant."}),e.jsx("th",{className:"p-2 text-right rounded-tr-lg",children:"Valor"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:_.map((l,c)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"p-2 truncate max-w-[250px]",children:l.name}),e.jsxs("td",{className:"p-2 text-right font-medium text-green-600",children:["+",l.diffQty]}),e.jsxs("td",{className:"p-2 text-right font-medium text-green-600",children:["$",l.diffValue.toLocaleString("es-AR",{minimumFractionDigits:2})]})]},c))})]})]})]}),e.jsxs("div",{className:"mt-8 pt-4 border-t text-center text-xs text-gray-400",children:["Generado por Farmaplus PWA - ",new Date().toLocaleString()]})]})});ge.displayName="ReportTemplate";function ys(){const d=_e(),[$,z]=o.useState("pre-count"),[_,k]=o.useState([]),[F,g]=o.useState(!0),[l,c]=o.useState(""),[b,fe]=o.useState(null),[A,pe]=o.useState([]),[G,J]=o.useState(!1),[je,B]=o.useState(!1),[j,Y]=o.useState([]),[Q,Ne]=o.useState([]),[v,be]=o.useState(""),[y,ve]=o.useState(""),[S,ye]=o.useState(""),M=o.useRef(null),[Se,X]=o.useState(null);o.useEffect(()=>{we(),Te()},[]);const we=async()=>{try{g(!0);const a=(await Be()).filter(t=>t.endTime).sort((t,m)=>m.startTime-t.startTime);k(a)}catch(s){console.error("Error loading sessions:",s),x.error("Error al cargar el historial de pre-conteos")}finally{g(!1)}},Ce=async s=>{fe(s),B(!0),J(!0);try{const a=await Je(s);pe(a)}catch(a){console.error("Error loading session items:",a),x.error("Error al cargar los detalles")}finally{J(!1)}},Z=_.filter(s=>s.sector.toLowerCase().includes(l.toLowerCase())),De=(s,a)=>{if(a.length===0){x.error("No hay productos para exportar");return}try{const t=new Xe,m=t.internal.pageSize.getWidth(),i=t.internal.pageSize.getHeight(),r=10,n=3,O=3,C=(m-r*2-O*(n-1))/n,L=28;let N=r,f=r+15;t.setFontSize(14),t.text(`Pre-Conteo: ${s.sector}`,r,r+5),t.setFontSize(8),t.text(`Fecha: ${new Date(s.startTime).toLocaleDateString()}`,m-r-30,r+5),a.forEach((D,Ie)=>{f+L>i-r&&(t.addPage(),f=r),t.setDrawColor(200),t.setLineWidth(.1),t.roundedRect(N,f,C,L,2,2,"S");const K=C-4,$e=N+2,ze=f+5;t.setFontSize(9),t.setFont("helvetica","bold");let R=D.productName;if(t.getTextWidth(R)>K){const V=Math.floor(K/2);R=R.substring(0,V)+"..."}t.text(R,$e,ze);const ee=C*.65,se=15,H=N+2,W=f+8,E=document.createElement("canvas");try{me(E,D.ean,{format:"EAN13",displayValue:!0,fontSize:14,fontOptions:"bold",margin:0,height:40,width:2,background:"#ffffff",lineColor:"#000000",textMargin:0});const V=E.toDataURL("image/png");t.addImage(V,"PNG",H,W,ee,se)}catch{try{me(E,D.ean,{format:"CODE128",displayValue:!0,fontSize:14,fontOptions:"bold",margin:0,height:40,width:2,background:"#ffffff",lineColor:"#000000",textMargin:0});const re=E.toDataURL("image/png");t.addImage(re,"PNG",H,W,ee,se)}catch{t.setFontSize(8),t.text(D.ean,H,W+10)}}const te=N+C-2,ae=f+L-6;t.setFontSize(24),t.setFont("helvetica","bold"),t.text(D.quantity.toString(),te,ae,{align:"right"}),t.setFontSize(6),t.setFont("helvetica","normal"),t.setTextColor(100),t.text("CANT",te,ae-10,{align:"right"}),t.setTextColor(0),(Ie+1)%n===0?(N=r,f+=L+O):N+=C+O});const Pe=`PreConteo_${s.sector}_${new Date(s.startTime).toISOString().split("T")[0]}.pdf`;t.save(Pe),x.success("PDF generado correctamente")}catch(t){console.error("Error generating PDF:",t),x.error("Error al generar el PDF")}},Te=()=>{const s=JSON.parse(localStorage.getItem("inventory-reports")||"[]");Y(s),w(s,v,y,S)},w=(s,a,t,m)=>{let i=s;a&&(i=i.filter(r=>r.name.toLowerCase().includes(a.toLowerCase())||r.branch.toLowerCase().includes(a.toLowerCase())||r.sector.toLowerCase().includes(a.toLowerCase()))),t&&(i=i.filter(r=>r.branch.toLowerCase().includes(t.toLowerCase()))),m&&(i=i.filter(r=>r.sector.toLowerCase().includes(m.toLowerCase()))),Ne(i.reverse())},ke=s=>{be(s),w(j,s,y,S)},Fe=s=>{ve(s),w(j,v,s,S)},Le=s=>{ye(s),w(j,v,y,s)},Re=s=>{const a=j.filter(t=>t.id!==s);Y(a),localStorage.setItem("inventory-reports",JSON.stringify(a)),w(a,v,y,S),x.success("Reporte eliminado")},Ee=s=>{try{const a=r=>r.map(n=>({"Código de Barras":n.codebar,Producto:n.name,"Diferencia (Unidades)":n.diffQty,"Valor Diferencia ($)":n.diffValue,"Stock Sistema":n.systemStock,"Conteo Físico":n.physicalCount,"Costo Unitario ($)":n.cost,"Precio Venta ($)":n.salePrice})),t=s.results.allShortages.sort((r,n)=>r.diffValue-n.diffValue).slice(0,15),m=s.results.allSurpluses.sort((r,n)=>n.diffValue-r.diffValue).slice(0,15),i=T.book_new();T.book_append_sheet(i,T.json_to_sheet(a(t)),"Faltantes"),T.book_append_sheet(i,T.json_to_sheet(a(m)),"Sobrantes"),Ze(i,`Reporte_${s.name}_${s.date}.xlsx`),x.success("Reporte exportado correctamente")}catch{x.error("Error al exportar el reporte")}},Ve=async s=>{X(s),setTimeout(async()=>{if(M.current)try{const a=await Ke(M.current,{scale:2,backgroundColor:"#ffffff"}),t=document.createElement("a");t.download=`Reporte_${s.name}_${s.date}.png`,t.href=a.toDataURL("image/png"),t.click(),x.success("Imagen generada correctamente")}catch(a){console.error("Error generating image:",a),x.error("Error al generar la imagen")}finally{X(null)}},100)};return e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsx("header",{className:"sticky top-0 z-10 bg-background/95 backdrop-blur border-b px-4 h-16 flex items-center justify-between shrink-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>d(-1),className:"md:hidden",children:e.jsx(ts,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Reportes"}),e.jsx("p",{className:"text-xs text-muted-foreground hidden sm:block",children:"Historial de auditorías y conteos"})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden p-4 sm:p-6",children:e.jsxs(Ye,{value:$,onValueChange:z,className:"h-full flex flex-col",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-2 max-w-[400px] mb-4",children:[e.jsx(ie,{value:"pre-count",children:"Pre-Conteos"}),e.jsx(ie,{value:"audits",children:"Auditorías"})]}),e.jsxs(de,{value:"pre-count",className:"flex-1 overflow-hidden flex flex-col data-[state=inactive]:hidden",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative w-full max-w-xs sm:max-w-sm",children:[e.jsx(he,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(P,{placeholder:"Buscar por sector...",value:l,onChange:s=>c(s.target.value),className:"pl-9 h-9 bg-muted/50 border-0"})]})}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-xl bg-card shadow-sm",children:F?e.jsxs("div",{className:"flex flex-col items-center justify-center p-12 text-center text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"}),e.jsx("p",{children:"Cargando historial..."})]}):Z.length>0?e.jsxs(oe,{children:[e.jsx(ne,{className:"bg-muted/50",children:e.jsxs(I,{children:[e.jsx(h,{children:"Sector"}),e.jsx(h,{children:"Fecha"}),e.jsx(h,{className:"text-right",children:"Productos"}),e.jsx(h,{className:"text-right",children:"Unidades"}),e.jsx(h,{className:"w-[100px]"})]})}),e.jsx(ce,{children:Z.map(s=>e.jsxs(I,{className:"hover:bg-muted/50",children:[e.jsx(u,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-muted-foreground"}),s.sector]})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ue,{className:"w-4 h-4"}),new Date(s.startTime).toLocaleDateString()]})}),e.jsx(u,{className:"text-right font-mono",children:s.totalProducts}),e.jsx(u,{className:"text-right font-mono",children:s.totalUnits}),e.jsx(u,{children:e.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>Ce(s),children:[e.jsx(rs,{className:"w-4 h-4 mr-2"}),"Ver"]})})]},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center p-12 text-center text-muted-foreground",children:[e.jsx(q,{className:"w-12 h-12 mb-4 opacity-20"}),e.jsx("p",{children:"No hay conteos finalizados aún."})]})})]}),e.jsxs(de,{value:"audits",className:"flex-1 overflow-hidden flex flex-col data-[state=inactive]:hidden",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(P,{placeholder:"Buscar reporte...",value:v,onChange:s=>ke(s.target.value),className:"pl-8"})]}),e.jsx(P,{placeholder:"Filtrar por sucursal...",value:y,onChange:s=>Fe(s.target.value)}),e.jsx(P,{placeholder:"Filtrar por sector...",value:S,onChange:s=>Le(s.target.value)})]}),e.jsx("div",{className:"flex-1 overflow-auto",children:Q.length===0?e.jsxs(le,{className:"p-12 text-center",children:[e.jsx(q,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground",children:j.length===0?"Sin reportes aún":"Sin resultados"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:j.length===0?"Los reportes de 'Importar Inventario' aparecerán aquí":"Intenta con otros filtros de búsqueda"})]}):e.jsx("div",{className:"space-y-3",children:Q.map(s=>e.jsx(Ae,{to:`/reports/${s.id}`,className:"block hover:bg-muted/50 rounded-lg transition-colors",children:e.jsx(le,{className:"p-4 cursor-pointer",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:s.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),e.jsx("span",{children:s.branch})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{children:s.sector})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString("es-ES")})]})]})]}),e.jsxs("div",{className:"flex gap-2",onClick:a=>a.preventDefault(),children:[e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Ve(s),className:"hover:bg-primary hover:text-primary-foreground",title:"Exportar como Imagen",children:e.jsx(ls,{className:"h-4 w-4"})}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Ee(s),className:"hover:bg-success hover:text-success-foreground",title:"Exportar Excel",children:e.jsx(Me,{className:"h-4 w-4"})}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Re(s.id),className:"hover:bg-destructive hover:text-destructive-foreground",title:"Eliminar",children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})})},s.id))})})]})]})}),e.jsx(He,{open:je,onOpenChange:B,children:e.jsxs(We,{className:"sm:max-w-4xl max-h-[90vh] flex flex-col",children:[e.jsxs(qe,{children:[e.jsx(Ue,{children:"Detalle del Pre-Conteo"}),e.jsx(Ge,{children:b&&e.jsxs("span",{children:["Sector: ",e.jsx("strong",{children:b.sector})," - Fecha: ",new Date(b.startTime).toLocaleString()]})})]}),e.jsx("div",{className:"flex-1 overflow-auto min-h-[300px] border rounded-md",children:G?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(oe,{children:[e.jsx(ne,{className:"sticky top-0 bg-background",children:e.jsxs(I,{children:[e.jsx(h,{children:"EAN"}),e.jsx(h,{children:"Producto"}),e.jsx(h,{className:"text-right",children:"Cant."})]})}),e.jsx(ce,{children:A.map(s=>e.jsxs(I,{children:[e.jsx(u,{className:"font-mono text-xs",children:s.ean}),e.jsx(u,{className:"text-sm",children:s.productName}),e.jsx(u,{className:"text-right font-bold",children:s.quantity})]},s.id))})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t mt-auto",children:[e.jsxs(p,{variant:"outline",onClick:()=>b&&De(b,A),disabled:G||A.length===0,children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"Descargar PDF"]}),e.jsx(p,{onClick:()=>B(!1),children:"Cerrar"})]})]})}),e.jsx("div",{className:"fixed left-[-9999px] top-0",children:e.jsx(ge,{ref:M,report:Se})})]})}export{ys as default};
