const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CRCrhKU4.js","assets/ui-vendor-CwIRxpyq.js","assets/react-vendor-ylmX0jv_.js","assets/utils-DNiwW225.js","assets/animation-DbfETv0H.js","assets/excel-uoQkVabA.js","assets/index-BmMVIMfE.css"])))=>i.map(i=>d[i]);
import{c as b,s as l,ae as f,af as h,ag as p}from"./index-CRCrhKU4.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=b("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),q={getLabInventory:async(o,n)=>{try{const{data:t,error:a}=await l.from("inventories").select(`
                    id,
                    ean,
                    quantity,
                    system_quantity,
                    status,
                    was_readjusted,
                    products (
                        name,
                        cost,
                        category
                    )
                `).eq("branch_name",o).eq("laboratory",n);return a?(console.error(`Error loading inventory for ${n}:`,a),[]):t.map(r=>{var s,c,e;return{id:r.id,ean:r.ean,name:((s=r.products)==null?void 0:s.name)||"Desconocido",systemQuantity:r.system_quantity||0,countedQuantity:r.quantity,cost:((c=r.products)==null?void 0:c.cost)||0,status:r.status,category:(e=r.products)==null?void 0:e.category,wasReadjusted:r.was_readjusted}})}catch(t){return console.error(`Error loading inventory for ${n}`,t),[]}},saveInventory:async(o,n,t)=>{try{const a=t.map(s=>({branch_name:o,laboratory:n,ean:s.ean,quantity:s.countedQuantity,system_quantity:s.systemQuantity,status:s.status,was_readjusted:s.wasReadjusted||!1}));await l.from("inventories").delete().eq("branch_name",o).eq("laboratory",n);const{error:r}=await l.from("inventories").insert(a);if(r)throw r}catch(a){throw console.error("Error saving inventory:",a),a}},deleteInventory:async(o,n)=>{const{error:t}=await l.from("inventories").delete().eq("branch_name",o).eq("laboratory",n);if(t)throw console.error("Error deleting inventory:",t),t},calculateStats:o=>{let n=0,t=0,a=0,r=0,s=0,c=0;o.forEach(u=>{if(u.status==="controlled"||u.status==="adjusted"){a++;const d=u.countedQuantity-u.systemQuantity,g=d*u.cost;c+=u.systemQuantity,d<0?(n+=g,r+=d):d>0&&(t+=g,s+=d)}});const e=o.length;let i="pendiente";a===e&&e>0?i="controlado":a>0&&(i="por_controlar");const y=e>0?a/e*100:0,_=e>0?Number(y.toFixed(1)):0;return{negative:n,positive:t,net:n+t,progress:_,status:i,negativeUnits:r,positiveUnits:s,netUnits:r+s,totalSystemUnits:c}},getAllCyclicInventories:async o=>{let n=l.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                    name,
                    cost,
                    category
                )
            `);o&&(n=n.eq("branch_name",o));const{data:t,error:a}=await n;if(a||!t)return[];const r={};t.forEach(c=>{var i,y,_;const e=c.laboratory||"Desconocido";r[e]||(r[e]=[]),r[e].push({id:"",ean:"",name:((i=c.products)==null?void 0:i.name)||"",systemQuantity:c.system_quantity||0,countedQuantity:c.quantity,cost:((y=c.products)==null?void 0:y.cost)||0,status:c.status,category:(_=c.products)==null?void 0:_.category})});const s=[];return Object.entries(r).forEach(([c,e])=>{var _;const i=q.calculateStats(e),y=((_=e[0])==null?void 0:_.category)||"Varios";s.push({labName:c,category:y,status:i.status,totalItems:e.length,controlledItems:Math.round(i.progress/100*e.length),progress:i.progress,negativeValue:i.negative,positiveValue:i.positive,netValue:e.reduce((u,d)=>u+d.countedQuantity*d.cost,0),differenceValue:i.net,totalSystemUnits:i.totalSystemUnits,negativeUnits:i.negativeUnits,positiveUnits:i.positiveUnits,netUnits:i.netUnits})}),s},getBranchesSummary:async()=>{const{data:o,error:n}=await l.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                     cost
                )
            `);if(n||!o)return console.error("Error fetching branches summary:",n),[];let t={};const{data:a,error:r}=await l.from("branch_goals").select("branch_name, total_labs_goal");!r&&a&&a.length>0?a.forEach(e=>{t[e.branch_name]=e.total_labs_goal}):(console.warn("No goals found in Supabase, falling back to Excel or 0."),t=await f());const s={};return h.forEach(e=>{s[e]={totalSystemUnits:0,netUnits:0,netValue:0,controlledLabs:new Set,totalLabsInDB:new Set}}),o.forEach(e=>{var _;const i=(e.branch_name||"").trim();if(!i)return;const y=h.find(u=>u.toLowerCase()===i.toLowerCase());if(y){const u=s[y],d=e.laboratory||"Unknown",g=e.quantity||0,m=e.system_quantity||0,v=((_=e.products)==null?void 0:_.cost)||0;u.totalSystemUnits+=m,u.netUnits+=g-m,u.netValue+=(g-m)*v,u.totalLabsInDB.add(d),e.status==="controlado"&&u.controlledLabs.add(d)}}),h.map(e=>{const i=s[e],y=t[e]||0,_=i.controlledLabs.size,u=y>0?_/y*100:0,d=y>0?Number(u.toFixed(1)):0;let g="pendiente";return _>=y&&y>0?g="controlado":_>0&&(g="por_controlar"),{branchName:e,deploymentDate:"01/12/2025",cyclicRound:1,monthlyGoal:y,elapsedDays:12,progress:d,inventoryUnits:i.totalSystemUnits,differenceUnits:i.netUnits,adjustmentsValue:i.netValue,status:g}}).sort((e,i)=>i.progress-e.progress)},getBranchConfig:async o=>{var e;const{data:n}=await l.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_");if(!n||n.length===0)return{days:0,startDate:null};const t=n,a=t.find(i=>i.ean==="CONFIG_DAYS"),r=t.find(i=>i.ean==="CONFIG_START_DATE"),s=a?a.quantity:((e=t[0])==null?void 0:e.ean)==="CONFIG_DAYS"?t[0].quantity:0;let c=null;return r&&r.quantity&&(c=new Date(r.quantity*1e3).toISOString()),{days:s,startDate:c}},saveBranchConfig:async(o,n,t)=>{const a=o.trim();try{await p(()=>import("./index-CRCrhKU4.js").then(e=>e.aC),__vite__mapDeps([0,1,2,3,4,5,6])).then(e=>e.ensureConfigProduct());const{error:r}=await l.from("inventories").delete().eq("branch_name",a).eq("laboratory","_CONFIG_");r&&console.error("Error deleting old config:",r);const s=[{laboratory:"_CONFIG_",branch_name:a,ean:"CONFIG_DAYS",quantity:n,system_quantity:0,status:"pending"}];if(t){const e=Math.floor(new Date(t).getTime()/1e3);s.push({laboratory:"_CONFIG_",branch_name:a,ean:"CONFIG_START_DATE",quantity:e,system_quantity:0,status:"pending"})}const{error:c}=await l.from("inventories").insert(s);if(c)throw c}catch(r){throw console.error("Error saving branch config:",r),r}},saveAdjustmentHistory:async(o,n,t)=>{try{const{error:a}=await l.from("inventory_adjustments").insert({branch_name:o,laboratory:n,adjustment_id_shortage:t.adjustment_id_shortage,adjustment_id_surplus:t.adjustment_id_surplus,shortage_value:t.shortage_value,surplus_value:t.surplus_value,total_units_adjusted:t.total_units_adjusted,user_name:t.user_name||"Desconocido"});if(a)throw a;if(t.items_snapshot){const r={net_value:t.adjustment_id_surplus?t.surplus_value:-t.shortage_value,shortage_value:t.shortage_value,surplus_value:t.surplus_value,adjustment_ids:{shortage:t.adjustment_id_shortage,surplus:t.adjustment_id_surplus}},{error:s}=await l.from("inventory_reports").insert({branch_name:o,laboratory:n,snapshot_data:t.items_snapshot,financial_summary:r,user_name:t.user_name||"Desconocido"});s&&console.error("Error saving advanced report snapshot:",s)}}catch(a){throw console.error("Error saving history:",a),a}},getAdjustmentHistory:async(o,n)=>{const{data:t,error:a}=await l.from("inventory_adjustments").select("*").eq("branch_name",o).eq("laboratory",n).order("created_at",{ascending:!1});return a?(console.error("Error fetching history:",a),[]):t},saveCycleClosure:async(o,n,t)=>{try{await p(()=>import("./index-CRCrhKU4.js").then(s=>s.aC),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>s.ensureConfigProduct());const a=t.map(s=>({laboratory:"_CONFIG_",branch_name:o,ean:`CLOSURE_${n}_${s.name.toUpperCase()}`,quantity:Math.round(s.percentage),system_quantity:0,status:"pending"}));await l.from("inventories").delete().eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${n}_%`);const{error:r}=await l.from("inventories").insert(a);if(r)throw r}catch(a){throw console.error(`Error saving closure for period ${n}:`,a),a}},getCycleClosures:async(o,n=1)=>{const{data:t,error:a}=await l.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${n}_%`);if(a||!t)return{};const r={};return t.forEach(s=>{const c=s.ean.replace(`CLOSURE_${n}_`,"");r[c]=s.quantity}),r},migrateGoalsFromExcel:async()=>{try{console.log("Starting migration...");const o=await f(),n=Object.entries(o).map(([t,a])=>({branch_name:t,total_labs_goal:a,updated_at:new Date().toISOString()}));if(n.length>0){const{error:t}=await l.from("branch_goals").upsert(n,{onConflict:"branch_name"});if(t)throw t;console.log(`Migrated ${n.length} branch goals to Supabase.`)}}catch(o){throw console.error("Migration failed:",o),o}}};export{C as D,q as c};
