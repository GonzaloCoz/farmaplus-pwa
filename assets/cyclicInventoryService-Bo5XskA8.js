const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CkS_J3ry.js","assets/ui-vendor-DpWgbapL.js","assets/react-vendor-ylmX0jv_.js","assets/utils-B3_ieZWp.js","assets/animation-D5s1b1Vs.js","assets/excel-uoQkVabA.js","assets/index-BM-26IVw.css","assets/auditService-XpTAU5i3.js"])))=>i.map(i=>d[i]);
import{c as E,v as d,ag as b,y as p,ah as h}from"./index-CkS_J3ry.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=E("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),f={getLabInventory:async(o,r)=>{try{const{data:t,error:e}=await d.from("inventories").select(`
                    id,
                    ean,
                    quantity,
                    system_quantity,
                    status,
                    was_readjusted,
                    products (
                        name,
                        cost,
                        category
                    )
                `).eq("branch_name",o).eq("laboratory",r);return e?(console.error(`Error loading inventory for ${r}:`,e),[]):t.map(n=>{var s,c,a;return{id:n.id,ean:n.ean,name:((s=n.products)==null?void 0:s.name)||"Desconocido",systemQuantity:n.system_quantity||0,countedQuantity:n.quantity,cost:((c=n.products)==null?void 0:c.cost)||0,status:n.status,category:(a=n.products)==null?void 0:a.category,wasReadjusted:n.was_readjusted}})}catch(t){return console.error(`Error loading inventory for ${r}`,t),[]}},saveInventory:async(o,r,t)=>{try{const e=t.map(s=>({branch_name:o,laboratory:r,ean:s.ean,quantity:s.countedQuantity,system_quantity:s.systemQuantity,status:s.status,was_readjusted:s.wasReadjusted||!1}));await d.from("inventories").delete().eq("branch_name",o).eq("laboratory",r);const{error:n}=await d.from("inventories").insert(e);if(n)throw n;await f.updateLabMetadata(o,r,t)}catch(e){throw console.error("Error saving inventory:",e),e}},deleteInventory:async(o,r)=>{const{error:t}=await d.from("inventories").delete().eq("branch_name",o).eq("laboratory",r);if(t)throw console.error("Error deleting inventory:",t),t},updateLabMetadata:async(o,r,t)=>{try{const e=f.calculateStats(t),n=t.filter(u=>u.status==="controlled").length,s=t.filter(u=>u.status==="adjusted").length,c=t.filter(u=>u.status==="pending").length;let a="pending";e.progress===100?a="completed":e.progress>0&&(a="in_progress");const{error:i}=await d.from("branch_laboratories").upsert({branch_name:o,laboratory:r,total_items:t.length,controlled_items:n,adjusted_items:s,pending_items:c,progress_percentage:e.progress,total_system_units:e.totalSystemUnits,net_units:e.netUnits,net_value:e.net,negative_value:e.negative,positive_value:e.positive,status:a},{onConflict:"branch_name,laboratory"});i&&console.error("Error updating lab metadata:",i)}catch(e){console.error("Error in updateLabMetadata:",e)}},calculateStats:o=>{let r=0,t=0,e=0,n=0,s=0,c=0;o.forEach(l=>{if(l.status==="controlled"||l.status==="adjusted"){e++;const y=l.countedQuantity-l.systemQuantity,g=y*l.cost;c+=l.systemQuantity,y<0?(r+=g,n+=y):y>0&&(t+=g,s+=y)}});const a=o.length;let i="pendiente";e===a&&a>0?i="controlado":e>0&&(i="por_controlar");const u=a>0?e/a*100:0,_=a>0?Number(u.toFixed(1)):0;return{negative:r,positive:t,net:r+t,progress:_,status:i,negativeUnits:n,positiveUnits:s,netUnits:n+s,totalSystemUnits:c}},getAllCyclicInventories:async o=>{let r=d.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                    name,
                    cost,
                    category
                )
            `);o&&(r=r.eq("branch_name",o));const{data:t,error:e}=await r;if(e||!t)return[];const n={};t.forEach(c=>{var i,u,_;const a=c.laboratory||"Desconocido";n[a]||(n[a]=[]),n[a].push({id:"",ean:"",name:((i=c.products)==null?void 0:i.name)||"",systemQuantity:c.system_quantity||0,countedQuantity:c.quantity,cost:((u=c.products)==null?void 0:u.cost)||0,status:c.status,category:(_=c.products)==null?void 0:_.category})});const s=[];return Object.entries(n).forEach(([c,a])=>{var _;const i=f.calculateStats(a),u=((_=a[0])==null?void 0:_.category)||"Varios";s.push({labName:c,category:u,status:i.status,totalItems:a.length,controlledItems:Math.round(i.progress/100*a.length),progress:i.progress,negativeValue:i.negative,positiveValue:i.positive,netValue:a.reduce((l,y)=>l+y.countedQuantity*y.cost,0),differenceValue:i.net,totalSystemUnits:i.totalSystemUnits,negativeUnits:i.negativeUnits,positiveUnits:i.positiveUnits,netUnits:i.netUnits})}),s},getBranchesSummary:async()=>{const{data:o,error:r}=await d.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                     cost
                )
            `);if(r||!o)return console.error("Error fetching branches summary:",r),[];let t={};const{data:e,error:n}=await d.from("branch_goals").select("branch_name, total_labs_goal");!n&&e&&e.length>0?e.forEach(a=>{t[a.branch_name]=a.total_labs_goal}):(console.warn("No goals found in Supabase, falling back to Excel or 0."),t=await b());const s={};return p.forEach(a=>{s[a]={totalSystemUnits:0,netUnits:0,netValue:0,controlledLabs:new Set,totalLabsInDB:new Set}}),o.forEach(a=>{var _;const i=(a.branch_name||"").trim();if(!i)return;const u=p.find(l=>l.toLowerCase()===i.toLowerCase());if(u){const l=s[u],y=a.laboratory||"Unknown",g=a.status==="adjusted"||a.status==="controlled",v=a.quantity||0,m=a.system_quantity||0,q=((_=a.products)==null?void 0:_.cost)||0;g&&(l.totalSystemUnits+=m,l.netUnits+=v-m,l.netValue+=(v-m)*q),l.totalLabsInDB.add(y),(a.status==="controlled"||a.status==="adjusted")&&l.controlledLabs.add(y)}}),p.map(a=>{const i=s[a],u=t[a]||0,_=i.controlledLabs.size,l=u>0?_/u*100:0,y=u>0?Number(l.toFixed(1)):0;let g="pendiente";return _>=u&&u>0?g="controlado":_>0&&(g="por_controlar"),{branchName:a,deploymentDate:"01/12/2025",cyclicRound:1,monthlyGoal:u,elapsedDays:12,progress:y,inventoryUnits:i.totalSystemUnits,differenceUnits:i.netUnits,adjustmentsValue:i.netValue,status:g}}).sort((a,i)=>i.progress-a.progress)},getBranchConfig:async o=>{var a;const{data:r}=await d.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_");if(!r||r.length===0)return{days:0,startDate:null};const t=r,e=t.find(i=>i.ean==="CONFIG_DAYS"),n=t.find(i=>i.ean==="CONFIG_START_DATE"),s=e?e.quantity:((a=t[0])==null?void 0:a.ean)==="CONFIG_DAYS"?t[0].quantity:0;let c=null;return n&&n.quantity&&(c=new Date(n.quantity*1e3).toISOString()),{days:s,startDate:c}},saveBranchConfig:async(o,r,t)=>{const e=o.trim();try{await h(()=>import("./index-CkS_J3ry.js").then(a=>a.aE),__vite__mapDeps([0,1,2,3,4,5,6])).then(a=>a.ensureConfigProduct());const{error:n}=await d.from("inventories").delete().eq("branch_name",e).eq("laboratory","_CONFIG_");n&&console.error("Error deleting old config:",n);const s=[{laboratory:"_CONFIG_",branch_name:e,ean:"CONFIG_DAYS",quantity:r,system_quantity:0,status:"pending"}];if(t){const a=Math.floor(new Date(t).getTime()/1e3);s.push({laboratory:"_CONFIG_",branch_name:e,ean:"CONFIG_START_DATE",quantity:a,system_quantity:0,status:"pending"})}const{error:c}=await d.from("inventories").insert(s);if(c)throw c}catch(n){throw console.error("Error saving branch config:",n),n}},saveAdjustmentHistory:async(o,r,t)=>{try{const{error:e}=await d.from("inventory_adjustments").insert({branch_name:o,laboratory:r,adjustment_id_shortage:t.adjustment_id_shortage,adjustment_id_surplus:t.adjustment_id_surplus,shortage_value:t.shortage_value,surplus_value:t.surplus_value,total_units_adjusted:t.total_units_adjusted,user_name:t.user_name||"Desconocido"});if(e)throw e;if(t.items_snapshot){const n={net_value:t.adjustment_id_surplus?t.surplus_value:-t.shortage_value,shortage_value:t.shortage_value,surplus_value:t.surplus_value,adjustment_ids:{shortage:t.adjustment_id_shortage,surplus:t.adjustment_id_surplus}},{error:s}=await d.from("inventory_reports").insert({branch_name:o,laboratory:r,snapshot_data:t.items_snapshot,financial_summary:n,user_name:t.user_name||"Desconocido"});s&&console.error("Error saving advanced report snapshot:",s)}try{await h(async()=>{const{auditService:n}=await import("./auditService-XpTAU5i3.js");return{auditService:n}},__vite__mapDeps([7,0,1,2,3,4,5,6])).then(({auditService:n})=>{n.logAction({action:"INVENTORY_ADJUSTMENT",entityType:"INVENTORY",branchId:o,userId:t.user_id,details:{lab:r,netValue:t.surplus_value-t.shortage_value,unitsAdjusted:t.total_units_adjusted}})})}catch{}}catch(e){throw console.error("Error saving history:",e),e}},getAdjustmentHistory:async(o,r)=>{const{data:t,error:e}=await d.from("inventory_adjustments").select("*").eq("branch_name",o).eq("laboratory",r).order("created_at",{ascending:!1});return e?(console.error("Error fetching history:",e),[]):t},saveCycleClosure:async(o,r,t)=>{try{await h(()=>import("./index-CkS_J3ry.js").then(s=>s.aE),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>s.ensureConfigProduct());const e=t.map(s=>({laboratory:"_CONFIG_",branch_name:o,ean:`CLOSURE_${r}_${s.name.toUpperCase()}`,quantity:Math.round(s.percentage),system_quantity:0,status:"pending"}));await d.from("inventories").delete().eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${r}_%`);const{error:n}=await d.from("inventories").insert(e);if(n)throw n;try{await h(async()=>{const{auditService:s}=await import("./auditService-XpTAU5i3.js");return{auditService:s}},__vite__mapDeps([7,0,1,2,3,4,5,6])).then(({auditService:s})=>{s.logAction({action:"CYCLE_CLOSURE",entityType:"SYSTEM",branchId:o,details:{period:r,categories:t}})})}catch{}}catch(e){throw console.error(`Error saving closure for period ${r}:`,e),e}},getCycleClosures:async(o,r=1)=>{const{data:t,error:e}=await d.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${r}_%`);if(e||!t)return{};const n={};return t.forEach(s=>{const c=s.ean.replace(`CLOSURE_${r}_`,"");n[c]=s.quantity}),n},migrateGoalsFromExcel:async()=>{try{console.log("Starting migration...");const o=await b(),r=Object.entries(o).map(([t,e])=>({branch_name:t,total_labs_goal:e,updated_at:new Date().toISOString()}));if(r.length>0){const{error:t}=await d.from("branch_goals").upsert(r,{onConflict:"branch_name"});if(t)throw t;console.log(`Migrated ${r.length} branch goals to Supabase.`)}}catch(o){throw console.error("Migration failed:",o),o}}};export{S as D,f as c};
