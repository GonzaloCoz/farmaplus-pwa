const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-88HeHBU_.js","assets/ui-vendor-CDeHCoCT.js","assets/react-vendor-ylmX0jv_.js","assets/utils-B3_ieZWp.js","assets/animation-b3c-J9zS.js","assets/excel-uoQkVabA.js","assets/index-C5Av2Cjs.css","assets/auditService-DZqFkZac.js"])))=>i.map(i=>d[i]);
import{c as b,v as l,ag as p,H as f,ah as h}from"./index-88HeHBU_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w=b("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),q={getLabInventory:async(o,r)=>{try{const{data:t,error:a}=await l.from("inventories").select(`
                    id,
                    ean,
                    quantity,
                    system_quantity,
                    status,
                    was_readjusted,
                    products (
                        name,
                        cost,
                        category
                    )
                `).eq("branch_name",o).eq("laboratory",r);return a?(console.error(`Error loading inventory for ${r}:`,a),[]):t.map(e=>{var s,c,n;return{id:e.id,ean:e.ean,name:((s=e.products)==null?void 0:s.name)||"Desconocido",systemQuantity:e.system_quantity||0,countedQuantity:e.quantity,cost:((c=e.products)==null?void 0:c.cost)||0,status:e.status,category:(n=e.products)==null?void 0:n.category,wasReadjusted:e.was_readjusted}})}catch(t){return console.error(`Error loading inventory for ${r}`,t),[]}},saveInventory:async(o,r,t)=>{try{const a=t.map(s=>({branch_name:o,laboratory:r,ean:s.ean,quantity:s.countedQuantity,system_quantity:s.systemQuantity,status:s.status,was_readjusted:s.wasReadjusted||!1}));await l.from("inventories").delete().eq("branch_name",o).eq("laboratory",r);const{error:e}=await l.from("inventories").insert(a);if(e)throw e}catch(a){throw console.error("Error saving inventory:",a),a}},deleteInventory:async(o,r)=>{const{error:t}=await l.from("inventories").delete().eq("branch_name",o).eq("laboratory",r);if(t)throw console.error("Error deleting inventory:",t),t},calculateStats:o=>{let r=0,t=0,a=0,e=0,s=0,c=0;o.forEach(u=>{if(u.status==="controlled"||u.status==="adjusted"){a++;const d=u.countedQuantity-u.systemQuantity,g=d*u.cost;c+=u.systemQuantity,d<0?(r+=g,e+=d):d>0&&(t+=g,s+=d)}});const n=o.length;let i="pendiente";a===n&&n>0?i="controlado":a>0&&(i="por_controlar");const y=n>0?a/n*100:0,_=n>0?Number(y.toFixed(1)):0;return{negative:r,positive:t,net:r+t,progress:_,status:i,negativeUnits:e,positiveUnits:s,netUnits:e+s,totalSystemUnits:c}},getAllCyclicInventories:async o=>{let r=l.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                    name,
                    cost,
                    category
                )
            `);o&&(r=r.eq("branch_name",o));const{data:t,error:a}=await r;if(a||!t)return[];const e={};t.forEach(c=>{var i,y,_;const n=c.laboratory||"Desconocido";e[n]||(e[n]=[]),e[n].push({id:"",ean:"",name:((i=c.products)==null?void 0:i.name)||"",systemQuantity:c.system_quantity||0,countedQuantity:c.quantity,cost:((y=c.products)==null?void 0:y.cost)||0,status:c.status,category:(_=c.products)==null?void 0:_.category})});const s=[];return Object.entries(e).forEach(([c,n])=>{var _;const i=q.calculateStats(n),y=((_=n[0])==null?void 0:_.category)||"Varios";s.push({labName:c,category:y,status:i.status,totalItems:n.length,controlledItems:Math.round(i.progress/100*n.length),progress:i.progress,negativeValue:i.negative,positiveValue:i.positive,netValue:n.reduce((u,d)=>u+d.countedQuantity*d.cost,0),differenceValue:i.net,totalSystemUnits:i.totalSystemUnits,negativeUnits:i.negativeUnits,positiveUnits:i.positiveUnits,netUnits:i.netUnits})}),s},getBranchesSummary:async()=>{const{data:o,error:r}=await l.from("inventories").select(`
                branch_name,
                laboratory,
                quantity,
                system_quantity,
                status,
                products (
                     cost
                )
            `);if(r||!o)return console.error("Error fetching branches summary:",r),[];let t={};const{data:a,error:e}=await l.from("branch_goals").select("branch_name, total_labs_goal");!e&&a&&a.length>0?a.forEach(n=>{t[n.branch_name]=n.total_labs_goal}):(console.warn("No goals found in Supabase, falling back to Excel or 0."),t=await p());const s={};return f.forEach(n=>{s[n]={totalSystemUnits:0,netUnits:0,netValue:0,controlledLabs:new Set,totalLabsInDB:new Set}}),o.forEach(n=>{var _;const i=(n.branch_name||"").trim();if(!i)return;const y=f.find(u=>u.toLowerCase()===i.toLowerCase());if(y){const u=s[y],d=n.laboratory||"Unknown",g=n.quantity||0,m=n.system_quantity||0,v=((_=n.products)==null?void 0:_.cost)||0;u.totalSystemUnits+=m,u.netUnits+=g-m,u.netValue+=(g-m)*v,u.totalLabsInDB.add(d),n.status==="controlado"&&u.controlledLabs.add(d)}}),f.map(n=>{const i=s[n],y=t[n]||0,_=i.controlledLabs.size,u=y>0?_/y*100:0,d=y>0?Number(u.toFixed(1)):0;let g="pendiente";return _>=y&&y>0?g="controlado":_>0&&(g="por_controlar"),{branchName:n,deploymentDate:"01/12/2025",cyclicRound:1,monthlyGoal:y,elapsedDays:12,progress:d,inventoryUnits:i.totalSystemUnits,differenceUnits:i.netUnits,adjustmentsValue:i.netValue,status:g}}).sort((n,i)=>i.progress-n.progress)},getBranchConfig:async o=>{var n;const{data:r}=await l.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_");if(!r||r.length===0)return{days:0,startDate:null};const t=r,a=t.find(i=>i.ean==="CONFIG_DAYS"),e=t.find(i=>i.ean==="CONFIG_START_DATE"),s=a?a.quantity:((n=t[0])==null?void 0:n.ean)==="CONFIG_DAYS"?t[0].quantity:0;let c=null;return e&&e.quantity&&(c=new Date(e.quantity*1e3).toISOString()),{days:s,startDate:c}},saveBranchConfig:async(o,r,t)=>{const a=o.trim();try{await h(()=>import("./index-88HeHBU_.js").then(n=>n.aE),__vite__mapDeps([0,1,2,3,4,5,6])).then(n=>n.ensureConfigProduct());const{error:e}=await l.from("inventories").delete().eq("branch_name",a).eq("laboratory","_CONFIG_");e&&console.error("Error deleting old config:",e);const s=[{laboratory:"_CONFIG_",branch_name:a,ean:"CONFIG_DAYS",quantity:r,system_quantity:0,status:"pending"}];if(t){const n=Math.floor(new Date(t).getTime()/1e3);s.push({laboratory:"_CONFIG_",branch_name:a,ean:"CONFIG_START_DATE",quantity:n,system_quantity:0,status:"pending"})}const{error:c}=await l.from("inventories").insert(s);if(c)throw c}catch(e){throw console.error("Error saving branch config:",e),e}},saveAdjustmentHistory:async(o,r,t)=>{try{const{error:a}=await l.from("inventory_adjustments").insert({branch_name:o,laboratory:r,adjustment_id_shortage:t.adjustment_id_shortage,adjustment_id_surplus:t.adjustment_id_surplus,shortage_value:t.shortage_value,surplus_value:t.surplus_value,total_units_adjusted:t.total_units_adjusted,user_name:t.user_name||"Desconocido"});if(a)throw a;if(t.items_snapshot){const e={net_value:t.adjustment_id_surplus?t.surplus_value:-t.shortage_value,shortage_value:t.shortage_value,surplus_value:t.surplus_value,adjustment_ids:{shortage:t.adjustment_id_shortage,surplus:t.adjustment_id_surplus}},{error:s}=await l.from("inventory_reports").insert({branch_name:o,laboratory:r,snapshot_data:t.items_snapshot,financial_summary:e,user_name:t.user_name||"Desconocido"});s&&console.error("Error saving advanced report snapshot:",s)}try{await h(async()=>{const{auditService:e}=await import("./auditService-DZqFkZac.js");return{auditService:e}},__vite__mapDeps([7,0,1,2,3,4,5,6])).then(({auditService:e})=>{e.logAction({action:"INVENTORY_ADJUSTMENT",entityType:"INVENTORY",branchId:o,userId:t.user_id,details:{lab:r,netValue:t.surplus_value-t.shortage_value,unitsAdjusted:t.total_units_adjusted}})})}catch{}}catch(a){throw console.error("Error saving history:",a),a}},getAdjustmentHistory:async(o,r)=>{const{data:t,error:a}=await l.from("inventory_adjustments").select("*").eq("branch_name",o).eq("laboratory",r).order("created_at",{ascending:!1});return a?(console.error("Error fetching history:",a),[]):t},saveCycleClosure:async(o,r,t)=>{try{await h(()=>import("./index-88HeHBU_.js").then(s=>s.aE),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>s.ensureConfigProduct());const a=t.map(s=>({laboratory:"_CONFIG_",branch_name:o,ean:`CLOSURE_${r}_${s.name.toUpperCase()}`,quantity:Math.round(s.percentage),system_quantity:0,status:"pending"}));await l.from("inventories").delete().eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${r}_%`);const{error:e}=await l.from("inventories").insert(a);if(e)throw e;try{await h(async()=>{const{auditService:s}=await import("./auditService-DZqFkZac.js");return{auditService:s}},__vite__mapDeps([7,0,1,2,3,4,5,6])).then(({auditService:s})=>{s.logAction({action:"CYCLE_CLOSURE",entityType:"SYSTEM",branchId:o,details:{period:r,categories:t}})})}catch{}}catch(a){throw console.error(`Error saving closure for period ${r}:`,a),a}},getCycleClosures:async(o,r=1)=>{const{data:t,error:a}=await l.from("inventories").select("ean, quantity").eq("branch_name",o).eq("laboratory","_CONFIG_").ilike("ean",`CLOSURE_${r}_%`);if(a||!t)return{};const e={};return t.forEach(s=>{const c=s.ean.replace(`CLOSURE_${r}_`,"");e[c]=s.quantity}),e},migrateGoalsFromExcel:async()=>{try{console.log("Starting migration...");const o=await p(),r=Object.entries(o).map(([t,a])=>({branch_name:t,total_labs_goal:a,updated_at:new Date().toISOString()}));if(r.length>0){const{error:t}=await l.from("branch_goals").upsert(r,{onConflict:"branch_name"});if(t)throw t;console.log(`Migrated ${r.length} branch goals to Supabase.`)}}catch(o){throw console.error("Migration failed:",o),o}}};export{w as D,q as c};
