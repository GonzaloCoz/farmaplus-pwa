import{a1 as w}from"./index-fkPGpu1p.js";let u;async function a(){return u=w("farmaplus-expiration",2,{upgrade(t,s,n,e){if(s<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const o=t.createObjectStore("items",{keyPath:"id"});o.createIndex("by-session","sessionId"),o.createIndex("by-ean","ean")}if(s<2){const i=e.objectStore("sessions");i.indexNames.contains("by-branch")||i.createIndex("by-branch","branchName")}}}),u}async function l(t,s){const n=await a(),e={id:crypto.randomUUID(),sector:t,branchName:s,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await n.put("sessions",e),e}async function b(t){return(await(await a()).getAllFromIndex("sessions","by-status","active")).find(i=>i.branchName===t)||null}async function p(t,s){const n=await a(),e=await n.get("sessions",t);e&&await n.put("sessions",{...e,...s})}async function x(t){await p(t,{status:"completed",endTime:Date.now()})}async function I(t,s){const n=await a(),e=await b(s);if(!e)throw new Error("No active expiration session");if((await n.getAllFromIndex("items","by-session",e.id)).find(r=>r.ean===t.ean))throw new Error("Item already exists in session. Use update.");const c={id:crypto.randomUUID(),sessionId:e.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((r,m)=>r+m.quantity,0),timestamp:Date.now(),synced:0};return await n.put("items",c),await d(e.id),c}async function g(t,s){const n=await a(),e=await n.get("items",t);if(e){const i={...e,...s};s.batches&&(i.totalQuantity=s.batches.reduce((o,c)=>o+c.quantity,0)),await n.put("items",i),await d(e.sessionId)}}async function S(t){const s=await a(),n=await s.get("items",t);n&&(await s.delete("items",t),await d(n.sessionId))}async function y(t){return(await a()).getAllFromIndex("items","by-session",t)}async function h(){return(await a()).getAll("items")}async function d(t){const s=await y(t),n=await a(),e=s.length,i=s.reduce((c,r)=>c+r.totalQuantity,0),o=await n.get("sessions",t);o&&await n.put("sessions",{...o,totalProducts:e,totalUnits:i})}export{b as a,y as b,l as c,I as d,S as e,x as f,h as g,g as u};
