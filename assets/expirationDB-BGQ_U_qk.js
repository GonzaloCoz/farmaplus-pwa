import{s}from"./index-DtE1zeX6.js";async function x(t,i){const e={sector:t,branch_name:i,start_time:Date.now(),status:"active",total_products:0,total_units:0},{data:a,error:n}=await s.from("expiration_sessions").insert(e).select().single();if(n)throw n;return f(a)}async function _(t){let i=s.from("expiration_sessions").select("*").eq("status","active");t&&(i=i.eq("branch_name",t));const{data:e,error:a}=await i.order("start_time",{ascending:!1});if(a)throw a;return e.map(f)}async function y(t){const{error:i}=await s.from("expiration_sessions").delete().eq("id",t);if(i)throw i}async function p(t){const i=await _(t);return i.length>0?i[0]:null}async function u(t,i){const e={};i.sector&&(e.sector=i.sector),i.status&&(e.status=i.status),i.endTime&&(e.end_time=i.endTime),i.totalProducts!==void 0&&(e.total_products=i.totalProducts),i.totalUnits!==void 0&&(e.total_units=i.totalUnits);const{error:a}=await s.from("expiration_sessions").update(e).eq("id",t);if(a)throw a}async function q(t){await u(t,{status:"completed",endTime:Date.now()})}async function g(t,i){const e=await p(i);if(!e)throw new Error("No active expiration session");const{data:a}=await s.from("expiration_items").select("id").eq("session_id",e.id).eq("ean",t.ean).single();if(a)throw new Error("Item already exists in session. Use update.");const n={session_id:e.id,ean:t.ean,product_name:t.productName,batches:t.batches,total_quantity:t.batches.reduce((d,l)=>d+l.quantity,0),timestamp:Date.now(),branch_name:i,synced:1},{data:o,error:r}=await s.from("expiration_items").insert(n).select().single();if(r)throw r;return await c(e.id),m(o)}async function E(t,i){const e={};i.batches&&(e.batches=i.batches,e.total_quantity=i.batches.reduce((o,r)=>o+r.quantity,0)),i.timestamp&&(e.timestamp=i.timestamp);const{data:a,error:n}=await s.from("expiration_items").update(e).eq("id",t).select("session_id").single();if(n)throw n;a&&await c(a.session_id)}async function v(t){const{data:i}=await s.from("expiration_items").select("session_id").eq("id",t).single(),{error:e}=await s.from("expiration_items").delete().eq("id",t);if(e)throw e;i&&await c(i.session_id)}async function w(t){const{data:i,error:e}=await s.from("expiration_items").select("*").eq("session_id",t);if(e)throw e;return i.map(m)}async function U(t){let i=s.from("expiration_items").select("*");t&&(i=i.eq("branch_name",t));const{data:e,error:a}=await i;if(a)throw a;return e.map(m)}async function c(t){const i=await w(t),e=i.length,a=i.reduce((n,o)=>n+o.totalQuantity,0);await u(t,{totalProducts:e,totalUnits:a})}function f(t){return{id:t.id,sector:t.sector,branchName:t.branch_name,startTime:Number(t.start_time),endTime:t.end_time?Number(t.end_time):void 0,status:t.status,totalProducts:t.total_products,totalUnits:t.total_units}}function m(t){return{id:t.id,sessionId:t.session_id,ean:t.ean,productName:t.product_name,batches:t.batches,totalQuantity:t.total_quantity,timestamp:Number(t.timestamp),synced:t.synced,branchName:t.branch_name}}export{_ as a,g as b,x as c,y as d,v as e,q as f,U as g,w as h,E as u};
