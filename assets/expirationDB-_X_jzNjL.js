import{s}from"./index-CRCrhKU4.js";async function y(t,e){const a={sector:t,branch_name:e,start_time:Date.now(),status:"active",total_products:0,total_units:0},{data:i,error:o}=await s.from("expiration_sessions").insert(a).select().single();if(o)throw o;return _(i)}async function q(t){let e=s.from("expiration_sessions").select("*").eq("status","active");t&&(e=e.eq("branch_name",t));const{data:a,error:i}=await e.order("start_time",{ascending:!1});if(i)throw i;return a.map(_)}async function N(t){const{error:e}=await s.from("expiration_sessions").delete().eq("id",t);if(e)throw e}async function l(t){const e=await q(t);return e.length>0?e[0]:null}async function w(t,e){const a={};e.sector&&(a.sector=e.sector),e.status&&(a.status=e.status),e.endTime&&(a.end_time=e.endTime),e.totalProducts!==void 0&&(a.total_products=e.totalProducts),e.totalUnits!==void 0&&(a.total_units=e.totalUnits);const{error:i}=await s.from("expiration_sessions").update(a).eq("id",t);if(i)throw i}async function D(t){await w(t,{status:"completed",endTime:Date.now()})}async function v(t,e){const a=await l(e);if(!a)throw new Error("No active expiration session");const{data:i}=await s.from("expiration_items").select("id").eq("session_id",a.id).eq("ean",t.ean).single();if(i)throw new Error("Item already exists in session. Use update.");const o={session_id:a.id,ean:t.ean,product_name:t.productName,batches:t.batches,total_quantity:t.batches.reduce((n,f)=>n+f.quantity,0),timestamp:Date.now(),branch_name:e,synced:1},{data:r,error:c}=await s.from("expiration_items").insert(o).select().single();if(c)throw c;return await m(a.id),d(r)}async function g(t,e){const a={};e.batches&&(a.batches=e.batches,a.total_quantity=e.batches.reduce((r,c)=>r+c.quantity,0)),e.timestamp&&(a.timestamp=e.timestamp);const{data:i,error:o}=await s.from("expiration_items").update(a).eq("id",t).select("session_id").single();if(o)throw o;i&&await m(i.session_id)}async function T(t){const{data:e}=await s.from("expiration_items").select("session_id").eq("id",t).single(),{error:a}=await s.from("expiration_items").delete().eq("id",t);if(a)throw a;e&&await m(e.session_id)}async function E(t){const{data:e,error:a}=await s.from("expiration_items").select("*").eq("session_id",t);if(a)throw a;return e.map(d)}async function B(t){let e=s.from("expiration_items").select("*");t&&(e=e.eq("branch_name",t));const{data:a,error:i}=await e;if(i)throw i;return a.map(d)}async function m(t){const e=await E(t),a=e.length,i=e.reduce((o,r)=>o+r.totalQuantity,0);await w(t,{totalProducts:a,totalUnits:i})}function _(t){return{id:t.id,sector:t.sector,branchName:t.branch_name,startTime:Number(t.start_time),endTime:t.end_time?Number(t.end_time):void 0,status:t.status,totalProducts:t.total_products,totalUnits:t.total_units}}function d(t){return{id:t.id,sessionId:t.session_id,ean:t.ean,productName:t.product_name,batches:t.batches,totalQuantity:t.total_quantity,timestamp:Number(t.timestamp),synced:t.synced,branchName:t.branch_name}}async function U(t,e,a,i){const o=t.batches.map(n=>n.batchNumber===e.batchNumber&&n.expirationDate===e.expirationDate?{...n,status:"transfer",actionDate:Date.now(),destinationBranch:a,plexShipmentNumber:i}:n);await g(t.id,{batches:o});let r=await l(a);r||(r=await y("RecepciÃ³n Transferencias",a));const{data:c}=await s.from("expiration_items").select("*").eq("session_id",r.id).eq("ean",t.ean).single();if(c){const n=c.batches;if(!n.some(u=>u.batchNumber===e.batchNumber&&u.expirationDate===e.expirationDate)){const u={...e,status:"active",actionDate:void 0,destinationBranch:void 0,plexShipmentNumber:void 0},p=[...n,u];await s.from("expiration_items").update({batches:p,total_quantity:p.reduce((h,x)=>h+x.quantity,0),timestamp:Date.now()}).eq("id",c.id),await m(r.id)}}else{const n={...e,status:"active",actionDate:void 0,destinationBranch:void 0,plexShipmentNumber:void 0};await v({ean:t.ean,productName:t.productName,batches:[n],totalQuantity:n.quantity},a)}}export{q as a,v as b,y as c,N as d,T as e,D as f,B as g,E as h,U as p,g as u};
