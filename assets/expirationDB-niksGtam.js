import{$ as w}from"./index-WTpjueDr.js";let u;async function o(){return u=w("farmaplus-expiration",2,{upgrade(t,e,n,s){if(e<1){t.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-status","status");const a=t.createObjectStore("items",{keyPath:"id"});a.createIndex("by-session","sessionId"),a.createIndex("by-ean","ean")}if(e<2){const i=s.objectStore("sessions");i.indexNames.contains("by-branch")||i.createIndex("by-branch","branchName")}}}),u}async function x(t,e){const n=await o(),s={id:crypto.randomUUID(),sector:t,branchName:e,startTime:Date.now(),status:"active",totalProducts:0,totalUnits:0};return await n.put("sessions",s),s}async function b(t){return(await(await o()).getAllFromIndex("sessions","by-status","active")).filter(s=>s.branchName===t).sort((s,i)=>i.startTime-s.startTime)}async function I(t){const n=(await o()).transaction(["sessions","items"],"readwrite");await n.objectStore("sessions").delete(t);const s=n.objectStore("items"),i=await s.index("by-session").getAllKeys(t);for(const a of i)await s.delete(a);await n.done}async function y(t){const e=await b(t);return e.length>0?e[0]:null}async function l(t,e){const n=await o(),s=await n.get("sessions",t);s&&await n.put("sessions",{...s,...e})}async function g(t){await l(t,{status:"completed",endTime:Date.now()})}async function S(t,e){const n=await o(),s=await y(e);if(!s)throw new Error("No active expiration session");if((await n.getAllFromIndex("items","by-session",s.id)).find(r=>r.ean===t.ean))throw new Error("Item already exists in session. Use update.");const c={id:crypto.randomUUID(),sessionId:s.id,ean:t.ean,productName:t.productName,batches:t.batches,totalQuantity:t.batches.reduce((r,m)=>r+m.quantity,0),timestamp:Date.now(),synced:0};return await n.put("items",c),await d(s.id),c}async function h(t,e){const n=await o(),s=await n.get("items",t);if(s){const i={...s,...e};e.batches&&(i.totalQuantity=e.batches.reduce((a,c)=>a+c.quantity,0)),await n.put("items",i),await d(s.sessionId)}}async function E(t){const e=await o(),n=await e.get("items",t);n&&(await e.delete("items",t),await d(n.sessionId))}async function p(t){return(await o()).getAllFromIndex("items","by-session",t)}async function v(){return(await o()).getAll("items")}async function d(t){const e=await p(t),n=await o(),s=e.length,i=e.reduce((c,r)=>c+r.totalQuantity,0),a=await n.get("sessions",t);a&&await n.put("sessions",{...a,totalProducts:s,totalUnits:i})}export{b as a,S as b,x as c,I as d,E as e,g as f,v as g,p as h,h as u};
