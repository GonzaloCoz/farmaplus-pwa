import{r as h}from"./react-vendor-ylmX0jv_.js";import{u as A,z as u,b as O}from"./index-CkS_J3ry.js";import{a as R,c as U,d as _,u as q,b as W,e as j,f as V,h as B}from"./expirationDB-Bu71LHy0.js";import{E as H}from"./jspdf.es.min-DNNqAFHw.js";import{u as T,w as Q}from"./excel-uoQkVabA.js";import{N as P,O as I,f as y}from"./utils-B3_ieZWp.js";import{e as k}from"./es-DzSx4Un2.js";import{j as z,ao as G,ap as M,aq as J,ar as K}from"./ui-vendor-DpWgbapL.js";function me(){const{user:a}=A(),[o,i]=h.useState(null),[e,l]=h.useState([]),[m,t]=h.useState([]),[d,r]=h.useState(0),[x,S]=h.useState(0),[N,E]=h.useState(!0);h.useEffect(()=>{a!=null&&a.branchName?w(a.branchName):(i(null),t([]))},[a==null?void 0:a.branchName]);const w=async c=>{try{E(!0);const n=await R(c);l(n)}catch(n){console.error("Error loading expiration session:",n),u.error("Error","No se pudo cargar la sesión")}finally{E(!1)}},g=async c=>{const n=await B(c);n.sort((p,f)=>f.timestamp-p.timestamp),t(n),r(n.length),S(n.reduce((p,f)=>p+f.totalQuantity,0))};return{session:o,items:m,totalProducts:d,totalUnits:x,isLoading:N,availableSessions:e,startSession:async c=>{try{if(!(a!=null&&a.branchName)){u.error("Error","No hay sucursal seleccionada");return}if(e.find(f=>f.sector===c)){u.error("Sesión duplicada","Ya existe una sesión para este sector");return}const p=await U(c,a.branchName);i(p),l(f=>[p,...f]),t([])}catch(n){console.error("Error starting session:",n),u.error("Error","No se pudo iniciar la sesión")}},resumeSession:async c=>{try{i(c),await g(c.id),u.success("Sesión retomada",`Continuando control de ${c.sector}`)}catch(n){console.error("Error resuming:",n),u.error("Error","No se pudo retomar la sesión")}},deleteSession:async c=>{if(confirm("¿Eliminar sesión?"))try{await _(c),l(n=>n.filter(p=>p.id!==c)),(o==null?void 0:o.id)===c&&(i(null),t([])),u.success("Sesión eliminada","La sesión se eliminó correctamente")}catch(n){console.error("Error deleting:",n),u.error("Error","No se pudo eliminar la sesión")}},addItem:async(c,n,p)=>{try{const f=m.find(b=>b.ean===c);if(f)await q(f.id,{batches:p,timestamp:Date.now()}),u.success("Producto actualizado","Los datos del producto se actualizaron correctamente");else{if(!(a!=null&&a.branchName))throw new Error("No branch selected");await W({ean:c,productName:n,batches:p,totalQuantity:p.reduce((b,$)=>b+$.quantity,0)},a.branchName),u.success("Producto agregado",`${n} agregado al control`)}o&&await g(o.id)}catch(f){console.error("Error adding/updating item:",f),u.error("Error","No se pudo guardar el producto")}},deleteItem:async c=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await j(c),u.success("Producto eliminado","El producto se eliminó del control"),o&&await g(o.id)}catch(n){console.error("Error deleting item:",n),u.error("Error","No se pudo eliminar el producto")}},finishSession:async()=>{if(o&&confirm("¿Finalizar control de vencimientos?"))try{await V(o.id),l(c=>c.filter(n=>n.id!==o.id)),i(null),t([]),u.success("Control finalizado","El control de vencimientos se finalizó correctamente")}catch(c){console.error("Error finishing session:",c),u.error("Error","No se pudo finalizar el control")}}}}const pe=(a,o,i)=>{const e=X(a,o);o.format==="pdf"?Z(e,o,i):Y(e,o,i)},X=(a,o)=>{const i=[],{from:e,to:l}=o.dateRange;return a.forEach(m=>{m.batches.forEach(t=>{const d=t.status||"active";if(!(o.selectedStatuses.includes("all")||o.selectedStatuses.includes(d)))return;let x=!1;if(t.actionDate){const S=P(t.actionDate/1e3);I(S,{start:e,end:l})&&(x=!0)}else d==="active"&&I(new Date,{start:e,end:l})&&(x=!0);x&&i.push({productName:m.productName,ean:m.ean,batchNumber:t.batchNumber,expirationDate:t.expirationDate,quantity:t.quantity,status:d,actionDate:t.actionDate,destinationBranch:t.destinationBranch,plexShipmentNumber:t.plexShipmentNumber,branchName:m.branchName})})}),i},Z=(a,o,i)=>{const e=new H({orientation:"portrait",unit:"mm",format:"a4"}),l=e.internal.pageSize.width,m=e.internal.pageSize.height,t=20,d=l-t*2;let r=t;e.setTextColor(40,40,40),e.setFontSize(20),e.setFont("helvetica","bold"),e.text("Reporte de Control de Vencimientos",t,r),r+=10,e.setDrawColor(200,200,200),e.setLineWidth(.5),e.line(t,r,t+d,r),r+=10,e.setFontSize(10),e.setFont("helvetica","normal"),e.setTextColor(100,100,100),e.text(`SUCURSAL: ${i.toUpperCase()}`,t,r),e.text(`FECHA DE EMISIÓN: ${y(new Date,"dd/MM/yyyy HH:mm",{locale:k})}`,t+d,r,{align:"right"}),r+=6;const x=y(o.dateRange.from,"dd/MM/yy"),S=y(o.dateRange.to,"dd/MM/yy");e.text(`PERIODO: ${x} - ${S} (${ee(o.rangeType).toUpperCase()})`,t,r);const N=o.selectedStatuses.includes("all")?"TODOS":o.selectedStatuses.map(s=>v(s).toUpperCase()).join(", ");e.text(`ESTADOS: ${N}`,t+d,r,{align:"right"}),r+=12,e.setDrawColor(240,240,240),e.setFillColor(250,250,250),e.rect(t,r,d,15,"F"),e.setTextColor(60,60,60),e.setFont("helvetica","bold");const E=a.length,w=a.reduce((s,C)=>s+C.quantity,0);e.text(`TOTAL PRODUCTOS: ${E}`,t+5,r+9),e.text(`TOTAL UNIDADES: ${w}`,t+d/2,r+9),r+=25;const g=s=>{e.setFont("helvetica","bold"),e.setFontSize(9),e.setTextColor(40,40,40),e.text("PRODUCTO",t,s),e.text("LOTE / VENC.",t+70,s),e.text("CANT.",t+105,s,{align:"center"}),e.text("ESTADO",t+115,s),e.text("DETALLES / ACCIÓN",t+d,s,{align:"right"}),e.setDrawColor(80,80,80),e.setLineWidth(.3),e.line(t,s+2,t+d,s+2)};g(r),r+=10,e.setFont("helvetica","normal"),e.setFontSize(8.5),e.setTextColor(60,60,60),a.forEach((s,C)=>{r>m-25&&(L(e,l,m,t),e.addPage(),r=t+10,g(r),r+=10,e.setFont("helvetica","normal"),e.setFontSize(8.5),e.setTextColor(60,60,60));const F=s.productName.length>40?s.productName.substring(0,38)+"...":s.productName;e.text(F,t,r),e.text(`${s.batchNumber} | ${s.expirationDate}`,t+70,r),e.text(`${s.quantity}`,t+105,r,{align:"center"}),e.text(v(s.status),t+115,r);let D="-";s.status==="transfer"?D=s.destinationBranch||"Transferencia":s.actionDate&&(D=y(P(s.actionDate/1e3),"dd/MM/yyyy")),e.text(D,t+d,r,{align:"right"}),e.setDrawColor(230,230,230),e.setLineWidth(.1),e.line(t,r+2,t+d,r+2),r+=8}),L(e,l,m,t),e.save(`Reporte_Vencimientos_${i}_${y(new Date,"yyyyMMdd")}.pdf`)},L=(a,o,i,e)=>{const l=a.internal.getNumberOfPages();a.setFontSize(8),a.setTextColor(150,150,150),a.setDrawColor(220,220,220),a.setLineWidth(.2),a.line(e,i-15,o-e,i-15),a.text("Farmaplus PWA - Sistema de Gestión de Inventarios",e,i-10),a.text(`Página ${l}`,o-e,i-10,{align:"right"})},Y=(a,o,i)=>{const e=a.map(t=>({Producto:t.productName,EAN:t.ean,Lote:t.batchNumber,Vencimiento:t.expirationDate,Cantidad:t.quantity,Estado:v(t.status),"Fecha Acción":t.actionDate?y(P(t.actionDate/1e3),"dd/MM/yyyy HH:mm"):"-","Sucursal Destino":t.destinationBranch||"-","Nº Envío Plex":t.plexShipmentNumber||"-","Sucursal Origen":t.branchName})),l=T.json_to_sheet(e),m=T.book_new();T.book_append_sheet(m,l,"Reporte"),Q(m,`Control_Vencimientos_${i}.xlsx`)},ee=a=>{switch(a){case"day":return"Día/Rango";case"month":return"Mes";case"year":return"Año";default:return"Personalizado"}},v=a=>{switch(a){case"active":return"Pendiente";case"sold":return"Vendido";case"transfer":return"Transferido";case"return":return"Devolución";case"destroyed":return"Destrucción";case"all":return"Todos";default:return a}},fe=J,he=K,te=h.forwardRef(({className:a,align:o="center",sideOffset:i=4,...e},l)=>z.jsx(G,{children:z.jsx(M,{ref:l,align:o,sideOffset:i,className:O("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e})}));te.displayName=M.displayName;export{fe as P,he as a,te as b,pe as c,Z as g,me as u};
