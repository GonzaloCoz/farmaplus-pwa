import{r as n}from"./react-vendor-ylmX0jv_.js";import{u as v,A as t,b as P}from"./index-4S8qSKY8.js";import{a as z,c as C,d as j,u as L,b as A,e as U,f as q,h as Q}from"./expirationDB-CDs0AeDx.js";import{j as g,ao as T,ap as S,aq as $,ar as B}from"./ui-vendor-CwIRxpyq.js";function V(){const{user:o}=v(),[s,c]=n.useState(null),[m,d]=n.useState([]),[f,l]=n.useState([]),[h,y]=n.useState(0),[x,w]=n.useState(0),[N,E]=n.useState(!0);n.useEffect(()=>{o!=null&&o.branchName?b(o.branchName):(c(null),l([]))},[o==null?void 0:o.branchName]);const b=async r=>{try{E(!0);const e=await z(r);d(e)}catch(e){console.error("Error loading expiration session:",e),t.error("Error","No se pudo cargar la sesión")}finally{E(!1)}},u=async r=>{const e=await Q(r);e.sort((a,i)=>i.timestamp-a.timestamp),l(e),y(e.length),w(e.reduce((a,i)=>a+i.totalQuantity,0))};return{session:s,items:f,totalProducts:h,totalUnits:x,isLoading:N,availableSessions:m,startSession:async r=>{try{if(!(o!=null&&o.branchName)){t.error("Error","No hay sucursal seleccionada");return}if(m.find(i=>i.sector===r)){t.error("Sesión duplicada","Ya existe una sesión para este sector");return}const a=await C(r,o.branchName);c(a),d(i=>[a,...i]),l([])}catch(e){console.error("Error starting session:",e),t.error("Error","No se pudo iniciar la sesión")}},resumeSession:async r=>{try{c(r),await u(r.id),t.success("Sesión retomada",`Continuando control de ${r.sector}`)}catch(e){console.error("Error resuming:",e),t.error("Error","No se pudo retomar la sesión")}},deleteSession:async r=>{if(confirm("¿Eliminar sesión?"))try{await j(r),d(e=>e.filter(a=>a.id!==r)),(s==null?void 0:s.id)===r&&(c(null),l([])),t.success("Sesión eliminada","La sesión se eliminó correctamente")}catch(e){console.error("Error deleting:",e),t.error("Error","No se pudo eliminar la sesión")}},addItem:async(r,e,a)=>{try{const i=f.find(p=>p.ean===r);if(i)await L(i.id,{batches:a,timestamp:Date.now()}),t.success("Producto actualizado","Los datos del producto se actualizaron correctamente");else{if(!(o!=null&&o.branchName))throw new Error("No branch selected");await A({ean:r,productName:e,batches:a,totalQuantity:a.reduce((p,I)=>p+I.quantity,0)},o.branchName),t.success("Producto agregado",`${e} agregado al control`)}s&&await u(s.id)}catch(i){console.error("Error adding/updating item:",i),t.error("Error","No se pudo guardar el producto")}},deleteItem:async r=>{if(confirm("¿Estás seguro de eliminar este producto?"))try{await U(r),t.success("Producto eliminado","El producto se eliminó del control"),s&&await u(s.id)}catch(e){console.error("Error deleting item:",e),t.error("Error","No se pudo eliminar el producto")}},finishSession:async()=>{if(s&&confirm("¿Finalizar control de vencimientos?"))try{await q(s.id),d(r=>r.filter(e=>e.id!==s.id)),c(null),l([]),t.success("Control finalizado","El control de vencimientos se finalizó correctamente")}catch(r){console.error("Error finishing session:",r),t.error("Error","No se pudo finalizar el control")}}}}const W=$,X=B,D=n.forwardRef(({className:o,align:s="center",sideOffset:c=4,...m},d)=>g.jsx(T,{children:g.jsx(S,{ref:d,align:s,sideOffset:c,className:P("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",o),...m})}));D.displayName=S.displayName;export{W as P,X as a,D as b,V as u};
