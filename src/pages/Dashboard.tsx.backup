import { useState, useMemo, useEffect } from "react";
import { motion } from "framer-motion";
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, sortableKeyboardCoordinates, rectSortingStrategy } from '@dnd-kit/sortable';
import { CounterAnimation } from "@/components/CounterAnimation";
import { AnimatedProgressBar } from "@/components/AnimatedProgressBar";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend
} from 'recharts';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Progress } from "@/components/ui/progress";
import { MetricCarousel } from "@/components/MetricCarousel";
import {
  Activity,
  CreditCard,
  DollarSign,
  Download,
  Users,
  Calendar as CalendarIcon,
  CalendarClock,
  Package,
  TrendingDown,
  TrendingUp,
  AlertTriangle,
  AlertCircle as AlertCircleIcon,
  MapPin,
  ChevronRight,
  Search,
  ArrowUpDown,
  Mail,
  Edit3,
  Plus,
  RotateCcw,
  type LucideIcon
} from "lucide-react";
import { Calendar } from "@/components/ui/calendar";
import CustomCalendar from "@/components/CustomCalendar";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Drawer, DrawerContent, DrawerHeader, DrawerTitle, DrawerTrigger } from "@/components/ui/drawer";
import { useMediaQuery } from "@/hooks/use-media-query";
import { getAllProducts, Product } from "@/services/preCountDB";
import { cyclicInventoryService } from "@/services/cyclicInventoryService";
import { useUser } from "@/contexts/UserContext";
import { useDashboardLayout } from "@/hooks/useDashboardLayout";
import { WidgetContainer } from "@/components/dashboard/WidgetContainer";
import { WidgetGallery } from "@/components/dashboard/WidgetGallery";
import { MetricsCarouselWidget } from "@/components/dashboard/widgets/MetricsCarouselWidget";
import { ActiveProductsWidget } from "@/components/dashboard/widgets/ActiveProductsWidget";
import { InventorySummaryWidget } from "@/components/dashboard/widgets/InventorySummaryWidget";
import { InventoryAlertsWidget } from "@/components/dashboard/widgets/InventoryAlertsWidget";
import { UpcomingInventoriesWidget } from "@/components/dashboard/widgets/UpcomingInventoriesWidget";
import { BranchesTableWidget } from "@/components/dashboard/widgets/BranchesTableWidget";

const upcomingInventories = [
  {
    branch: "Belgrano IV",
    sector: "Farmacia",
    date: "Mi√©rcoles, 19 de Noviembre",
    iso: "2025-11-19",
  },
  {
    branch: "Recoleta",
    sector: "Farmacia",
    date: "Viernes, 21 de Noviembre",
    iso: "2025-11-21",
  },
  {
    branch: "Villa Urquiza II",
    sector: "Perfumer√≠a",
    date: "Mi√©rcoles, 26 de Julio",
    iso: "2026-07-26",
  },
];

interface MetricCardProps {
  title: string;
  value: string;
  change?: string;
  changeType?: "positive" | "negative" | "neutral";
  icon?: LucideIcon;
}

function MetricCard({ title, value, change, changeType = "neutral", icon: Icon }: MetricCardProps) {
  const changeColors = {
    positive: "text-success",
    negative: "text-destructive",
    neutral: "text-muted-foreground",
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">{title}</CardTitle>
        {Icon && <Icon className="h-4 w-4 text-muted-foreground" />}
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{value}</div>
        {change && <p className={`text-xs ${changeColors[changeType]}`}>{change}</p>}
      </CardContent>
    </Card>
  );
}

type Branch = {
  name: string;
  address: string;
  zonal: string;
  email: string;
};

const branches = [
  { name: "Barracas", address: "Av Montes de Oca 895, CABA.", zonal: "Christian Mc Garva", email: "encargadoBarracas@farmaplus.com.ar" },
  { name: "Beccar", address: "Av Sucre 2143, Beccar", zonal: "Andres Zanovello", email: "encargadoBeccar@farmaplus.com.ar" },
  { name: "Belgrano", address: "Av Cabildo 1566, CABA", zonal: "Javier Paredes", email: "encargadoBelgrano@farmaplus.com.ar" },
  { name: "Belgrano II", address: "Juramento 2741, CABA", zonal: "Javier Paredes", email: "encargadoBelgranoII@farmaplus.com.ar" },
  { name: "Belgrano III", address: "Av. Cabildo 2540, CABA", zonal: "Christian Mc Garva", email: "encargadoBelgranoIII@farmaplus.com.ar" },
  { name: "Belgrano IV", address: "Av. Cabildo 2178, CABA", zonal: "Jorge Arredondo", email: "encargadoBelgranoIV@farmaplus.com.ar" },
  { name: "Belgrano V", address: "Echeverr√≠¬≠a 3187, CABA", zonal: "Javier Paredes", email: "encargadoBelgranoV@farmaplus.com.ar" },
  { name: "Belgrano VI", address: "Av. Libertador 6283, CABA", zonal: "Javier Paredes", email: "encargadoBelgranoVI@farmaplus.com.ar" },
  { name: "Belgrano VII", address: "Av.Cabildo 2171, CABA", zonal: "Diego Ruiz", email: "encargadoBelgranoVII@farmaplus.com.ar" },
  { name: "Belgrano VIII", address: "Av Congreso 2486, CABA", zonal: "Diego Ruiz", email: "encargadoBelgranoVIII@farmaplus.com.ar" },
  { name: "Berazategui", address: "Av. 14 Pres. Juan Domingo Per√≥n 4998, Berazategui", zonal: "Diego Ruiz", email: "encargadoBerazategui@farmaplus.com.ar" },
  { name: "Berazategui II", address: "Lisandro de la Torre 1596, Berazategui", zonal: "Christian Mc Garva", email: "encargadoBerazateguiII@farmaplus.com.ar" },
  { name: "Caballito", address: "Av Rivadavia 5014, CABA", zonal: "Romina Ag√ºero", email: "encargadoCaballito@farmaplus.com.ar" },
  { name: "Caballito II", address: "Av Jos√© Mar√≠¬≠a Moreno 99, CABA", zonal: "Christian Mc Garva", email: "encargadoCaballitoII@farmaplus.com.ar" },
  { name: "Caballito III", address: "Av Rivadavia 4718, CABA", zonal: "Jorge Arredondo", email: "encargadoCaballitoIII@farmaplus.com.ar" },
  { name: "Caballito IV", address: "Av. Rivadavia 4502", zonal: "Romina Ag√ºero", email: "encargadoCaballitoIV@farmaplus.com.ar" },
  { name: "Chacarita", address: "Federico Lacroze 3642", zonal: "Christian Mc Garva", email: "encargadoChacarita@farmaplus.com.ar" },
  { name: "Devoto", address: "Av Francisco Beir√≥ 5402, CABA", zonal: "Andres Zanovello", email: "encargadoDevoto@farmaplus.com.ar" },
  { name: "Devoto II", address: "Nueva York 4074, C1419HDR Cdad", zonal: "Andres Zanovello", email: "encargadoDevotoII@farmaplus.com.ar" },
  { name: "Flores", address: "Av Rivadavia 6854, CABA", zonal: "Romina Ag√ºero", email: "encargadoFlores@farmaplus.com.ar" },
  { name: "Gonzalez Catan", address: "LTO, Av. Jos√© Equiza 4171, B1759 Gonz√°lez Cat√°n", zonal: "Esteban J Mendoza", email: "encargadoGCatan@farmaplus.com.ar" },
  { name: "Gonzalez Catan II", address: "Dr, Dr. Enrique Sim√≥n P√©rez 4802, B1759LXL Gonz√°lez Cat√°n", zonal: "Esteban J Mendoza", email: "encargadoGCatanII@farmaplus.com.ar" },
  { name: "Gonzalez Catan III", address: "Icalma 7648, B1759 Gonz√°lez Cat√°n", zonal: "Esteban J Mendoza", email: "encargadoGCatanIII@farmaplus.com.ar" },
  { name: "Las Ca√±itas", address: "Maure 1691, CABA", zonal: "Christian Mc Garva", email: "encargadoLasCanitas@farmaplus.com.ar" },
  { name: "Mercedes", address: "C. 27 548, Mercedes, Provincia de Buenos Aires", zonal: "Esteban J Mendoza", email: "encargadoMercedes@farmaplus.com.ar" },
  { name: "Microcentro", address: "25 de Mayo 222, CABA", zonal: "Diego Ruiz", email: "encargadoMicrocentro@farmaplus.com.ar" },
  { name: "Microcentro II", address: "Av de Mayo 675, CABA", zonal: "Diego Ruiz", email: "encargadoMicrocentroII@farmaplus.com.ar" },
  { name: "Mor√≥n", address: "Rep√∫blica Oriental del Uruguay 265, B1708 Mor√≥n", zonal: "Esteban J Mendoza", email: "encargadoMoron@farmaplus.com.ar" },
  { name: "Nu√±ez", address: "Av Cabildo 3834, CABA", zonal: "Jorge Arredondo", email: "encargadoNunez@farmaplus.com.ar" },
  { name: "Padua", address: "Av. Pres. Juan Domingo Per√≥n 23870, B1718GKQ San Antonio de Padua", zonal: "Esteban J Mendoza", email: "encargadoPadua@farmaplus.com.ar" },
  { name: "Palermo", address: "San Mart√≠¬≠n de Tours 2976, CABA", zonal: "Jorge Arredondo", email: "encargadoPalermo@farmaplus.com.ar" },
  { name: "Palermo II", address: "Guemes 3302", zonal: "Javier Paredes", email: "encargadoPalermoII@farmaplus.com.ar" },
  { name: "Palermo III", address: "Av. Sta. Fe 3350", zonal: "Jorge Arredondo", email: "encargadoPalermoIII@farmaplus.com.ar" },
  { name: "Parque Centenario", address: "Hidalgo 805, CABA", zonal: "Javier Paredes", email: "encargadoParqueCentenario@farmaplus.com.ar" },
  { name: "Parque Patricios", address: "Av. Caseros 2827, CABA", zonal: "Javier Paredes", email: "encargadoParquePatricios@farmaplus.com.ar" },
  { name: "Pilar", address: "Schubert 1950 Pilar, Buenos Aires Argentina", zonal: "Andres Zanovello", email: "encargadoPilar@farmaplus.com.ar" },
  { name: "Pompeya", address: "Av S√°enz 1187, CABA", zonal: "Christian Mc Garva", email: "encargadoPompeya@farmaplus.com.ar" },
  { name: "Quilmes", address: "Alsina 127, Quilmes", zonal: "Diego Ruiz", email: "encargadoQuilmes@farmaplus.com.ar" },
  { name: "Ramos Mejia", address: "Dr. Gabriel Ardoino 640, B1704 Ramos Mej√≠a", zonal: "Esteban J Mendoza", email: "encargadoRamosMejia@farmaplus.com.ar" },
  { name: "Ramos Mejia II", address: "Av. Rivadavia 13236, B1704 Ramos Mej√≠a", zonal: "Esteban J Mendoza", email: "encargadoRamosMejiaII@farmaplus.com.ar" },
  { name: "Ramos Mejia III", address: "Av. de Mayo 1212, B1704 Ramos Mej√≠a", zonal: "Esteban J Mendoza", email: "encargadoRamosMejiaIII@farmaplus.com.ar" },
  { name: "Recoleta", address: "Jos√© Andr√©s Pacheco de Melo 2402, CABA", zonal: "Jorge Arredondo", email: "encargadoRecoleta@farmaplus.com.ar" },
  { name: "Recoleta II", address: "Av Gral. Las Heras 2273, CABA", zonal: "Jorge Arredondo", email: "encargadoRecoletaII@farmaplus.com.ar" },
  { name: "Recoleta III", address: "Av Pueyrred√≥n 1428 , CABA", zonal: "Jorge Arredondo", email: "encargadoRecoletaIII@farmaplus.com.ar" },
  { name: "Recoleta IV", address: "Av. Pueyrred√≥n 1673, CABA", zonal: "Jorge Arredondo", email: "encargadoRecoletaIV@farmaplus.com.ar" },
  { name: "Recoleta V", address: "Av C√≥rdoba 2501, CABA", zonal: "Romina Ag√ºero", email: "encargadoRecoletaV@farmaplus.com.ar" },
  { name: "Retiro", address: "Reconquista 1015, CABA", zonal: "Diego Ruiz", email: "encargadoRetiro@farmaplus.com.ar" },
  { name: "Retiro II", address: "Av C√≥rdoba 533 , CABA", zonal: "Diego Ruiz", email: "encargadoRetiroII@farmaplus.com.ar" },
  { name: "Saladillo", address: "Av. Rivadavia 3158", zonal: "Esteban J Mendoza", email: "encargadoSaladillo@farmaplus.com.ar" },
  { name: "San Isidro", address: "Av Diego Carman 621, Mart√≠¬≠nez", zonal: "Andres Zanovello", email: "encargadoSanIsidro@farmaplus.com.ar" },
  { name: "San Isidro II", address: "Av Centenario 700, San Isidro", zonal: "Andres Zanovello", email: "encargadoSanIsidroII@farmaplus.com.ar" },
  { name: "San Miguel", address: "Av. Dr. Ricardo Balb√≠n 1346, San Miguel.", zonal: "Andres Zanovello", email: "encargadoSanMiguel@farmaplus.com.ar" },
  { name: "Tribunales", address: "Uruguay 479, CABA", zonal: "Diego Ruiz", email: "encargadoTribunales@farmaplus.com.ar" },
  { name: "Villa Ballester", address: "Alvear 2640, Villa Ballester.", zonal: "Andres Zanovello", email: "encargadoVillaBallester@farmaplus.com.ar" },
  { name: "Villa Ballester II", address: "Almirante Brown 3099, Villa Ballester.", zonal: "Andres Zanovello", email: "encargadoVillaBallesterII@farmaplus.com.ar" },
  { name: "Villa Crespo", address: "Av Corrientes 5270, CABA.", zonal: "Romina Ag√ºero", email: "encargadoVillaCrespo@farmaplus.com.ar" },
  { name: "Villa del Parque", address: "Nazca 2301, CABA", zonal: "Christian Mc Garva", email: "encargadoVilladelParque@farmaplus.com.ar" },
  { name: "Villa del Parque II", address: "Cuenca 3190, CABA", zonal: "Andres Zanovello", email: "encargadoVilladelParqueII@farmaplus.com.ar" },
  { name: "Villa Luro", address: "Lope de Vega 1397", zonal: "Christian Mc Garva", email: "encargadoVillaLuro@farmaplus.com.ar" },
  { name: "Villa Urquiza", address: "Av. Triunvirato 4602, CABA", zonal: "Romina Ag√ºero", email: "encargadoVillaUrquiza@farmaplus.com.ar" },
  { name: "Villa Urquiza II", address: "Av. Triunvirato 3749, CABA", zonal: "Romina Ag√ºero", email: "encargadoVillaUrquizaII@farmaplus.com.ar" },
  { name: "Villa Urquiza III", address: "Av. Triunvirato 4499, CABA", zonal: "Romina Ag√ºero", email: "encargadoVillaUrquizaIII@farmaplus.com.ar" },
];

const INITIAL_BRANCHES_TO_SHOW = 5;



const containerVariants = {
  hidden: { opacity: 0 },
  show: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1
    }
  }
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  show: { opacity: 1, y: 0 }
};

function CalendarContent({
  events,
  selectedDate,
  setSelectedDate,
  showAddForm,
  setShowAddForm,
  newTitle,
  setNewTitle,
  newBranch,
  setNewBranch,
  newSector,
  setNewSector,
  newDate,
  setNewDate,
  handleAddEvent,
  setEvents,
  eventsForDay,
  eventsForMonth,
  isMobile = false
}: any) {
  return (
    <div className={`flex ${isMobile ? 'flex-col' : 'gap-2'} mt-4`}>
      <div className={isMobile ? 'w-full mb-4' : 'w-2/5'}>
        <CustomCalendar
          events={events}
          selected={selectedDate}
          onSelect={(d) => {
            if (d) setSelectedDate(d as Date);
          }}
        />
      </div>
      <div className={isMobile ? 'w-full' : 'w-3/5'}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-lg font-medium">Eventos</h3>
          <div className="flex items-center gap-2">
            <Button size="sm" onClick={() => setShowAddForm((s: boolean) => !s)}>Agregar Evento</Button>
          </div>
        </div>

        {selectedDate ? (
          <div className="mb-4 text-sm text-muted-foreground">Mostrando: {selectedDate.toLocaleDateString('es-ES')}</div>
        ) : (
          <div className="mb-4 text-sm text-muted-foreground">Selecciona un d√≠a o ver todo el mes</div>
        )}

        <div className="space-y-3 max-h-[420px] overflow-auto">
          {(selectedDate ? eventsForDay(selectedDate) : eventsForMonth(selectedDate || new Date())).map((ev: any) => (
            <div key={ev.id} className="p-3 bg-muted/50 rounded-md">
              <div className="flex items-center justify-between">
                <div>
                  <div className="font-medium">{ev.title}</div>
                  <div className="text-xs text-muted-foreground">{ev.branch} ¬∑ {ev.sector}</div>
                  <div className="text-xs text-muted-foreground mt-1">{new Date(ev.date).toLocaleDateString('es-ES')}</div>
                </div>
                <div className="flex gap-2">
                  <Button size="sm" variant="outline" onClick={() => setEvents((prev: any[]) => prev.filter(p => p.id !== ev.id))}>Eliminar</Button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {showAddForm && (
          <div className="mt-4 p-3 bg-background border rounded-md">
            <div className="space-y-2">
              <input className="w-full p-2 border rounded" placeholder="T√≠tulo" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} />
              <input className="w-full p-2 border rounded" placeholder="Sucursal" value={newBranch} onChange={(e) => setNewBranch(e.target.value)} />
              <input className="w-full p-2 border rounded" placeholder="Sector" value={newSector} onChange={(e) => setNewSector(e.target.value)} />
              <input type="date" className="w-full p-2 border rounded" value={newDate} onChange={(e) => setNewDate(e.target.value)} />
              <div className="flex justify-end">
                <Button size="sm" onClick={handleAddEvent}>Guardar</Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

export default function Dashboard() {
  const [searchTerm, setSearchTerm] = useState("");
  const [showAllBranches, setShowAllBranches] = useState(false);
  const [sortConfig, setSortConfig] = useState<{ key: keyof Branch; direction: 'ascending' | 'descending' }>({ key: 'name', direction: 'ascending' });
  const isDesktop = useMediaQuery("(min-width: 768px)");

  const filteredBranches = branches.filter(
    (branch) =>
      branch.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      branch.address.toLowerCase().includes(searchTerm.toLowerCase()) ||
      branch.zonal.toLowerCase().includes(searchTerm.toLowerCase()) ||
      (branch.email && branch.email.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  const sortedBranches = useMemo(() => {
    let sortableItems = [...filteredBranches];
    if (sortConfig.key) {
      sortableItems.sort((a, b) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'ascending' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'ascending' ? 1 : -1;
        }
        return 0;
      });
    }
    return sortableItems;
  }, [filteredBranches, sortConfig]);

  const requestSort = (key: keyof Branch) => {
    let direction: 'ascending' | 'descending' = 'ascending';
    if (sortConfig.key === key && sortConfig.direction === 'ascending') {
      direction = 'descending';
    }
    setSortConfig({ key, direction });
  };

  const getSortIndicator = (key: keyof Branch) => {
    if (sortConfig.key !== key) return <ArrowUpDown className="ml-2 h-4 w-4 opacity-0 group-hover:opacity-50" />;
    return sortConfig.direction === 'ascending' ? <ArrowUpDown className="ml-2 h-4 w-4" /> : <ArrowUpDown className="ml-2 h-4 w-4" />;
  };

  const branchesToShow = showAllBranches
    ? sortedBranches
    : sortedBranches.slice(0, INITIAL_BRANCHES_TO_SHOW);

  // Eventos / Inventarios (persistidos en localStorage)
  type EventItem = { id: string; title: string; branch: string; sector: string; date: string }; // date ISO
  const [events, setEvents] = useState<EventItem[]>(() => {
    try {
      const raw = localStorage.getItem("inventory-events");
      if (raw) return JSON.parse(raw);
    } catch (e) {
      // ignore
    }
    // Inicializar desde upcomingInventories
    return upcomingInventories.map((u, i) => ({
      id: `evt-${i}`,
      title: `${u.branch} - ${u.sector}`,
      branch: u.branch,
      sector: u.sector,
      date: u.iso,
    }));
  });

  const [showCalendar, setShowCalendar] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(undefined);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newTitle, setNewTitle] = useState("");
  const [newBranch, setNewBranch] = useState("");
  const [newSector, setNewSector] = useState("");
  const [newDate, setNewDate] = useState<string>(new Date().toISOString().slice(0, 10));

  const { user } = useUser();

  // Widget system
  const {
    visibleWidgets,
    hiddenWidgets,
    isEditMode,
    setIsEditMode,
    reorderWidgets,
    toggleWidgetVisibility,
    resetLayout
  } = useDashboardLayout(user?.branchName);

  const [showWidgetGallery, setShowWidgetGallery] = useState(false);

  // Drag and drop sensors
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      reorderWidgets(active.id as string, over.id as string);
    }
  };

  const [metrics, setMetrics] = useState({
    totalStock: 0,
    activeProducts: 0,
    negativeStock: 0,
    positiveStock: 0
  });

  useEffect(() => {
    const loadMetrics = async () => {
      try {
        // Obtener todos los inventarios c√≠clicos activos
        const allInventories = cyclicInventoryService.getAllCyclicInventories();

        // Calcular m√©tricas globales
        const totalNegative = allInventories.reduce((acc, inv) => acc + inv.negativeValue, 0);
        const totalPositive = allInventories.reduce((acc, inv) => acc + inv.positiveValue, 0);
        const totalNet = allInventories.reduce((acc, inv) => acc + inv.differenceValue, 0);

        // Active products = Total items controlled or pending in the active inventories
        const activeProducts = allInventories.reduce((acc, inv) => acc + inv.totalItems, 0);

        setMetrics({
          totalStock: totalNet, // Usamos esto para "Unidades Totales" (Neto)
          activeProducts: activeProducts,
          negativeStock: totalNegative,
          positiveStock: totalPositive
        });

      } catch (error) {
        console.error("Error cargando m√©tricas:", error);
      }
    };

    loadMetrics();
  }, [user]);

  // Funci√≥n para obtener el saludo seg√∫n la hora
  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour >= 6 && hour < 12) return "Buenos d√≠as";
    if (hour >= 12 && hour < 20) return "Buenas tardes";
    return "Buenas noches";
  };

  useEffect(() => {
    localStorage.setItem("inventory-events", JSON.stringify(events));
  }, [events]);

  const eventsForMonth = (date: Date) => {
    const month = date.getMonth();
    const year = date.getFullYear();
    return events.filter(e => {
      const d = new Date(e.date);
      return d.getMonth() === month && d.getFullYear() === year;
    });
  };

  const eventsForDay = (date: Date) => {
    const iso = date.toISOString().slice(0, 10);
    return events.filter(e => e.date === iso);
  };

  const openCalendarForIso = (iso?: string) => {
    const d = iso ? new Date(iso) : new Date();
    setSelectedDate(d);
    setShowCalendar(true);
  };

  const handleAddEvent = () => {
    const id = `evt-${Date.now()}`;
    const item: EventItem = { id, title: newTitle || `${newBranch} - ${newSector}`, branch: newBranch, sector: newSector, date: newDate };
    setEvents(prev => [...prev, item]);
    setShowAddForm(false);
    setNewTitle("");
    setNewBranch("");
    setNewSector("");
    setNewDate(newDate);
  };

  // Render widget content based on type
  const renderWidgetContent = (widgetType: string) => {
    switch (widgetType) {
      case 'metrics-carousel':
        return <MetricsCarouselWidget metrics={metrics} />;
      case 'active-products':
        return <ActiveProductsWidget activeProducts={metrics.activeProducts} />;
      case 'inventory-summary':
        return <InventorySummaryWidget />;
      case 'inventory-alerts':
        return <InventoryAlertsWidget />;
      case 'upcoming-inventories':
        return <UpcomingInventoriesWidget inventories={upcomingInventories} onDateClick={openCalendarForIso} />;
      case 'branches-table':
        return <BranchesTableWidget branches={branches} />;
      default:
        return null;
    }
  };

  return (
    <motion.div
      className="p-6 space-y-6"
      variants={containerVariants}
      initial="hidden"
      animate="show"
    >
      <motion.div variants={itemVariants}>
        <div className="flex items-center justify-between mb-2">
          <h1 className="text-3xl font-bold text-foreground">
            {getGreeting()}, {user?.branchName || 'Sucursal'} üëã
          </h1>
          <div className="flex gap-2">
            {isEditMode && (
              <>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowWidgetGallery(true)}
                  disabled={hiddenWidgets.length === 0}
                >
                  <Plus className="h-4 w-4 mr-2" />
                  Agregar Widget
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={resetLayout}
                >
                  <RotateCcw className="h-4 w-4 mr-2" />
                  Resetear
                </Button>
              </>
            )}
            <Button
              variant={isEditMode ? "default" : "outline"}
              size="sm"
              onClick={() => setIsEditMode(!isEditMode)}
            >
              <Edit3 className="h-4 w-4 mr-2" />
              {isEditMode ? 'Guardar' : 'Editar Dashboard'}
            </Button>
          </div>
        </div>
        <p className="text-muted-foreground">
          Ac√° est√° el resumen de tus inventarios de hoy
        </p>
      </motion.div>

      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragEnd={handleDragEnd}
      >
        <SortableContext
          items={visibleWidgets.map(w => w.id)}
          strategy={rectSortingStrategy}
        >
          {/* Primera fila: Widgets peque√±os (m√°ximo 5) */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
            {visibleWidgets
              .filter(w => w.size === 'small')
              .slice(0, 5)
              .map((widget) => (
                <WidgetContainer
                  key={widget.id}
                  widget={widget}
                  isEditMode={isEditMode}
                  onRemove={() => toggleWidgetVisibility(widget.id)}
                >
                  {renderWidgetContent(widget.type)}
                </WidgetContainer>
              ))}
          </div>

          {/* Segunda fila: Widgets grandes (Resumen, Alertas, Pr√≥ximos) */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {visibleWidgets
              .filter(w => w.size === 'large')
              .map((widget) => (
                <WidgetContainer
                  key={widget.id}
                  widget={widget}
                  isEditMode={isEditMode}
                  onRemove={() => toggleWidgetVisibility(widget.id)}
                >
                  {renderWidgetContent(widget.type)}
                </WidgetContainer>
              ))}
          </div>

          {/* Widgets full-width (Tabla de Sucursales) */}
          <div className="space-y-6">
            {visibleWidgets
              .filter(w => w.size === 'full')
              .map((widget) => (
                <WidgetContainer
                  key={widget.id}
                  widget={widget}
                  isEditMode={isEditMode}
                  onRemove={() => toggleWidgetVisibility(widget.id)}
                >
                  {renderWidgetContent(widget.type)}
                </WidgetContainer>
              ))}
          </div>
        </SortableContext>
      </DndContext>

      <WidgetGallery
        open={showWidgetGallery}
        onOpenChange={setShowWidgetGallery}
        hiddenWidgets={hiddenWidgets}
        onAddWidget={toggleWidgetVisibility}
      />
    </Button>
                  </TableHead >
                  <TableHead className="flex-1">
                    <Button variant="ghost" onClick={() => requestSort('address')} className="group -ml-4">
                      Direcci√≥n {getSortIndicator('address')}
                    </Button>
                  </TableHead>
                  <TableHead className="text-right">Contacto</TableHead>
                </TableRow >
              </TableHeader >
    <TableBody>
      {branchesToShow.map((branch) => (
        <TableRow key={branch.name}>
          <TableCell className="font-medium">{branch.name}</TableCell>
          <TableCell>{branch.zonal}</TableCell>
          <TableCell>{branch.address}</TableCell>
          <TableCell className="text-right">
            <Button asChild variant="ghost" size="icon">
              <a href={`mailto:${branch.email}`}>
                <Mail className="h-4 w-4" />
              </a>
            </Button>
          </TableCell>
        </TableRow>
      ))}
    </TableBody>
            </Table >
  {
    sortedBranches.length > INITIAL_BRANCHES_TO_SHOW && !showAllBranches && (
      <div className="pt-4 text-center">
        <Button
          variant="ghost"
          className="w-full"
          onClick={() => setShowAllBranches(true)}
        >
          Mostrar m√°s ({sortedBranches.length - INITIAL_BRANCHES_TO_SHOW} restantes)
        </Button>
      </div>
    )
  }
          </CardContent >
        </Card >
      </motion.div >
    {/* Modal calendario + eventos */ }
  {/* Modal calendario + eventos (Responsive) */ }
  {
    isDesktop ? (
      <Dialog open={showCalendar} onOpenChange={setShowCalendar}>
        <DialogContent className="w-[1800px] max-w-[90vw]">
          <DialogHeader>
            <DialogTitle>Pr√≥ximos inventarios</DialogTitle>
          </DialogHeader>
          <CalendarContent
            events={events}
            selectedDate={selectedDate}
            setSelectedDate={setSelectedDate}
            showAddForm={showAddForm}
            setShowAddForm={setShowAddForm}
            newTitle={newTitle}
            setNewTitle={setNewTitle}
            newBranch={newBranch}
            setNewBranch={setNewBranch}
            newSector={newSector}
            setNewSector={setNewSector}
            newDate={newDate}
            setNewDate={setNewDate}
            handleAddEvent={handleAddEvent}
            setEvents={setEvents}
            eventsForDay={eventsForDay}
            eventsForMonth={eventsForMonth}
          />
        </DialogContent>
      </Dialog>
    ) : (
      <Drawer open={showCalendar} onOpenChange={setShowCalendar}>
        <DrawerContent>
          <DrawerHeader className="text-left">
            <DrawerTitle>Pr√≥ximos inventarios</DrawerTitle>
          </DrawerHeader>
          <div className="px-4 pb-4">
            <CalendarContent
              events={events}
              selectedDate={selectedDate}
              setSelectedDate={setSelectedDate}
              showAddForm={showAddForm}
              setShowAddForm={setShowAddForm}
              newTitle={newTitle}
              setNewTitle={setNewTitle}
              newBranch={newBranch}
              setNewBranch={setNewBranch}
              newSector={newSector}
              setNewSector={setNewSector}
              newDate={newDate}
              setNewDate={setNewDate}
              handleAddEvent={handleAddEvent}
              setEvents={setEvents}
              eventsForDay={eventsForDay}
              eventsForMonth={eventsForMonth}
              isMobile
            />
          </div>
        </DrawerContent>
      </Drawer>
    )
  }

    </motion.div >
  );
}
